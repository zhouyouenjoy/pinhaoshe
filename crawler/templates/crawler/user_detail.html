{% extends 'crawler/base.html' %}

{% block title %}用户详情 - {{ crawler_user.username }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>{{ crawler_user.username }} 的详情</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>用户信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            {% if crawler_user.avatar_url %}
                                <img src="{{ crawler_user.avatar_url }}" alt="用户头像" class="img-fluid rounded-circle" style="aspect-ratio: 1/1; object-fit: cover;">
                            {% else %}
                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center img-fluid" style="aspect-ratio: 1/1;" role="img" aria-label="{{ crawler_user.username }} 的默认头像">
                                    <span class="text-white">{{ crawler_user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-10">
                            <p><strong>用户名:</strong> {{ crawler_user.username }}</p>
                            <p><strong>注册时间:</strong> {{ crawler_user.date_joined|date:"Y-m-d H:i" }}</p>
                            <p><strong>最后登录:</strong> {{ crawler_user.last_login|date:"Y-m-d H:i"|default:"从未登录" }}</p>
                            
                            <!-- 添加设置头像按钮 -->
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setAvatarModal">
                                设置头像
                            </button>
                            
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal">
                                删除用户
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>相册列表</h3>
            </div>
            
            {% if albums %}
                <div class="row">
                    {% for album in albums %}
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">{{ album.title }}</h5>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAlbumModal" 
                                        data-album-id="{{ album.id }}" data-album-title="{{ album.title }}">
                                        删除
                                    </button>
                                </div>
                                <div class="card-body">
                                    <p><strong>创建时间:</strong> {{ album.uploaded_at|date:"Y-m-d H:i" }}</p>
                                    <p><strong>描述:</strong> {{ album.description|truncatewords:20|default:"无描述" }}</p>
                                    <p><strong>照片数量:</strong> {{ album.photos.count }}</p>
                                    <a href="{% url 'crawler:album_detail' album.id %}" class="btn btn-primary">查看相册</a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    该用户暂无相册。
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 设置头像模态框 -->
<div class="modal fade" id="setAvatarModal" tabindex="-1" aria-labelledby="setAvatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setAvatarModalLabel">选择头像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>相册列表</h6>
                            <div class="list-group" id="albumList">
                                {% for album in albums %}
                                    <a href="#" class="list-group-item list-group-item-action album-item" 
                                       data-album-id="{{ album.id }}">{{ album.title }}</a>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-9">
                            <h6>照片选择</h6>
                            <div id="photoSelection">
                                <p class="text-muted">请先选择一个相册</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAvatarBtn" disabled>保存头像</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除用户确认模态框 -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">确认删除用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除用户 <strong>{{ crawler_user.username }}</strong> 吗？</p>
                <p class="text-danger">注意：此操作将同时删除该用户的所有相册和照片，且无法恢复！</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form method="post" action="{% url 'crawler:delete_user' crawler_user.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 删除相册确认模态框 -->
<div class="modal fade" id="deleteAlbumModal" tabindex="-1" aria-labelledby="deleteAlbumModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAlbumModalLabel">确认删除相册</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除相册 <strong id="albumTitle"></strong> 吗？</p>
                <p class="text-danger">注意：此操作将同时删除该相册的所有照片，且无法恢复！</p>
                <input type="hidden" id="albumId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteAlbumForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 删除相册模态框事件处理
    var deleteAlbumModal = document.getElementById('deleteAlbumModal');
    deleteAlbumModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var albumId = button.getAttribute('data-album-id');
        var albumTitle = button.getAttribute('data-album-title');
        
        var modal = this;
        modal.querySelector('#albumTitle').textContent = albumTitle;
        modal.querySelector('#albumId').value = albumId;
        
        // 设置表单提交地址
        var form = modal.querySelector('#deleteAlbumForm');
        form.action = "{% url 'crawler:delete_album' 0 %}".replace('0', albumId);
    });
    
    // 设置头像模态框事件处理
    document.addEventListener('DOMContentLoaded', function() {
        // 相册点击事件
        document.querySelectorAll('.album-item').forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                // 移除所有相册项的活动状态
                document.querySelectorAll('.album-item').forEach(el => el.classList.remove('active'));
                // 为当前点击的相册项添加活动状态
                this.classList.add('active');
                
                // 获取相册ID
                const albumId = this.getAttribute('data-album-id');
                
                // 加载该相册的照片
                loadAlbumPhotos(albumId);
            });
        });
        
        // 保存头像按钮事件
        document.getElementById('saveAvatarBtn').addEventListener('click', function() {
            const selectedPhoto = document.querySelector('.photo-item.selected');
            if (selectedPhoto) {
                const photoId = selectedPhoto.getAttribute('data-photo-id');
                setAvatar(photoId);
            }
        });
    });
    
    // 加载相册照片
    function loadAlbumPhotos(albumId) {
        fetch(`/crawler/album/${albumId}/photos/`)
            .then(response => response.json())
            .then(data => {
                const photoSelection = document.getElementById('photoSelection');
                if (data.photos && data.photos.length > 0) {
                    let html = '<div class="row">';
                    data.photos.forEach(photo => {
                        html += `
                            <div class="col-md-3 mb-3">
                                <div class="photo-item border rounded p-2 text-center" data-photo-id="${photo.id}">
                                    <img src="${photo.thumbnail_url}" alt="照片" class="img-fluid" style="aspect-ratio: 1/1; object-fit: cover;">
                                    <div class="mt-2 small text-truncate">${photo.title || '未命名照片'}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    photoSelection.innerHTML = html;
                    
                    // 为照片项添加点击事件
                    document.querySelectorAll('.photo-item').forEach(item => {
                        item.addEventListener('click', function() {
                            // 移除所有照片项的选中状态
                            document.querySelectorAll('.photo-item').forEach(el => el.classList.remove('selected'));
                            // 为当前点击的照片项添加选中状态
                            this.classList.add('selected');
                            // 启用保存按钮
                            document.getElementById('saveAvatarBtn').disabled = false;
                        });
                    });
                } else {
                    photoSelection.innerHTML = '<p class="text-muted">该相册暂无照片</p>';
                }
            })
            .catch(error => {
                console.error('加载照片失败:', error);
                document.getElementById('photoSelection').innerHTML = '<p class="text-danger">加载照片失败</p>';
            });
    }
    
    // 设置头像
    function setAvatar(photoId) {
        const userId = "{{ crawler_user.id }}";
        fetch(`/crawler/set-avatar/${userId}/${photoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('setAvatarModal'));
                modal.hide();
                
                // 显示成功消息
                alert('头像设置成功');
                
                // 刷新页面以显示新头像
                location.reload();
            } else {
                alert('设置头像失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('设置头像失败:', error);
            alert('设置头像失败');
        });
    }
</script>
{% endblock %}