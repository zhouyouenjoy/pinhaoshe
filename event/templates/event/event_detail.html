{% extends 'minimal_base.html' %}
{% load static %}
{% block title %}{{ event.title }}{% endblock %}
{% block container_class %}container-fluid p-0 m-0{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/event/event_detail.css' %}">

<div class="event-detail-container d-flex align-items-start py-0 px-0">
    <div class="container-fluid no-gutters p-0">
        <div class="row justify-content-center no-gutters m-0">
            <div class="col-lg-8 no-gutters p-0">
                <div class="event-card m-0 rounded-0">
                    <div class="event-card-header d-flex justify-content-between align-items-center">
                        <h1 class="mb-0 text-white">{{ event.title }}</h1>
                        {% if event.created_by == user %}
                        <span class="my-event-badge">我的活动</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-2">
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <i class="fas fa-user me-2 text-primary"></i>
                                <span class="info-label">发起人:</span>
                                <a href="{% url 'photos:my_info_with_id' event.created_by.id %}" class="text-decoration-none">
                                    {% if event.created_by.userprofile.avatar %}
                                        <img src="{{ event.created_by.userprofile.avatar.url }}" alt="{{ event.created_by.username }}" class="avatar-circle">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ event.created_by.username|slice:":1"|upper }}
                                        </div>
                                    {% endif %}
                                    <span class="text-primary compact-text">{{ event.created_by.username }}</span>
                                </a>
                            </div>
                            <div class="col-md-4 info-item d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span class="info-label me-2 mb-0">活动时间:</span>
                                <span class="compact-text mb-0">{{ event.event_time|date:"Y-m-d H:i" }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <!-- 使用flex容器包裹所有元素实现横向排列 -->
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                        <span class="info-label">活动场地:</span>
                                        {% if event.location_user %}
                                            <a href="{% url 'photos:my_info_with_id' event.location_user.id %}" class="text-decoration-none ms-1">
                                                {% with user=event.location_user %}
                                                    {% if user.userprofile.avatar %}
                                                        <img src="{{ user.userprofile.avatar.url }}" alt="{{ user.username }}" class="avatar-circle">
                                                    {% else %}
                                                        <div class="avatar-placeholder">
                                                            {{ user.username|slice:":1"|upper }}
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                                <span class="text-primary compact-text">{{ event.location }}</span>
                                            </a>
                                        {% else %}
                                            <span class="ms-1 compact-text">{{ event.location }}</span>
                                        {% endif %}
                                    </div>

                                    {% if event.location_poi %}
                                    <button class="btn-custom ms-auto" id="toggleMapBtn" type="button">
                                        <i class="fas fa-map-marked-alt me-1"></i>查看地图
                                    </button>
                                    {% endif %}
                                </div>
    
                            </div>
                            
                        </div>
                        
                        {% if event.location_poi %}
                        <div id="mapSection" class="d-none">
                            <div class="poi-info mb-1 pb-1 border-bottom">
                                <div class="map-container mb-2">
                                    <div id="event-map"></div>
                                </div>
                                <h5 class="mb-1"><i class="fas fa-map-marker-alt me-2 text-primary"></i>详细位置信息</h5>
                                <div id="poi-info" class="compact-text"></div>
                                <!-- 存储POI数据供JavaScript使用 -->
                                <script type="application/json" id="poi-data">{{ event.location_poi|escapejs }}</script>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-1 pb-1 border-bottom">
                            <h5 class="mb-1"><i class="fas fa-align-left me-2 text-primary"></i>活动介绍</h5>
                            <div class="p-2 bg-light rounded compact-text">
                                {{ event.description|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 模特信息 -->
                {% if event.models.all %}
                <div class="section-card m-0 rounded-0">
                    <div class="section-card-header">
                    </div>
                    <div class="card-body p-2">
                        <!-- 模特缩略图网格 -->
                        <div class="models-grid">
                            {% for model in event.models.all %}
                            <div class="model-thumbnail {% if forloop.first %}active{% endif %}" 
                                 data-model-id="{{ model.id }}">
                                {% if model.model_user and model.model_user.userprofile.avatar %}
                                    <img src="{{ model.model_user.userprofile.avatar.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                {% else %}
                                    {% if model.model_images %}
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                    {% else %}
                                        {% with model_photos=model.model_user.photo_set.all|slice:":1" %}
                                            {% if model_photos %}
                                                {% for photo in model_photos %}
                                                    {% if photo.image %}
                                                        <img src="{{ photo.image.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <div class="model-thumbnail-img d-flex align-items-center justify-content-center bg-light">
                                                    <i class="fas fa-user fa-2x text-muted"></i>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% endif %}
                                <div class="model-thumbnail-name">{{ model.name }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- 模特详细信息展示区 -->
                        {% for model in event.models.all %}
                        <div class="model-detail-card {% if not forloop.first %}d-none{% endif %}" 
                             id="model-detail-{{ model.id }}">
                            <div class="model-detail-content">
                                <div class="model-images-grid position-relative">
                                
                                    {% with model_photos=model.model_user.photo_set.all|slice:":1" %}
                                        {% if model_photos %}
                                            {% for photo in model_photos %}
                                                {% if not model.model_images and photo.image %}
                                                    <div class="model-image-card" data-model-image-container>
                                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                                            <div class="model-detail-fee mb-0">¥{{ model.fee }}/场</div>
                                                            {% if model.model_user %}
                                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                                            </a>
                                                            {% endif %}
                                                        </div>
                                                        <img src="{{ photo.image.url }}" alt="{{ model.name }} 照片" class="model-image">
                                                        <!-- 叠加的小图片 -->
                                                        <div class="overlay-images">
                                                            {% if model.outfit_images %}
                                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable>
                                                            {% endif %}
                                                            {% if model.scene_images %}
                                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable>
                                                            {% endif %}
                                                        </div>
                                                        <div class="model-image-caption">模特照片</div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endwith %}
                                    
                                    {% if model.model_images %}
                                    <div class="model-image-card" data-model-image-container>
                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                            <div class="model-detail-fee mb-0">¥{{ model.fee }}/场</div>
                                            {% if model.model_user %}
                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                            </a>
                                            {% endif %}
                                        </div>
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }} 照片" class="model-image">
                                        <!-- 叠加的小图片 -->
                                        <div class="overlay-images">
                                            {% if model.outfit_images %}
                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable>
                                            {% endif %}
                                            {% if model.scene_images %}
                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable>
                                            {% endif %}
                                        </div>
                                        <div class="model-image-caption">模特照片</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 场次信息 -->
                                {% if model.sessions.all %}
                                <div class="sessions-container">
                                    <div class="row">
                                        {% for session in model.sessions.all %}
                                        <div class="col-md-6">
                                            <div class="session-item-detail">
                                                <strong>{{ session.title }}</strong><br>
                                                {{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 图片放大查看器 -->
                <div id="image-enlarger" class="image-enlarger d-none">
                    <div class="image-enlarger-content">
                        <span class="image-enlarger-close">&times;</span>
                        <img class="image-enlarger-img" id="enlarged-image">
                        <div class="image-enlarger-caption" id="enlarged-image-caption"></div>
                    </div>
                </div>
                
                <script>
                // 模特信息切换功能
                document.addEventListener('DOMContentLoaded', function() {
                    const thumbnails = document.querySelectorAll('.model-thumbnail');
                    const detailCards = document.querySelectorAll('.model-detail-card');
                    
                    // 定义动画类型数组
                    const animations = ['slide-in', 'bounce-in', 'flip-in', 'fade-in'];
                    
                    thumbnails.forEach(thumbnail => {
                        thumbnail.addEventListener('click', function() {
                            const modelId = this.getAttribute('data-model-id');
                            
                            // 更新缩略图选中状态
                            thumbnails.forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                            
                            // 随机选择一个动画效果
                            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                            
                            // 显示对应的详细信息卡片
                            detailCards.forEach(card => {
                                card.classList.add('d-none');
                            });
                            
                            const targetCard = document.getElementById('model-detail-' + modelId);
                            if (targetCard) {
                                targetCard.classList.remove('d-none');
                                targetCard.classList.add(randomAnimation);
                                
                                // 动画结束后移除类名，以便下次可以重新触发动画
                                setTimeout(() => {
                                    targetCard.classList.remove(randomAnimation);
                                }, 800);
                            }
                        });
                    });
                    
                    // 添加触摸事件处理
                    const modelImageContainers = document.querySelectorAll('[data-model-image-container]');
                    modelImageContainers.forEach(container => {
                        // 随机定位叠加图片
                        const overlayImages = container.querySelectorAll('[data-corner]');
                        const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                        
                        // 如果有两张图片，确保它们不会重叠
                        if (overlayImages.length === 2) {
                            // 为第一张图片随机选择一个角落
                            const firstCorner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('first', firstCorner);
                            
                            // 为第二张图片选择一个不同的角落
                            const availableCorners = corners.filter(corner => corner !== firstCorner);
                            const secondCorner = availableCorners[Math.floor(Math.random() * availableCorners.length)];
                            overlayImages[1].classList.add('second', secondCorner);
                        } else if (overlayImages.length === 1) {
                            // 如果只有一张图片，随机选择一个角落
                            const corner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('single', corner);
                        }
                        
                        // 触摸开始事件
                        container.addEventListener('touchstart', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                            }
                        });
                        
                        // 触摸结束事件
                        container.addEventListener('touchend', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 触摸取消事件
                        container.addEventListener('touchcancel', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 鼠标按下事件（桌面端）
                        container.addEventListener('mousedown', function(e) {
                            // 检查鼠标按下目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                                
                                // 添加鼠标释放事件监听器
                                const handleMouseUp = () => {
                                    this.classList.remove('touch-active');
                                    // 移除事件监听器
                                    document.removeEventListener('mouseup', handleMouseUp);
                                };
                                
                                // 添加到document上，确保在页面任何地方释放鼠标都能触发
                                document.addEventListener('mouseup', handleMouseUp);
                            }
                            // 移除preventDefault以允许页面滚动
                        });
                    });
                    
                    // 图片放大功能
                    const enlargableImages = document.querySelectorAll('[data-enlargeable]');
                    const imageEnlarger = document.getElementById('image-enlarger');
                    const enlargedImage = document.getElementById('enlarged-image');
                    const enlargedImageCaption = document.getElementById('enlarged-image-caption');
                    const closeBtn = document.querySelector('.image-enlarger-close');
                    
                    // 为每个可放大的图片添加点击事件
                    enlargableImages.forEach(img => {
                        img.addEventListener('click', function(e) {
                            e.stopPropagation();
                            
                            // 设置放大图片的src和alt属性
                            enlargedImage.src = this.src;
                            enlargedImage.alt = this.alt;
                            enlargedImageCaption.textContent = this.alt;
                            
                            // 如果是服装图片，添加特殊样式类以消除旋转角度
                            if (this.classList.contains('outfit-image')) {
                                enlargedImage.className = 'image-enlarger-img outfit-image';
                            } else {
                                enlargedImage.className = 'image-enlarger-img';
                            }
                            
                            // 显示放大查看器 - 先移除d-none类，再触发显示动画
                            imageEnlarger.classList.remove('d-none');
                            
                            // 添加入场动画的特殊效果
                            setTimeout(() => {
                                imageEnlarger.classList.add('show');
                            }, 10);
                            
                            // 阻止页面滚动
                            document.body.style.overflow = 'hidden';
                        });
                    });
                    
                    // 关闭放大查看器
                    const closeEnlarger = () => {
                        // 添加退出动画类
                        imageEnlarger.classList.add('hiding');
                        
                        // 等待动画结束后隐藏元素
                        setTimeout(() => {
                            imageEnlarger.classList.add('d-none');
                            imageEnlarger.classList.remove('hiding', 'show');
                            document.body.style.overflow = '';
                        }, 700);
                    };
                    
                    // 点击关闭按钮关闭
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeEnlarger);
                    }
                    
                    // 点击图片或遮罩层关闭
                    if (imageEnlarger) {
                        imageEnlarger.addEventListener('click', function(e) {
                            if (e.target === imageEnlarger || e.target === enlargedImage) {
                                closeEnlarger();
                            }
                        });
                    }
                    
                    // 按ESC键关闭
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && !imageEnlarger.classList.contains('d-none')) {
                            closeEnlarger();
                        }
                    });
                });
                </script>
            </div>
            
        </div>
    </div>
</div>

<script>
    // 将Django模板变量存储在DOM属性中
    document.addEventListener('DOMContentLoaded', function() {
        console.assert('shhh');
        const toggleBtn = document.getElementById('toggleMapBtn');
        const mapSection = document.getElementById('mapSection');
        
        {% if event.location_poi %}
        if (toggleBtn && mapSection) {
            toggleBtn.addEventListener('click', function() {
                
                mapSection.classList.toggle('d-none');
                const isHidden = mapSection.classList.contains('d-none');
                toggleBtn.innerHTML = isHidden ? 
                    '<i class="fas fa-map-marked-alt me-1"></i>查看地图' : 
                    '<i class="fas fa-times me-1"></i>隐藏地图';
                    
                // 如果是第一次显示地图，则初始化地图
                if (!isHidden && !mapSection.dataset.initialized) {
                    mapSection.dataset.initialized = "true";
                    setTimeout(function() {
                        loadBaiduMap();
                    }, 100);
                }
            });
        }
        
        // 显示POI详细信息
        try {
            const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
            const poiInfoDiv = document.getElementById('poi-info');
            
            // 显示POI信息
            let poiHtml = '<ul class="list-unstyled">';
            poiHtml += `<li><strong>地址:</strong> ${poiData.address || '无'}</li>`;
            if (poiData.phoneNumber) {
                poiHtml += `<li><strong>电话:</strong> ${poiData.phoneNumber}</li>`;
            }
            if (poiData.postCode) {
                poiHtml += `<li><strong>邮编:</strong> ${poiData.postCode}</li>`;
            }
            poiHtml += '</ul>';
            
            poiInfoDiv.innerHTML = poiHtml;
        } catch (e) {
            console.error('解析POI数据失败:', e);
        }
        {% endif %}
    });

    // 初始化地图
    // 初始化地图
    function initEventMap() {
        try {
            {% if event.location_poi %}
            const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
            const mapContainer = document.getElementById("event-map");
            if (!mapContainer) {
                console.error('地图容器未找到');
                return;
            }
            
            const map = new BMap.Map("event-map");
            
            // 设置地图中心点
            const point = new BMap.Point(poiData.point.lng, poiData.point.lat);
            map.centerAndZoom(point, 16);
            map.enableScrollWheelZoom(true);
            
            // 添加标记
            const marker = new BMap.Marker(point);
            map.addOverlay(marker);
            
            // 添加信息窗口
            const infoWindow = new BMap.InfoWindow(`<strong>${poiData.title}</strong><br>${poiData.address || ''}`);
            marker.addEventListener("click", function() {
                this.openInfoWindow(infoWindow);
            });
            
            // 立即打开信息窗口
            marker.openInfoWindow(infoWindow);
            {% else %}
            // 如果没有POI数据，显示默认地图
            const mapDefault = new BMap.Map("event-map");
            const pointDefault = new BMap.Point(116.404, 39.915);  // 默认北京位置
            mapDefault.centerAndZoom(pointDefault, 15);
            mapDefault.enableScrollWheelZoom(true);
            {% endif %}
        } catch (e) {
            console.error('初始化地图失败:', e);
            // 显示错误信息
            const mapContainer = document.getElementById('event-map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div class="alert alert-warning">地图加载失败</div>';
            }
        }
    }

    // 加载百度地图API
    function loadBaiduMap() {
        // 检查是否已经加载了百度地图API
        if (typeof BMap !== 'undefined') {
            initEventMap();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://api.map.baidu.com/api?v=3.0&ak=46xD48lIm4oyiWq1RaKyxhr2ZhkZiCWg&callback=initEventMap';
        script.onerror = function() {
            const mapContainer = document.getElementById('event-map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div class="alert alert-danger">地图加载失败，请检查网络连接</div>';
            }
        };
        document.head.appendChild(script);
    }
</script>
{% endblock %}