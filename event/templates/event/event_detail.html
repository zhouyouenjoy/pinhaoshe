{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">{{ event.title }}</h1>
                    {% if event.created_by == user %}
                    <span class="badge bg-light text-dark">我的活动</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><i class="fas fa-user me-2"></i><strong>发起人:</strong> {{ event.created_by.username }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><i class="fas fa-clock me-2"></i><strong>活动时间:</strong> {{ event.event_time }}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p>
                                <i class="fas fa-map-marker-alt me-2"></i><strong>活动场地:</strong> 
                              
                                {% if event.location_user %}
                                    <a href="{% url 'photos:my_info_with_id' event.location_user.id %}" class="text-decoration-none">
                                        {% with user=event.location_user %}
                                            {% if user.userprofile.avatar %}
                                                <img src="{{ user.userprofile.avatar.url }}" alt="{{ user.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                            {% else %}
                                            
                                                <div class="d-inline-block me-2 rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                                    <span class="text-white" style="font-size: 12px;">{{ user.username|slice:":1"|upper }}</span>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                        <span class="text-primary">{{ event.location }}</span>
                                    </a>
                                {% else %}
                                    {{ event.location }} {{event.location_user}}
                                {% endif %}
                            </p>
                        </div>
                        {% if event.location_poi %}
                        <div class="col-md-6">
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#poiDetails" aria-expanded="false" aria-controls="poiDetails">
                                查看详细位置信息
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if event.location_poi %}
                    <div class="collapse" id="poiDetails">
                        <div class="card card-body">
                            <h5>详细位置信息</h5>
                            <div id="poi-info"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <h5><i class="fas fa-align-left me-2"></i><strong>活动介绍:</strong></h5>
                        <p class="ms-4">{{ event.description|linebreaks }}</p>
                    </div>
                </div>
            </div>
            
            <!-- 模特信息 -->
            {% if event.models.all %}
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0">模特信息</h3>
                </div>
                <div class="card-body">
                    {% for model in event.models.all %}
                    <div class="model-section mb-4 {% if not forloop.last %}border-bottom pb-4{% endif %}">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>
                                    {% if model.model_user %}
                                        <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="text-decoration-none">
                                            {% if model.model_user.userprofile.avatar %}
                                                <img src="{{ model.model_user.userprofile.avatar.url }}" alt="{{ model.model_user.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                            {% else %}
                                                <div class="d-inline-block me-2 rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                                    <span class="text-white" style="font-size: 12px;">{{ model.model_user.username|slice:":1"|upper }}</span>
                                                </div>
                                            {% endif %}
                                            <span class="text-primary">{{ model.name }}</span>
                                        </a>
                                    {% else %}
                                        {{ model.name }}
                                    {% endif %}
                                </h5>
                                <p><strong>费用:</strong> ¥{{ model.fee }}</p>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    {% if model.model_images %}
                                    <div class="col-md-4 mb-3">
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }} 照片" class="img-fluid rounded">
                                        <p class="text-center small mt-1">模特照片</p>
                                    </div>
                                    {% endif %}
                                    {% if model.outfit_images %}
                                    <div class="col-md-4 mb-3">
                                        <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="img-fluid rounded">
                                        <p class="text-center small mt-1">服装道具</p>
                                    </div>
                                    {% endif %}
                                    {% if model.scene_images %}
                                    <div class="col-md-4 mb-3">
                                        <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 场景" class="img-fluid rounded">
                                        <p class="text-center small mt-1">拍摄场景</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 场次信息 -->
                        {% if model.sessions.all %}
                        <div class="mt-3">
                            <h6>场次安排:</h6>
                            <div class="row">
                                {% for session in model.sessions.all %}
                                <div class="col-md-6">
                                    <div class="session-item p-2 mb-2 border rounded">
                                        <strong>{{ session.title }}:</strong> {{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">活动地图</h4>
                </div>
                <div class="card-body">
                    <div id="event-map" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 显示POI详细信息
document.addEventListener('DOMContentLoaded', function() {
    // 只有当存在location_poi数据时才执行
    {% if event.location_poi %}
    try {
        const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
        const poiInfoDiv = document.getElementById('poi-info');
        
        // 显示POI信息
        let poiHtml = '<ul class="list-unstyled">';
        poiHtml += `<li><strong>地址:</strong> ${poiData.address || '无'}</li>`;
        if (poiData.phoneNumber) {
            poiHtml += `<li><strong>电话:</strong> ${poiData.phoneNumber}</li>`;
        }
        if (poiData.postCode) {
            poiHtml += `<li><strong>邮编:</strong> ${poiData.postCode}</li>`;
        }
        poiHtml += '</ul>';
        
        poiInfoDiv.innerHTML = poiHtml;
    } catch (e) {
        console.error('解析POI数据失败:', e);
    }
    {% endif %}
});

// 初始化地图
function initEventMap() {
    try {
        {% if event.location_poi %}
        const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
        const map = new BMap.Map("event-map");
        
        // 设置地图中心点
        const point = new BMap.Point(poiData.point.lng, poiData.point.lat);
        map.centerAndZoom(point, 16);
        map.enableScrollWheelZoom(true);
        
        // 添加标记
        const marker = new BMap.Marker(point);
        map.addOverlay(marker);
        
        // 添加信息窗口
        const infoWindow = new BMap.InfoWindow(`<strong>${poiData.title}</strong><br>${poiData.address || ''}`);
        marker.addEventListener("click", function() {
            this.openInfoWindow(infoWindow);
        });
        {% else %}
        // 如果没有POI数据，显示默认地图
        const mapDefault = new BMap.Map("event-map");
        const pointDefault = new BMap.Point(116.404, 39.915);  // 默认北京位置
        mapDefault.centerAndZoom(pointDefault, 15);
        mapDefault.enableScrollWheelZoom(true);
        {% endif %}
    } catch (e) {
        console.error('初始化地图失败:', e);
        // 显示错误信息
        document.getElementById('event-map').innerHTML = '<div class="alert alert-warning">地图加载失败</div>';
    }
}

// 加载百度地图API
function loadBaiduMap() {
    const script = document.createElement('script');
    script.src = 'https://api.map.baidu.com/api?v=3.0&ak=46xD48lIm4oyiWq1RaKyxhr2ZhkZiCWg&callback=initEventMap';
    script.onerror = function() {
        document.getElementById('event-map').innerHTML = '<div class="alert alert-danger">地图加载失败，请检查网络连接</div>';
    };
    document.head.appendChild(script);
}

// 页面加载完成后加载地图
document.addEventListener('DOMContentLoaded', function() {
    loadBaiduMap();
});
</script>
{% endblock %}