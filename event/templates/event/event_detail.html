{% extends 'minimal_base.html' %}
{% load static %}
{% block title %}{{ event.title }}{% endblock %}
{% block container_class %}container-fluid p-0 m-0{% endblock %}
{% block content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/event/event_detail.css' %}">

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Righteous&display=swap');

/* 减小标题栏高度 */
.event-card-header {
    padding: 0.7rem 1rem !important;
}

/* 返回箭头动效 */
.back-arrow {
    transition: all 0.3s ease;
    display: inline-block;
}

.back-arrow:hover {
    transform: translateX(-5px);
    color: #fff;
}

.back-arrow:active {
    transform: translateX(-8px);
}

/* 二次元风格艺术字效果 */
.anime-title {
    font-family: 'ZCOOL KuaiLe', 'Righteous', 'Press Start 2P', cursive, sans-serif;
    font-weight: bold;
    position: relative;
    display: inline-block;
    
    animation: glow 1.5s ease-in-out infinite alternate;
    letter-spacing: 2px;
    font-size: 3.5rem;
    padding: 5px 10px;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.2);
    transform: perspective(500px) rotateY(5deg);
    transition: all 0.3s ease;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .anime-title {
        font-size: 1.4rem;
        letter-spacing: 1px;
    }
}

@media (max-width: 576px) {
    .anime-title {
        font-size: 1.2rem;
        letter-spacing: 0.5px;
    }
}
</style>

<div class="event-detail-container d-flex align-items-start py-0 px-0">
    <div class="container-fluid no-gutters p-0">
        <div class="row justify-content-center no-gutters m-0">
            <div class="col-lg-8 no-gutters p-0">
                <div class="event-card m-0 rounded-0">
                    <div class="event-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'event:event_list' %}" class="text-white me-3 back-arrow">
                                <i class="fas fa-arrow-left fa-lg"></i>
                            </a>
                            <h1 class="mb-0 anime-title">{{ event.title }}</h1>
                        </div>
                        {% if event.created_by == user %}
                        <span class="my-event-badge">我的活动</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-2">
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <i class="fas fa-user me-2 text-primary"></i>
                                <span class="info-label">发起人:</span>
                                <a href="{% url 'photos:my_info_with_id' event.created_by.id %}" class="text-decoration-none">
                                    {% if event.created_by.userprofile.avatar %}
                                        <img src="{{ event.created_by.userprofile.avatar.url }}" alt="{{ event.created_by.username }}" class="avatar-circle">
                                    {% else %}
                                        <div class="avatar-placeholder">
                                            {{ event.created_by.username|slice:":1"|upper }}
                                        </div>
                                    {% endif %}
                                    <span class="text-primary compact-text">{{ event.created_by.username }}</span>
                                </a>
                            </div>
                            <div class="col-md-4 info-item d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span class="info-label me-2 mb-0">活动时间:</span>
                                <span class="compact-text mb-0">{{ event.event_time|date:"Y-m-d H:i" }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <!-- 使用flex容器包裹所有元素实现横向排列 -->
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                        <span class="info-label">活动场地:</span>
                                        {% if event.location_user %}
                                            <a href="{% url 'photos:my_info_with_id' event.location_user.id %}" class="text-decoration-none ms-1">
                                                {% with user=event.location_user %}
                                                    {% if user.userprofile.avatar %}
                                                        <img src="{{ user.userprofile.avatar.url }}" alt="{{ user.username }}" class="avatar-circle">
                                                    {% else %}
                                                        <div class="avatar-placeholder">
                                                            {{ user.username|slice:":1"|upper }}
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                                <span class="text-primary compact-text">{{ event.location }}</span>
                                            </a>
                                        {% else %}
                                            <span class="ms-1 compact-text">{{ event.location }}</span>
                                        {% endif %}
                                    </div>

                                    {% if event.location_poi %}
                                    <button class="btn-custom ms-auto" id="toggleMapBtn" type="button">
                                        <i class="fas fa-map-marked-alt me-1"></i>查看地图
                                    </button>
                                    {% endif %}
                                </div>
    
                            </div>
                            
                        </div>
                        
                        {% if event.location_poi %}
                        <div id="mapSection" class="d-none">
                            <div class="poi-info mb-1 pb-1 border-bottom">
                                <div class="map-container mb-2">
                                    <div id="event-map"></div>
                                </div>
                                <h5 class="mb-1"><i class="fas fa-map-marker-alt me-2 text-primary"></i>详细位置信息</h5>
                                <div id="poi-info" class="compact-text"></div>
                                <!-- 存储POI数据供JavaScript使用 -->
                                <script type="application/json" id="poi-data">{{ event.location_poi|escapejs }}</script>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-1 pb-1 border-bottom">
                            <h5 class="mb-1"><i class="fas fa-align-left me-2 text-primary"></i>活动介绍</h5>
                            <div class="p-2 bg-light rounded compact-text">
                                {{ event.description|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 模特信息 -->
                {% if event.models.all %}
                <div class="section-card m-0 rounded-0">
                    <div class="section-card-header">
                    </div>
                    <div class="card-body p-2">
                        <!-- 模特缩略图网格 -->
                        <div class="models-grid">
                            {% for model in event.models.all %}
                            <div class="model-thumbnail {% if forloop.first %}active{% endif %}" 
                                 data-model-id="{{ model.id }}">
                                {% if model.model_user and model.model_user.userprofile.avatar %}
                                    <img src="{{ model.model_user.userprofile.avatar.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                {% else %}
                                    {% if model.model_images %}
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                    {% else %}
                                        {% with model_photos=model.model_user.photo_set.all|slice:":1" %}
                                            {% if model_photos %}
                                                {% for photo in model_photos %}
                                                    {% if photo.image %}
                                                        <img src="{{ photo.image.url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <div class="model-thumbnail-img d-flex align-items-center justify-content-center bg-light">
                                                    <i class="fas fa-user fa-2x text-muted"></i>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% endif %}
                                <div class="model-thumbnail-name">{{ model.name }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- 模特详细信息展示区 -->
                        {% for model in event.models.all %}
                        <div class="model-detail-card {% if not forloop.first %}d-none{% endif %}" 
                             id="model-detail-{{ model.id }}">

                            <div class="model-detail-content"> 
                                <div class="model-images-grid position-relative">
                                
                                    {% with model_photos=model.model_user.photo_set.all|slice:":1" %}
                                        {% if model_photos %}
                                            {% for photo in model_photos %}
                                                {% if not model.model_images and photo.image %}
                                                    <div class="model-image-card" data-model-image-container>
                                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                                            <div>
                                                                <div class="model-detail-fee mb-0">{{ model.name }}</div>
                                                            </div>
                                                            {% if model.model_user %}
                                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                                            </a>
                                                            {% endif %}
                                                        </div>
                                                        <img src="{{ photo.image.url }}" alt="{{ model.name }} 照片" class="model-image">
                                                        <!-- 叠加的小图片 -->
                                                        <div class="overlay-images">
                                                            {% if model.outfit_images %}
                                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable>
                                                            {% endif %}
                                                            {% if model.scene_images %}
                                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable>
                                                            {% endif %}
                                                        </div>
                                                        <div class="model-image-caption">模特照片</div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endwith %}
                                    
                                    {% if model.model_images %}
                                    <div class="model-image-card" data-model-image-container>
                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                            <div>
                                                <div class="model-detail-fee mb-0">{{ model.name }}</div>
                                            </div>
                                            {% if model.model_user %}
                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                            </a>
                                            {% endif %}
                                        </div>
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }} 照片" class="model-image">
                                        <!-- 叠加的小图片 -->
                                        <div class="overlay-images">
                                            {% if model.outfit_images %}
                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable>
                                            {% endif %}
                                            {% if model.scene_images %}
                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable>
                                            {% endif %}
                                        </div>
                                        <div class="model-image-caption">模特照片</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 场次信息 -->
                                {% if model.sessions.all %}
                                <div class="sessions-container">
                                    <div class="row">
                                        {% for session in model.sessions.all %}
                                        <div class="col-md-6 mb-2">
                                            <div class="session-item-detail p-2 border rounded session-option" 
                                                 data-session-id="{{ session.id }}"
                                                 data-session-title="{{ session.title }}"
                                                 data-session-time="{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}"
                                                 data-fee="{{ model.fee }}"
                                                 {% if model.vip_fee %}data-vip-fee="{{ model.vip_fee }}"{% endif %}
                                                 {% if user.is_authenticated and session.id in user_registrations %}
                                                 data-registered="true"
                                                 {% endif %}>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="session-title">{{ session.title }}</div>
                                                        <div class="session-time">{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}</div>
                                                        <div class="session-fee">
                                                            费用: ¥{{ model.fee }} 
                                                            {% if model.vip_fee %}/ VIP: ¥{{ model.vip_fee }}{% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="session-spots">
                                                            剩余名额: {{ session.remaining_spots }}/{{ session.photographer_count }}
                                                        </div>
                                                        {% if user.is_authenticated and session.id in user_registrations %}
                                                        <div class="registered-badge mt-1 d-inline-block">
                                                            <span class="badge bg-success">已报名</span>
                                                        </div>
                                                        {% elif session.remaining_spots <= 0 %}
                                                        <div class="full-badge mt-1 d-inline-block">
                                                            <span class="badge bg-secondary">名额已满</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- 统一的报名按钮 -->
                                    <div class="register-button-container">
                                        {% if user.is_authenticated %}
                                            <button class="btn register-model-btn" 
                                                    data-model-name="{{ model.name }}"
                                                    data-model-id="{{ model.id }}"
                                                    disabled>
                                                报名参与
                                            </button>
                                        {% else %}
                                            <a href="{% url 'login' %}" class="btn register-model-btn">
                                                登录后报名
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 图片放大查看器 -->
                <div id="image-enlarger" class="image-enlarger d-none">
                    <div class="image-enlarger-content">
                        <span class="image-enlarger-close">&times;</span>
                        <img class="image-enlarger-img" id="enlarged-image">
                        <div class="image-enlarger-caption" id="enlarged-image-caption"></div>
                    </div>
                </div>
                
                <!-- 报名模态框 -->
                <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="registrationModalLabel">确认报名</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>您确定要报名参加以下场次吗？</p>
                                <p><strong>模特:</strong> <span id="modal-model-name"></span></p>
                                <p><strong>场次:</strong> <span id="modal-session-title"></span></p>
                                <p><strong>时间:</strong> <span id="modal-session-time"></span></p>
                                <p><strong>费用:</strong> <span id="modal-fee"></span></p>
                                <div class="alert alert-info">
                                    报名后请按时参加活动，如有变动请提前联系活动发起人。
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="confirm-registration">确认报名</button>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
</div>

<script>
                // 模特信息切换功能
                document.addEventListener('DOMContentLoaded', function() {
                    const thumbnails = document.querySelectorAll('.model-thumbnail');
                    const detailCards = document.querySelectorAll('.model-detail-card');
                    
                    // 定义动画类型数组
                    const animations = ['slide-in', 'bounce-in', 'flip-in', 'fade-in'];
                    
                    thumbnails.forEach(thumbnail => {
                        thumbnail.addEventListener('click', function() {
                            const modelId = this.getAttribute('data-model-id');
                            
                            // 更新缩略图选中状态
                            thumbnails.forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                            
                            // 随机选择一个动画效果
                            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                            
                            // 显示对应的详细信息卡片
                            detailCards.forEach(card => {
                                card.classList.add('d-none');
                            });
                            
                            const targetCard = document.getElementById('model-detail-' + modelId);
                            if (targetCard) {
                                targetCard.classList.remove('d-none');
                                targetCard.classList.add(randomAnimation);
                                
                                // 动画结束后移除类名，以便下次可以重新触发动画
                                setTimeout(() => {
                                    targetCard.classList.remove(randomAnimation);
                                }, 800);
                            }
                        });
                    });
                    
                    // 添加触摸事件处理
                    const modelImageContainers = document.querySelectorAll('[data-model-image-container]');
                    modelImageContainers.forEach(container => {
                        // 随机定位叠加图片
                        const overlayImages = container.querySelectorAll('[data-corner]');
                        const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                        
                        // 如果有两张图片，确保它们不会重叠
                        if (overlayImages.length === 2) {
                            // 为第一张图片随机选择一个角落
                            const firstCorner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('first', firstCorner);
                            
                            // 为第二张图片选择一个不同的角落
                            const availableCorners = corners.filter(corner => corner !== firstCorner);
                            const secondCorner = availableCorners[Math.floor(Math.random() * availableCorners.length)];
                            overlayImages[1].classList.add('second', secondCorner);
                        } else if (overlayImages.length === 1) {
                            // 如果只有一张图片，随机选择一个角落
                            const corner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('single', corner);
                        }
                        
                        // 触摸开始事件
                        container.addEventListener('touchstart', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                            }
                        });
                        
                        // 触摸结束事件
                        container.addEventListener('touchend', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 触摸取消事件
                        container.addEventListener('touchcancel', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 鼠标按下事件（桌面端）
                        container.addEventListener('mousedown', function(e) {
                            // 检查鼠标按下目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                                
                                // 添加鼠标释放事件监听器
                                const handleMouseUp = () => {
                                    this.classList.remove('touch-active');
                                    // 移除事件监听器
                                    document.removeEventListener('mouseup', handleMouseUp);
                                };
                                
                                // 添加到document上，确保在页面任何地方释放鼠标都能触发
                                document.addEventListener('mouseup', handleMouseUp);
                            }
                            // 移除preventDefault以允许页面滚动
                        });
                    });
                    
                    // 图片放大功能
                    const enlargableImages = document.querySelectorAll('[data-enlargeable]');
                    const imageEnlarger = document.getElementById('image-enlarger');
                    const enlargedImage = document.getElementById('enlarged-image');
                    const enlargedImageCaption = document.getElementById('enlarged-image-caption');
                    const closeBtn = document.querySelector('.image-enlarger-close');
                    
                    // 为每个可放大的图片添加点击事件
                    enlargableImages.forEach(img => {
                        img.addEventListener('click', function(e) {
                            e.stopPropagation();
                            
                            // 设置放大图片的src和alt属性
                            enlargedImage.src = this.src;
                            enlargedImage.alt = this.alt;
                            enlargedImageCaption.textContent = this.alt;
                            
                            // 如果是服装图片，添加特殊样式类以消除旋转角度
                            if (this.classList.contains('outfit-image')) {
                                enlargedImage.className = 'image-enlarger-img outfit-image';
                            } else {
                                enlargedImage.className = 'image-enlarger-img';
                            }
                            
                            // 显示放大查看器 - 先移除d-none类，再触发显示动画
                            imageEnlarger.classList.remove('d-none');
                            
                            // 添加入场动画的特殊效果
                            setTimeout(() => {
                                imageEnlarger.classList.add('show');
                            }, 10);
                            
                            // 阻止页面滚动
                            document.body.style.overflow = 'hidden';
                        });
                    });
                    
                    // 关闭放大查看器
                    const closeEnlarger = () => {
                        // 添加退出动画类
                        imageEnlarger.classList.add('hiding');
                        
                        // 等待动画结束后隐藏元素
                        setTimeout(() => {
                            imageEnlarger.classList.add('d-none');
                            imageEnlarger.classList.remove('hiding', 'show');
                            document.body.style.overflow = '';
                        }, 700);
                    };
                    
                    // 点击关闭按钮关闭
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeEnlarger);
                    }
                    
                    // 点击图片或遮罩层关闭
                    if (imageEnlarger) {
                        imageEnlarger.addEventListener('click', function(e) {
                            if (e.target === imageEnlarger || e.target === enlargedImage) {
                                closeEnlarger();
                            }
                        });
                    }
                    
                    // 按ESC键关闭
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && !imageEnlarger.classList.contains('d-none')) {
                            closeEnlarger();
                        }
                    });
                    
                    // 报名按钮事件处理
                    const registerButtons = document.querySelectorAll('.register-btn');
                    let selectedSessionId = null;
                    
                    registerButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            selectedSessionId = this.getAttribute('data-session-id');
                            const sessionTitle = this.getAttribute('data-session-title');
                            const modelName = this.getAttribute('data-model-name');
                            
                            document.getElementById('modal-session-title').textContent = sessionTitle;
                            document.getElementById('modal-model-name').textContent = modelName;
                            
                            const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
                            modal.show();
                        });
                    });
                    
                    // 新的报名流程 - 场次选择
                    const sessionOptions = document.querySelectorAll('.session-option');
                    const registerModelButtons = document.querySelectorAll('.register-model-btn');
                    let selectedSession = {};
                    
                    // 为每个模特的场次选项添加点击事件
                    sessionOptions.forEach(option => {
                        // 检查是否已报名或已满员
                        const isRegistered = option.hasAttribute('data-registered');
                        const spotsText = option.querySelector('.session-spots').textContent;
                        const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                        const isFull = spotsMatch && parseInt(spotsMatch[1]) <= 0;
                        
                        // 如果已报名或已满员，则添加相应的类
                        if (isRegistered) {
                            option.classList.add('registered');
                        } else if (isFull) {
                            option.classList.add('full');
                        }
                        
                        option.addEventListener('click', function() {
                            // 如果已报名或已满员，则不能选择
                            if (this.classList.contains('registered') || this.classList.contains('full')) {
                                return;
                            }
                            
                            // 获取当前模特的ID
                            const modelCard = this.closest('.model-detail-card');
                            const modelId = modelCard.id.replace('model-detail-', '');
                            
                            // 检查是否已经选中当前场次，如果是则取消选择
                            if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                                // 清除该模特的选中信息
                                delete selectedSession[modelId];
                                
                                // 禁用对应的报名按钮
                                const registerBtn = modelCard.querySelector('.register-model-btn');
                                if (registerBtn) {
                                    registerBtn.disabled = true;
                                }
                                return;
                            }
                            
                            // 清除当前模特的其他场次选中状态
                            const currentModelOptions = modelCard.querySelectorAll('.session-option');
                            currentModelOptions.forEach(opt => {
                                // 只有未报名且未满员的场次才能被取消选中
                                if (!opt.classList.contains('registered') && !opt.classList.contains('full')) {
                                    opt.classList.remove('selected');
                                }
                            });
                            
                            // 设置当前场次为选中状态
                            this.classList.add('selected');
                            
                            // 保存选中的场次信息
                            selectedSession[modelId] = {
                                id: this.getAttribute('data-session-id'),
                                title: this.getAttribute('data-session-title'),
                                time: this.getAttribute('data-session-time'),
                                fee: this.getAttribute('data-fee'),
                                vip_fee: this.getAttribute('data-vip-fee')
                            };
                            
                            // 启用对应的报名按钮
                            const registerBtn = modelCard.querySelector('.register-model-btn');
                            if (registerBtn) {
                                registerBtn.disabled = false;
                                
                                // 检查该场次是否还有名额
                                const spotsText = this.querySelector('.session-spots').textContent;
                                const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                                if (spotsMatch) {
                                    const remaining = parseInt(spotsMatch[1]);
                                    if (remaining <= 0) {
                                        registerBtn.disabled = true;
                                        registerBtn.textContent = '名额已满';
                                    } else {
                                        registerBtn.disabled = false;
                                        registerBtn.textContent = '报名参与';
                                    }
                                }
                            }
                        });
                        
                        // 添加鼠标按下和释放事件以增强视觉反馈
                        option.addEventListener('mousedown', function() {
                            // 如果已报名或已满员，则不添加点击效果
                            if (this.classList.contains('registered') || this.classList.contains('full')) {
                                return;
                            }
                            
                            this.classList.add('session-option-clicked');
                        });
                        
                        option.addEventListener('mouseup', function() {
                            this.classList.remove('session-option-clicked');
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            this.classList.remove('session-option-clicked');
                        });
                    });
                    
                    // 为每个模特的报名按钮添加点击事件
                    registerModelButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // 获取当前模特的ID
                            const modelCard = this.closest('.model-detail-card');
                            const modelId = modelCard.id.replace('model-detail-', '');
                            
                            // 检查是否已选择场次
                            if (!selectedSession[modelId]) {
                                alert('请先选择一个场次');
                                return;
                            }
                            
                            // 检查场次是否还有名额
                            const sessionOption = modelCard.querySelector('.session-option.selected');
                            const spotsText = sessionOption.querySelector('.session-spots').textContent;
                            const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                            if (spotsMatch) {
                                const remaining = parseInt(spotsMatch[1]);
                                if (remaining <= 0) {
                                    alert('该场次名额已满');
                                    return;
                                }
                            }
                            
                            // 设置模态框信息
                            document.getElementById('modal-session-title').textContent = selectedSession[modelId].title;
                            document.getElementById('modal-model-name').textContent = this.getAttribute('data-model-name');
                            document.getElementById('modal-session-time').textContent = selectedSession[modelId].time;
                            
                            // 设置费用信息
                            let feeText = '¥' + selectedSession[modelId].fee;
                            if (selectedSession[modelId].vip_fee) {
                                feeText += ' / VIP: ¥' + selectedSession[modelId].vip_fee;
                            }
                            document.getElementById('modal-fee').textContent = feeText;
                            
                            // 显示确认模态框
                            selectedSessionId = selectedSession[modelId].id;
                            const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
                            modal.show();
                        });
                    });
                    
                    // 确认报名按钮事件处理
                    document.getElementById('confirm-registration').addEventListener('click', function() {
                        if (!selectedSessionId) return;
                        
                        // 发送报名请求
                        fetch(`/event/register/${selectedSessionId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 报名成功
                                alert('报名成功！');
                                // 关闭模态框
                                const modal = bootstrap.Modal.getInstance(document.getElementById('registrationModal'));
                                modal.hide();
                                // 可以选择刷新页面或更新剩余名额显示
                                location.reload();
                            } else {
                                // 报名失败
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('报名请求失败，请稍后重试');
                        });
                    });
                    
                    // 地图相关功能
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    const mapSection = document.getElementById('mapSection');
                    
                    {% if event.location_poi %}
                    if (toggleBtn && mapSection) {
                        toggleBtn.addEventListener('click', function() {
                            
                            mapSection.classList.toggle('d-none');
                            const isHidden = mapSection.classList.contains('d-none');
                            toggleBtn.innerHTML = isHidden ? 
                                '<i class="fas fa-map-marked-alt me-1"></i>查看地图' : 
                                '<i class="fas fa-times me-1"></i>隐藏地图';
                                
                            // 如果是第一次显示地图，则初始化地图
                            if (!isHidden && !mapSection.dataset.initialized) {
                                mapSection.dataset.initialized = "true";
                                setTimeout(function() {
                                    loadBaiduMap();
                                }, 100);
                            }
                        });
                    }
                    
                    // 显示POI详细信息
                    try {
                        const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
                        const poiInfoDiv = document.getElementById('poi-info');
                        
                        // 显示POI信息
                        let poiHtml = '<ul class="list-unstyled">';
                        poiHtml += `<li><strong>地址:</strong> ${poiData.address || '无'}</li>`;
                        if (poiData.phoneNumber) {
                            poiHtml += `<li><strong>电话:</strong> ${poiData.phoneNumber}</li>`;
                        }
                        if (poiData.postCode) {
                            poiHtml += `<li><strong>邮编:</strong> ${poiData.postCode}</li>`;
                        }
                        poiHtml += '</ul>';
                        
                        poiInfoDiv.innerHTML = poiHtml;
                    } catch (e) {
                        console.error('解析POI数据失败:', e);
                    }
                    {% endif %}
                });

                // 初始化地图
                function initEventMap() {
                    try {
                        {% if event.location_poi %}
                        const poiData = JSON.parse('{{ event.location_poi|escapejs }}');
                        const mapContainer = document.getElementById("event-map");
                        if (!mapContainer) {
                            console.error('地图容器未找到');
                            return;
                        }
                        
                        const map = new BMap.Map("event-map");
                        
                        // 设置地图中心点
                        const point = new BMap.Point(poiData.point.lng, poiData.point.lat);
                        map.centerAndZoom(point, 16);
                        map.enableScrollWheelZoom(true);
                        
                        // 添加标记
                        const marker = new BMap.Marker(point);
                        map.addOverlay(marker);
                        
                        // 添加信息窗口
                        const infoWindow = new BMap.InfoWindow(`<strong>${poiData.title}</strong><br>${poiData.address || ''}`);
                        marker.addEventListener("click", function() {
                            this.openInfoWindow(infoWindow);
                        });
                        
                        // 立即打开信息窗口
                        marker.openInfoWindow(infoWindow);
                        {% else %}
                        // 如果没有POI数据，显示默认地图
                        const mapDefault = new BMap.Map("event-map");
                        const pointDefault = new BMap.Point(116.404, 39.915);  // 默认北京位置
                        mapDefault.centerAndZoom(pointDefault, 15);
                        mapDefault.enableScrollWheelZoom(true);
                        {% endif %}
                    } catch (e) {
                        console.error('初始化地图失败:', e);
                        // 显示错误信息
                        const mapContainer = document.getElementById('event-map');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<div class="alert alert-warning">地图加载失败</div>';
                        }
                    }
                }

                // 加载百度地图API
                function loadBaiduMap() {
                    // 检查是否已经加载了百度地图API
                    if (typeof BMap !== 'undefined') {
                        initEventMap();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://api.map.baidu.com/api?v=3.0&ak=46xD48lIm4oyiWq1RaKyxhr2ZhkZiCWg&callback=initEventMap';
                    script.onerror = function() {
                        const mapContainer = document.getElementById('event-map');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<div class="alert alert-danger">地图加载失败，请检查网络连接</div>';
                        }
                    };
                    document.head.appendChild(script);
                }
                </script>
            </div>
            
        </div>
    </div>
</div>

<script>
    // 将Django模板变量存储在DOM属性中
    document.addEventListener('DOMContentLoaded', function() {
        console.assert('shhh');
    });

</script>
{% endblock %}