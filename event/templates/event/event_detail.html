{% extends 'minimal_base.html' %}
{% load static %}
{% load event_extras %}
{% block title %}{{ event.title }}{% endblock %}
{% block container_class %}container-fluid p-0 m-0{% endblock %}
{% block content %}
{% csrf_token %}
<!-- 添加referrer策略确保百度地图API请求包含正确的Referer头部 -->
<meta name="referrer" content="origin">
<link rel="stylesheet" href="{% static 'css/event/event_detail.css' %}">

<style>
    /* 有待支付场次的样式 */
    .session-option.pending-payment {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #f8f9fa;
        border-color: #dee2e6;
        pointer-events: none; /* 禁用所有鼠标事件 */
        -webkit-user-select: none; /* 禁用文本选择 */
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    .session-option.pending-payment:hover {
        background-color: #f8f9fa !important;
        transform: none !important;
        cursor: not-allowed !important;
    }
    
    .session-option.pending-payment .text-warning {
        font-weight: bold;
    }
    
    /* 确保有待支付的场次在任何情况下都不会有悬停或激活效果 */
    .session-option.pending-payment *,
    .session-option.pending-payment *:hover,
    .session-option.pending-payment *:active,
    .session-option.pending-payment *:focus {
        pointer-events: none !important;
        cursor: not-allowed !important;
    }
</style>

<!-- 添加移动端性能优化提示 -->
<div id="mobile-performance-tip" class="alert alert-info text-center mb-0 d-md-none" style="display: none;">
  <small>页面正在加载中，如果加载缓慢，请耐心等待或刷新页面</small>
</div>

<div class="event-detail-container d-flex align-items-start py-0 px-0">
    <div class="container-fluid no-gutters p-0">
        <div class="row justify-content-center no-gutters m-0">
            <div class="col-lg-8 no-gutters p-0">
                <div class="event-card m-0 rounded-0">
                    <div class="event-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="javascript:history.back()" class="text-white me-3 back-arrow">
                                <i class="fas fa-arrow-left fa-lg"></i>
                            </a>
                            <h3 class="mb-0 anime-title">{{ event.title }}</h3>
                        </div>
                        {% if event.created_by == user %}
                        <span class="my-event-badge">我的活动</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-2">
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <i class="fas fa-user me-2 text-primary"></i>
                                <span class="info-label">发起人:</span>
                                <a href="{% url 'photos:my_info_with_id' event.created_by.id %}" class="text-decoration-none">
                                    {% if event.created_by.userprofile.avatar_url %}
                                        <img src="{{ event.created_by.userprofile.avatar_url }}" alt="{{ event.created_by.username }}" class="avatar-circle">
                                    {% else %}
                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center avatar-circle" role="img" aria-label="{{ event.created_by.username }} 的默认头像">
                                            <span class="text-white">{{ event.created_by.username|first|upper }}</span>
                                        </div>
                                    {% endif %}
                                    <span class="text-primary compact-text">{{ event.created_by.username }}</span>
                                </a>
                            </div>
                            <div class="col-md-4 info-item d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span class="info-label me-2 mb-0">活动时间:</span>
                                <span class="compact-text mb-0">{{ event.event_time|date:"Y-m-d H:i" }}</span>
                            </div>
                        </div>
                        
                        <div class="row mb-1 pb-1 border-bottom mx-0">
                            <div class="col-md-6 info-item">
                                <!-- 使用flex容器包裹所有元素实现横向排列 -->
                                <div class="d-flex align-items-center flex-wrap gap-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                        <span class="info-label">活动场地:</span>
                                        {% if event.location_user %}
                                            <a href="{% url 'photos:my_info_with_id' event.location_user.id %}" class="text-decoration-none ms-1">
                                                {% with user=event.location_user %}
                                                    {% if user.userprofile.avatar_url %}
                                                        <img src="{{ user.userprofile.avatar_url }}" alt="{{ user.username }}" class="avatar-circle">
                                                    {% else %}
                                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center avatar-circle" role="img" aria-label="{{ user.username }} 的默认头像">
                                                            <span class="text-white">{{ user.username|first|upper }}</span>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                                <span class="text-primary compact-text">{{ event.location }}</span>
                                            </a>
                                        {% else %}
                                            <span class="ms-1 compact-text">{{ event.location }}</span>
                                        {% endif %}
                                    </div>

                                    {% if event.location_poi %}
                                    <button class="btn-custom ms-auto" id="toggleMapBtn" type="button">
                                        <i class="fas fa-map-marked-alt me-1"></i>查看地图
                                    </button>
                                    {% endif %}
                                </div>
    
                            </div>
                            
                        </div>
                        
                        {% if event.location_poi %}
                        <div id="mapSection" class="d-none" data-poi='{{ event.location_poi|escapejs }}'>
                            <div class="poi-info mb-1 pb-1 border-bottom">
                                <div class="map-container mb-2">
                                    <div id="event-map"></div>
                                </div>
                                <h5 class="mb-1"><i class="fas fa-map-marker-alt me-2 text-primary"></i>详细位置信息</h5>
                                <div id="poi-info" class="compact-text"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-1 pb-1 border-bottom">
                            <h5 class="mb-1"><i class="fas fa-align-left me-2 text-primary"></i>活动介绍</h5>
                            <div class="p-2 bg-light rounded compact-text">
                                {{ event.description|linebreaks }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 模特信息 -->
                {% if event.models.all %}
                <div class="section-card m-0 rounded-0">
                    <div class="section-card-header">
                    </div>
                    <div class="card-body p-2">
                        <!-- 模特缩略图网格 -->
                        <div class="models-grid">
                            {% for model in event.models.all %}
                            <div class="model-thumbnail {% if forloop.first %}active{% endif %}" 
                                 data-model-id="{{ model.id }}">
                                <div class="model-thumbnail-content">
                                    {% if model.model_user and model.model_user.userprofile.avatar_url %}
                                        <img src="{{ model.model_user.userprofile.avatar_url }}" alt="{{ model.name }}" class="model-thumbnail-img">
                                    {% else %}
                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center model-thumbnail-img" role="img" aria-label="{{ model.name }} 的默认头像">
                                            <span class="text-white">{{ model.name|first|upper }}</span>
                                        </div>
                                    {% endif %}
                                    <div class="spots-badge {% if model.get_remaining_spots == 0 %}zero{% elif model.get_remaining_spots < 3 %}low{% endif %}">{{ model.get_remaining_spots }}</div>
                                </div>
                                <div class="model-thumbnail-name">{{ model.name }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        <!-- 模特详细信息展示区 -->
                        {% for model in event.models.all %}
                        <div class="model-detail-card {% if not forloop.first %}d-none{% endif %}" 
                             id="model-detail-{{ model.id }}">

                            <div class="model-detail-content"> 
                                <div class="model-images-grid position-relative">
                                
                                    {% with model_photos=model.model_user.photo_set.all|slice:":1" %}
                                        {% if model_photos %}
                                            {% for photo in model_photos %}
                                                {% if not model.model_images and photo.image %}
                                                    <div class="model-image-card" data-model-image-container>
                                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                                            <div>
                                                                <div class="model-detail-fee mb-0">{{ model.name }}</div>
                                                            </div>
                                                            {% if model.model_user %}
                                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                                            </a>
                                                            {% endif %}
                                                        </div>
                                                        <!-- 添加loading属性以优化图片加载 -->
                                                        <img src="{{ photo.image.url }}" alt="{{ model.name }} 照片" class="model-image" loading="lazy" onerror="this.onerror=null;this.style.display='none';">
                                                        <!-- 叠加的小图片 -->
                                                        <div class="overlay-images">
                                                            {% if model.outfit_images %}
                                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable loading="lazy" onerror="this.onerror=null;this.style.display='none';">
                                                            {% endif %}
                                                            {% if model.scene_images %}
                                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable loading="lazy" onerror="this.onerror=null;this.style.display='none';">
                                                            {% endif %}
                                                        </div>
                                                        <div class="model-image-caption">模特照片</div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endwith %}
                                    
                                    {% if model.model_images %}
                                    <div class="model-image-card" data-model-image-container>
                                        <!-- 将费用和查看模特空间按钮移到这里 -->
                                        <div class="model-info-overlay d-flex justify-content-between align-items-center p-3">
                                            <div>
                                                <div class="model-detail-fee mb-0">{{ model.name }}</div>
                                            </div>
                                            {% if model.model_user %}
                                            <a href="{% url 'photos:my_info_with_id' model.model_user.id %}" class="btn btn-more">
                                                <i class="fas fa-user-circle me-1"></i>更多照片
                                            </a>
                                            {% endif %}
                                        </div>
                                        <!-- 添加loading属性以优化图片加载 -->
                                        <img src="{{ model.model_images.url }}" alt="{{ model.name }} 照片" class="model-image" loading="lazy">
                                        <!-- 叠加的小图片 -->
                                        <div class="overlay-images">
                                            {% if model.outfit_images %}
                                            <img src="{{ model.outfit_images.url }}" alt="{{ model.name }} 服装" class="overlay-image outfit-image" data-corner data-enlargeable loading="lazy">
                                            {% endif %}
                                            {% if model.scene_images %}
                                            <img src="{{ model.scene_images.url }}" alt="{{ model.name }} 拍摄场景" class="overlay-image scene-image" data-corner data-enlargeable loading="lazy">
                                            {% endif %}
                                        </div>
                                        <div class="model-image-caption">模特照片</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 场次信息 -->
                                {% if model.sessions.all %}
                                <div class="sessions-container">
                                    <div class="row">
                                        {% for session in model.sessions.all %}
                                        <div class="col-md-6 mb-2">
                                            <div class="session-item-detail p-2 border rounded session-option" 
                                                 data-session-id="{{ session.id }}"
                                                 data-session-title="{{ session.title }}"
                                                 data-session-time="{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}"
                                                 data-fee="{{ model.fee }}"
                                                 {% if model.vip_fee %}data-vip-fee="{{ model.vip_fee }}"{% endif %}
                                                 {% if user.is_authenticated and session.id in user_registrations %}
                                                 data-registered="true"
                                                 {% endif %}>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="session-title">{{ session.title }}</div>
                                                        <div class="session-time">{{ session.start_time|time:"H:i" }} - {{ session.end_time|time:"H:i" }}</div>
                                                        <div class="session-fee">
                                                            费用: ¥{{ model.fee }} 
                                                            {% if model.vip_fee %}/ VIP: ¥{{ model.vip_fee }}{% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="session-spots">
                                                            剩余名额: {{ session.remaining_spots }}/{{ session.photographer_count }}
                                                        </div>
                                                        {% if user.is_authenticated and session.id in user_registrations %}
                                                        <div class="text-success">
                                                            <i class="fas fa-check-circle"></i> 已报名
                                                        </div>
                                                        {% elif session|has_pending_registration:user %}
                                                            {% with pending_registration=session|get_pending_registration:user %}
                                                                {% if not pending_registration|is_pending_expired %}
                                                                <div class="text-warning">
                                                                    <i class="fas fa-hourglass-half"></i> 待支付
                                                                </div>
                                                                {% else %}
                                                                <div class="text-danger">
                                                                    <i class="fas fa-exclamation-circle"></i> 支付已超时
                                                                </div>
                                                                {% endif %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- 统一的报名按钮 -->
                                    <div class="register-button-container">
                                        {% if user.is_authenticated %}
                                            <button class="btn register-model-btn" 
                                                    data-model-name="{{ model.name }}"
                                                    data-model-id="{{ model.id }}"
                                                    {% if model.get_remaining_spots <= 0 %}disabled{% endif %}>
                                                {% if model.get_remaining_spots <= 0 %}
                                                    名额已满
                                                {% else %}
                                                    报名参与
                                                {% endif %}
                                            </button>
                                        {% else %}
                                            <a href="{% url 'login' %}" class="btn register-model-btn">
                                                登录后报名
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 图片放大查看器 -->
                <div id="image-enlarger" class="image-enlarger d-none">
                    <div class="image-enlarger-content">
                        <span class="image-enlarger-close">&times;</span>
                        <img class="image-enlarger-img" id="enlarged-image">
                        <div class="image-enlarger-caption" id="enlarged-image-caption"></div>
                    </div>
                </div>
                
                <!-- 报名模态框 -->
                <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="registrationModalLabel">确认报名</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>您确定要报名参加以下场次吗？</p>
                                <p><strong>模特:</strong> <span id="modal-model-name"></span></p>
                                <p><strong>场次:</strong> <span id="modal-session-title"></span></p>
                                <p><strong>时间:</strong> <span id="modal-session-time"></span></p>
                                <p><strong>费用:</strong> <span id="modal-fee"></span></p>
                                <div class="alert alert-info">
                                    报名后请按时参加活动，如有变动请提前联系活动发起人。
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="confirm-registration">确认报名</button>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
</div>

<script>
    // 页面加载完成后隐藏性能提示
    document.addEventListener('DOMContentLoaded', function() {
        const tip = document.getElementById('mobile-performance-tip');
        if (tip) {
            tip.style.display = 'none';
        }
        
        // 延迟加载百度地图API以提升初始页面加载速度
        setTimeout(function() {
            // 可以在这里添加延迟加载的逻辑
        }, 3000);
    });

                // 模特信息切换功能
                document.addEventListener('DOMContentLoaded', function() {
                    const thumbnails = document.querySelectorAll('.model-thumbnail');
                    const detailCards = document.querySelectorAll('.model-detail-card');
                    const modelsGrid = document.querySelector('.models-grid');
                    
                    // 定义动画类型数组
                    const animations = ['slide-in', 'bounce-in', 'flip-in', 'fade-in'];
                    
                    // 初始化第一个缩略图为激活状态
                    if (thumbnails.length > 0) {
                        thumbnails[0].classList.add('active');
                        thumbnails[0].style.transform = 'scale(1)';
                        thumbnails[0].style.opacity = '1';
                    }
                    
                    // 切换模特详情显示
                    function switchModel(modelId) {
                        // 更新缩略图选中状态
                        thumbnails.forEach(t => {
                            t.classList.remove('active');
                            t.style.transform = 'scale(0.85)';
                            t.style.opacity = '0.7';
                        });
                        
                        // 激活当前选中的缩略图
                        const activeThumbnail = document.querySelector(`.model-thumbnail[data-model-id="${modelId}"]`);
                        if (activeThumbnail) {
                            activeThumbnail.classList.add('active');
                            activeThumbnail.style.transform = 'scale(1)';
                            activeThumbnail.style.opacity = '1';
                        }
                        
                        // 隐藏所有详情卡片
                        detailCards.forEach(card => {
                            card.classList.add('d-none');
                            // 移除所有动画类
                            animations.forEach(anim => card.classList.remove(anim));
                        });
                        
                        // 显示对应的详细信息卡片
                        const targetCard = document.getElementById('model-detail-' + modelId);
                        if (targetCard) {
                            // 随机选择一个动画效果
                            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                            
                            targetCard.classList.remove('d-none');
                            targetCard.classList.add(randomAnimation);
                            
                            // 动画结束后移除类名，以便下次可以重新触发动画
                            setTimeout(() => {
                                targetCard.classList.remove(randomAnimation);
                            }, 800);
                        }
                    }
                    
                    // 为每个缩略图添加点击事件
                    thumbnails.forEach(thumbnail => {
                        thumbnail.addEventListener('click', function() {
                            const modelId = this.getAttribute('data-model-id');
                            switchModel(modelId);
                        });
                    });
                    
                    // 监听滚动事件，自动切换激活状态
                    let isScrolling;
                    modelsGrid.addEventListener('scroll', function() {
                        // 清除之前的timeout
                        window.clearTimeout(isScrolling);
                        
                        // 设置新的timeout
                        isScrolling = setTimeout(function() {
                            // 获取容器的左右边界
                            const containerRect = modelsGrid.getBoundingClientRect();
                            const containerLeft = containerRect.left;
                            const containerRight = containerRect.right;
                            
                            // 查找最靠左且可见的缩略图
                            let closestThumbnail = null;
                            let closestDistance = Infinity;
                            
                            thumbnails.forEach(thumbnail => {
                                const thumbnailRect = thumbnail.getBoundingClientRect();
                                const thumbnailCenter = (thumbnailRect.left + thumbnailRect.right) / 2;
                                
                                // 检查缩略图是否在容器可视范围内
                                if (thumbnailRect.right > containerLeft && thumbnailRect.left < containerRight) {
                                    // 计算缩略图中心到容器左侧的距离
                                    const distanceToLeft = Math.abs(thumbnailCenter - containerLeft);
                                    
                                    // 如果这个缩略图更靠近左侧，则更新最近的缩略图
                                    if (distanceToLeft < closestDistance) {
                                        closestDistance = distanceToLeft;
                                        closestThumbnail = thumbnail;
                                    }
                                }
                            });
                            
                            // 如果找到了最靠近左侧的可见缩略图，则激活它
                            if (closestThumbnail) {
                                const modelId = closestThumbnail.getAttribute('data-model-id');
                                switchModel(modelId);
                            }
                        }, 150); // 延迟150毫秒执行，避免频繁触发
                    });
                    
                    // 添加触摸事件处理
                    const modelImageContainers = document.querySelectorAll('[data-model-image-container]');
                    modelImageContainers.forEach(container => {
                        // 随机定位叠加图片
                        const overlayImages = container.querySelectorAll('[data-corner]');
                        const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                        
                        // 如果有两张图片，确保它们不会重叠
                        if (overlayImages.length === 2) {
                            // 为第一张图片随机选择一个角落
                            const firstCorner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('first', firstCorner);
                            
                            // 为第二张图片选择一个不同的角落
                            const availableCorners = corners.filter(corner => corner !== firstCorner);
                            const secondCorner = availableCorners[Math.floor(Math.random() * availableCorners.length)];
                            overlayImages[1].classList.add('second', secondCorner);
                        } else if (overlayImages.length === 1) {
                            // 如果只有一张图片，随机选择一个角落
                            const corner = corners[Math.floor(Math.random() * corners.length)];
                            overlayImages[0].classList.add('single', corner);
                        }
                        
                        // 触摸开始事件
                        container.addEventListener('touchstart', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                            }
                        });
                        
                        // 触摸结束事件
                        container.addEventListener('touchend', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 触摸取消事件
                        container.addEventListener('touchcancel', function(e) {
                            // 检查触摸目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.remove('touch-active');
                            }
                        });
                        
                        // 鼠标按下事件（桌面端）
                        container.addEventListener('mousedown', function(e) {
                            // 检查鼠标按下目标是否为可放大的图片
                            if (!e.target.hasAttribute('data-enlargeable')) {
                                this.classList.add('touch-active');
                                
                                // 添加鼠标释放事件监听器
                                const handleMouseUp = () => {
                                    this.classList.remove('touch-active');
                                    // 移除事件监听器
                                    document.removeEventListener('mouseup', handleMouseUp);
                                };
                                
                                // 添加到document上，确保在页面任何地方释放鼠标都能触发
                                document.addEventListener('mouseup', handleMouseUp);
                            }
                            // 移除preventDefault以允许页面滚动
                        });
                    });
                    
                    // 图片放大功能
                    const enlargableImages = document.querySelectorAll('[data-enlargeable]');
                    const imageEnlarger = document.getElementById('image-enlarger');
                    const enlargedImage = document.getElementById('enlarged-image');
                    const enlargedImageCaption = document.getElementById('enlarged-image-caption');
                    const closeBtn = document.querySelector('.image-enlarger-close');
                    
                    // 为每个可放大的图片添加点击事件
                    enlargableImages.forEach(img => {
                        img.addEventListener('click', function(e) {
                            e.stopPropagation();
                            
                            // 设置放大图片的src和alt属性
                            enlargedImage.src = this.src;
                            enlargedImage.alt = this.alt;
                            enlargedImageCaption.textContent = this.alt;
                            
                            // 如果是服装图片，添加特殊样式类以消除旋转角度
                            if (this.classList.contains('outfit-image')) {
                                enlargedImage.className = 'image-enlarger-img outfit-image';
                            } else {
                                enlargedImage.className = 'image-enlarger-img';
                            }
                            
                            // 显示放大查看器 - 先移除d-none类，再触发显示动画
                            imageEnlarger.classList.remove('d-none');
                            
                            // 添加入场动画的特殊效果
                            setTimeout(() => {
                                imageEnlarger.classList.add('show');
                            }, 10);
                            
                            // 阻止页面滚动
                            document.body.style.overflow = 'hidden';
                        });
                    });
                    
                    // 关闭放大查看器
                    const closeEnlarger = () => {
                        // 添加退出动画类
                        imageEnlarger.classList.add('hiding');
                        
                        // 等待动画结束后隐藏元素
                        setTimeout(() => {
                            imageEnlarger.classList.add('d-none');
                            imageEnlarger.classList.remove('hiding', 'show');
                            document.body.style.overflow = '';
                        }, 700);
                    };
                    
                    // 点击关闭按钮关闭
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeEnlarger);
                    }
                    
                    // 点击图片或遮罩层关闭
                    if (imageEnlarger) {
                        imageEnlarger.addEventListener('click', function(e) {
                            if (e.target === imageEnlarger || e.target === enlargedImage) {
                                closeEnlarger();
                            }
                        });
                    }
                    
                    // 按ESC键关闭
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && !imageEnlarger.classList.contains('d-none')) {
                            closeEnlarger();
                        }
                    });
                    
                    // 报名按钮事件处理
                    const registerButtons = document.querySelectorAll('.register-btn');
                    let selectedSessionId = null;
                    
                    registerButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            selectedSessionId = this.getAttribute('data-session-id');
                            const sessionTitle = this.getAttribute('data-session-title');
                            const modelName = this.getAttribute('data-model-name');
                            
                            document.getElementById('modal-session-title').textContent = sessionTitle;
                            document.getElementById('modal-model-name').textContent = modelName;
                            
                            const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
                            modal.show();
                        });
                    });
                    
                    // 新的报名流程 - 场次选择
                    const sessionOptions = document.querySelectorAll('.session-option');
                    const registerModelButtons = document.querySelectorAll('.register-model-btn');
                    let selectedSession = {};
                    
                    // 为每个模特的场次选项添加点击事件
                    sessionOptions.forEach(option => {
                        // 检查是否已报名或已满员
                        const isRegistered = option.hasAttribute('data-registered');
                        const spotsText = option.querySelector('.session-spots').textContent;
                        const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                        const isFull = spotsMatch && parseInt(spotsMatch[1]) <= 0;
                        
                        // 检查是否存在待支付状态
                        const hasPendingPayment = option.querySelector('.text-warning') !== null;
                        
                        // 如果已报名、已满员或有待支付，则添加相应的类
                        if (isRegistered) {
                            option.classList.add('registered');
                        } else if (isFull) {
                            option.classList.add('full');
                        } else if (hasPendingPayment) {
                            option.classList.add('pending-payment');
                        }
                        
                        // 提前绑定事件监听器，对于有待支付的场次直接阻止所有交互
                        if (hasPendingPayment) {
                            // 阻止所有可能的交互事件
                            ['click', 'mousedown', 'mouseup', 'mouseenter', 'mouseleave', 'mouseover', 'mouseout', 'focus', 'blur'].forEach(eventType => {
                                option.addEventListener(eventType, function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }, true);
                            });
                            
                            // 禁用该元素
                            option.style.pointerEvents = 'none';
                        } else {
                            // 只对非待支付的场次添加正常的交互处理
                            option.addEventListener('click', function() {
                                // 如果已报名或已满员，则不能选择
                                if (this.classList.contains('registered') || this.classList.contains('full')) {
                                    return;
                                }
                                
                                // 获取当前模特的ID
                                const modelCard = this.closest('.model-detail-card');
                                const modelId = modelCard.id.replace('model-detail-', '');
                                
                                // 检查是否已经选中当前场次，如果是则取消选择
                                if (this.classList.contains('selected')) {
                                    this.classList.remove('selected');
                                    // 清除该模特的选中信息
                                    delete selectedSession[modelId];
                                    
                                    // 禁用对应的报名按钮
                                    const registerBtn = modelCard.querySelector('.register-model-btn');
                                    if (registerBtn) {
                                        registerBtn.disabled = true;
                                    }
                                    return;
                                }
                                
                                // 清除当前模特的其他场次选中状态
                                const currentModelOptions = modelCard.querySelectorAll('.session-option');
                                currentModelOptions.forEach(opt => {
                                    // 只有未报名且未满员的场次才能被取消选中
                                    if (!opt.classList.contains('registered') && !opt.classList.contains('full')) {
                                        opt.classList.remove('selected');
                                    }
                                });
                                
                                // 设置当前场次为选中状态
                                this.classList.add('selected');
                                
                                // 保存选中的场次信息
                                selectedSession[modelId] = {
                                    id: this.getAttribute('data-session-id'),
                                    title: this.getAttribute('data-session-title'),
                                    time: this.getAttribute('data-session-time'),
                                    fee: this.getAttribute('data-fee'),
                                    vip_fee: this.getAttribute('data-vip-fee')
                                };
                                
                                // 启用对应的报名按钮
                                const registerBtn = modelCard.querySelector('.register-model-btn');
                                if (registerBtn) {
                                    registerBtn.disabled = false;
                                    
                                    // 检查该场次是否还有名额
                                    const spotsText = this.querySelector('.session-spots').textContent;
                                    const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                                    if (spotsMatch) {
                                        const remaining = parseInt(spotsMatch[1]);
                                        if (remaining <= 0) {
                                        registerBtn.disabled = true;
                                        registerBtn.textContent = '名额已满';
                                        } else {
                                            registerBtn.disabled = false;
                                            registerBtn.textContent = '报名参与';
                                        }
                                    }
                                }
                            });
                            
                            // 添加鼠标按下和释放事件以增强视觉反馈
                            option.addEventListener('mousedown', function() {
                                // 如果已报名或已满员，则不添加点击效果
                                if (this.classList.contains('registered') || this.classList.contains('full')) {
                                    return;
                                }
                                
                                this.classList.add('session-option-clicked');
                            });
                            
                            option.addEventListener('mouseup', function() {
                                this.classList.remove('session-option-clicked');
                            });
                            
                            option.addEventListener('mouseleave', function() {
                                this.classList.remove('session-option-clicked');
                            });
                        }
                    });
                    
                    // 为每个模特的报名按钮添加点击事件
                    registerModelButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // 获取当前模特的ID
                            const modelCard = this.closest('.model-detail-card');
                            const modelId = modelCard.id.replace('model-detail-', '');
                            
                            // 检查是否已选择场次
                            if (!selectedSession[modelId]) {
                                alert('请先选择一个场次');
                                return;
                            }
                            
                            // 检查场次是否还有名额
                            const sessionOption = modelCard.querySelector('.session-option.selected');
                            const spotsText = sessionOption.querySelector('.session-spots').textContent;
                            const spotsMatch = spotsText.match(/(\d+)\/(\d+)/);
                            if (spotsMatch) {
                                const remaining = parseInt(spotsMatch[1]);
                                if (remaining <= 0) {
                                    alert('该场次名额已满');
                                    return;
                                }
                            }
                            
                            // 设置模态框信息
                            document.getElementById('modal-session-title').textContent = selectedSession[modelId].title;
                            document.getElementById('modal-model-name').textContent = this.getAttribute('data-model-name');
                            document.getElementById('modal-session-time').textContent = selectedSession[modelId].time;
                            
                            // 设置费用信息
                            let feeText = '¥' + selectedSession[modelId].fee;
                            if (selectedSession[modelId].vip_fee) {
                                feeText += ' / VIP: ¥' + selectedSession[modelId].vip_fee;
                            }
                            document.getElementById('modal-fee').textContent = feeText;
                            
                            // 显示确认模态框
                            selectedSessionId = selectedSession[modelId].id;
                            const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
                            modal.show();
                        });
                    });
                    
                    // 确认报名按钮事件处理
                    document.getElementById('confirm-registration').addEventListener('click', function() {
                        if (!selectedSessionId) return;
                        
                        // 添加加载状态以提供用户反馈
                        const originalText = this.innerHTML;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
                        this.disabled = true;
                        
                        // 发送报名请求
                        fetch(`/event/register/${selectedSessionId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 检查是否需要重定向到支付页面
                                if (data.redirect_to_payment && data.payment_url) {
                                    // 重定向到支付页面
                                    window.location.href = data.payment_url;
                                } else {
                                    // 报名成功
                                    alert('报名成功！');
                                    // 关闭模态框
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('registrationModal'));
                                    modal.hide();
                                    // 可以选择刷新页面或更新剩余名额显示
                                    location.reload();
                                }
                            } else {
                                // 报名失败
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('报名请求失败，请稍后重试');
                        })
                        .finally(() => {
                            // 恢复按钮状态
                            this.innerHTML = originalText;
                            this.disabled = false;
                        });
                    });
                    
                    // 地图相关功能
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    const mapSection = document.getElementById('mapSection');
                    
                    {% if event.location_poi %}
                    if (toggleBtn && mapSection) {
                        toggleBtn.addEventListener('click', function() {
                            
                            mapSection.classList.toggle('d-none');
                            const isHidden = mapSection.classList.contains('d-none');
                            toggleBtn.innerHTML = isHidden ? 
                                '<i class="fas fa-map-marked-alt me-1"></i>查看地图' : 
                                '<i class="fas fa-times me-1"></i>隐藏地图';
                                
                            // 如果是第一次显示地图，则初始化地图
                            if (!isHidden && !mapSection.dataset.initialized) {
                                mapSection.dataset.initialized = "true";
                                setTimeout(function() {
                                    loadBaiduMap();
                                }, 100);
                            }
                        });
                    }
                    
                    // 显示POI详细信息
                    try {
                        const mapSection = document.getElementById('mapSection');
                        const poiDataStr = mapSection?.getAttribute('data-poi');
                        
                        let poiData;
                        if (poiDataStr && typeof poiDataStr === 'string' && poiDataStr.trim().length > 0) {
                            // 移除可能的首尾空格
                            let trimmedData = poiDataStr.trim();
                            
                            // 处理Unicode转义字符
                            trimmedData = trimmedData.replace(/\\u0022/g, '"')
                                                     .replace(/\\u003D/g, '=')
                                                     .replace(/\\u0026/g, '&')
                                                     .replace(/\\u003F/g, '?');
                            
                            // 检查是否已经是有效的JSON格式
                            if (trimmedData.startsWith('{') && trimmedData.endsWith('}')) {
                                poiData = JSON.parse(trimmedData);
                                
                            } else {console.error('POI数据格式不正确，不是有效的JSON对象格式');
                                poiData = null;
                            }
                        } else {
                            console.log('POI数据为空或无效');
                            poiData = null;
                        }
                        
                        const poiInfoDiv = document.getElementById('poi-info');
                        
                        if (poiData && poiInfoDiv) {
                            // 显示POI信息
                            let poiHtml = '<ul class="list-unstyled">';
                            poiHtml += `<li><strong>地址:</strong> ${poiData.address || '无'}</li>`;
                            if (poiData.phoneNumber) {
                                poiHtml += `<li><strong>电话:</strong> ${poiData.phoneNumber}</li>`;
                            }
                            if (poiData.postCode) {
                                poiHtml += `<li><strong>邮编:</strong> ${poiData.postCode}</li>`;
                            }
                            poiHtml += '</ul>';
                            
                            poiInfoDiv.innerHTML = poiHtml;
                        }
                    } catch (e) {
                        console.error('解析POI信息失败:', e);
                    }
                    {% endif %}
                });

                // 初始化地图
                function initEventMap() {
                    try {
                        const mapSection = document.getElementById('mapSection');
                        const poiDataStr = mapSection?.getAttribute('data-poi');
                        const mapContainer = document.getElementById("event-map");
                        
                        if (!mapContainer) {
                            console.error('地图容器未找到');
                            return;
                        }

                        // 清空容器内容（移除可能的错误消息）
                        mapContainer.innerHTML = '';
                        
                        let poiData;
                        try {
                            // 检查数据字符串是否有效
                            if (poiDataStr && typeof poiDataStr === 'string' && poiDataStr.trim().length > 0) {
                                // 移除可能的首尾空格
                                let trimmedData = poiDataStr.trim();
                                
                                // 处理Unicode转义字符
                                trimmedData = trimmedData.replace(/\\u0022/g, '"')
                                                         .replace(/\\u003D/g, '=')
                                                         .replace(/\\u0026/g, '&')
                                                         .replace(/\\u003F/g, '?');
                                
                                // 检查是否已经是有效的JSON格式
                                if (trimmedData.startsWith('{') && trimmedData.endsWith('}')) {
                                    poiData = JSON.parse(trimmedData);
                                
                                } else {
                                    
                                    poiData = null;
                                }
                            } else {
                                console.log('POI数据为空或无效');
                                poiData = null;
                            }
                        } catch (e) {
    
                            poiData = null;
                        }
                        
                        const map = new BMap.Map("event-map");
                        
                        if (poiData && poiData.point && poiData.point.lng && poiData.point.lat) {
                            // 使用POI数据设置地图
                            const point = new BMap.Point(poiData.point.lng, poiData.point.lat);
                            map.centerAndZoom(point, 16);
                            
                            // 添加标记
                            const marker = new BMap.Marker(point);
                            map.addOverlay(marker);
                            
                            // 添加信息窗口
                            const title = poiData.title || '位置';
                            const address = poiData.address || '';
                            const infoWindow = new BMap.InfoWindow(`<strong>${title}</strong><br>${address}`);
                            marker.addEventListener("click", function() {
                                this.openInfoWindow(infoWindow);
                            });
                            
                            // 立即打开信息窗口
                            marker.openInfoWindow(infoWindow);
                        } else {
                            // 如果没有POI数据，显示默认地图
                            const pointDefault = new BMap.Point(113.2644, 23.1291);  // 默认广州位置
                            map.centerAndZoom(pointDefault, 15);
                        }
                        
                        // 启用滚轮缩放
                        map.enableScrollWheelZoom(true);
                        
                    } catch (e) {
                        console.error('初始化地图失败:', e);
                        // 显示错误信息
                        const mapContainer = document.getElementById('event-map');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<div class="alert alert-warning">地图加载失败，请检查网络连接或稍后重试</div>';
                        }
                    }
                }

                // 延迟加载百度地图API
                function loadBaiduMap() {
                    // 检查是否已经加载了百度地图API
                    if (typeof BMap !== 'undefined') {
                        initEventMap();
                        return;
                    }
                    
                    // 确保referrer策略正确设置
                    let metaReferer = document.querySelector('meta[name="referrer"]');
                    if (metaReferer) {
                        metaReferer.content = 'origin';
                    } else {
                        metaReferer = document.createElement('meta');
                        metaReferer.name = 'referrer';
                        metaReferer.content = 'origin';
                        document.head.appendChild(metaReferer);
                    }
                    
                    // 使用Intersection Observer延迟加载地图
                    const mapContainer = document.getElementById('event-map');
                    if ('IntersectionObserver' in window) {
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    loadMapScript();
                                    observer.disconnect();
                                }
                            });
                        }, { threshold: 0.1 });
                        
                        observer.observe(mapContainer);
                    } else {
                        // 如果浏览器不支持IntersectionObserver，则立即加载
                        loadMapScript();
                    }
                }
                
                // 加载地图脚本
                function loadMapScript() {
                    const script = document.createElement('script');
                    script.src = 'https://api.map.baidu.com/api?v=3.0&ak=46xD48lIm4oyiWq1RaKyxhr2ZhkZiCWg&callback=initEventMap';
                    script.async = true;
                    script.defer = true;
                    script.onerror = function() {
                        const mapContainer = document.getElementById('event-map');
                        if (mapContainer) {
                            mapContainer.innerHTML = '<div class="alert alert-danger">地图加载失败，请检查网络连接</div>';
                        }
                    };
                    document.head.appendChild(script);
                }
                
                // 添加一个函数来检查页面是否完全加载
                function checkPageLoadComplete() {
                    // 检查关键元素是否已加载
                    const keyElements = [
                        '.event-card-header',
                        '.model-detail-card',
                        '#registrationModal'
                    ];
                    
                    let allLoaded = true;
                    for (const selector of keyElements) {
                        if (!document.querySelector(selector)) {
                            allLoaded = false;
                            break;
                        }
                    }
                    
                    // 如果所有关键元素都已加载，隐藏加载提示
                    const tip = document.getElementById('mobile-performance-tip');
                    if (allLoaded && tip) {
                        tip.style.display = 'none';
                    }
                }
                
                // 页面加载完成后检查
                document.addEventListener('DOMContentLoaded', function() {
                    checkPageLoadComplete();
                });
                
                // 添加一个延迟检查以确保所有内容都已加载
                window.addEventListener('load', function() {
                    setTimeout(checkPageLoadComplete, 1000);
                });
                </script>
            </div>
            
        </div>
    </div>
</div>

<script>
    // 将Django模板变量存储在DOM属性中
    document.addEventListener('DOMContentLoaded', function() {
        console.assert('shhh');
    });

</script>

<script>
// 动态更新徽章样式
document.addEventListener('DOMContentLoaded', function() {
    // 获取所有徽章元素
    const badges = document.querySelectorAll('.spots-badge');
    
    // 为每个徽章设置适当的样式类
    badges.forEach(badge => {
        const spots = parseInt(badge.textContent);
        badge.classList.remove('zero', 'low');
        
        if (spots === 0) {
            badge.classList.add('zero');
        } else if (spots < 3) {
            badge.classList.add('low');
        }
    });
});
</script>

<script>
// 为徽章添加一些额外的样式调整，使其更加美观
document.addEventListener('DOMContentLoaded', function() {
    // 为徽章添加一些额外的样式
    const style = document.createElement('style');
    style.textContent = `
        .spots-badge {
            transition: all 0.3s ease; /* 添加过渡效果 */
        }
        
        .spots-badge:hover {
            transform: scale(1.1); /* 鼠标悬停时稍微放大 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* 增强阴影效果 */
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}