{% extends 'minimal_base.html' %}
{% load static %}
{% load event_extras %}
{% block title %}我的活动{% endblock %}
{% block content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/event/my_events.css' %}">
<div class="container-fluid my-events-container p-0">
    <div class="card my-events-card">
        <div class="my-events-header">
            <div class="d-flex align-items-center justify-content-between">
                <a href="#" onclick="history.back(); return false;" class="text-white" style="font-size: 1.5rem;">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h2 class="mb-0 flex-grow-1 text-center"><i class="fas fa-calendar-alt me-2"></i>我的活动</h2>
                <div style="width: 36px;"></div> <!-- 占位元素，保持标题居中 -->
            </div>
        </div>
        
        <div class="container py-3">
            <!-- 主标签页 -->
            <ul class="nav nav-tabs" id="myEventsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="participated-tab" data-bs-toggle="tab" data-bs-target="#participated" type="button" role="tab">
                        我参与的活动
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hosted-tab" data-bs-toggle="tab" data-bs-target="#hosted" type="button" role="tab">
                        我发布的活动
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="myEventsTabContent">
                <!-- 我参与的活动 -->
                <div class="tab-pane fade show active" id="participated" role="tabpanel" aria-labelledby="participated-tab">
                    <div class="d-flex justify-content-between align-items-center my-3">
                        <!-- 隐藏式筛选按钮 -->
                        <div class="filter-dropdown">
                            <button class="filter-btn" id="participatedFilterToggle">
                                <i class="fas fa-filter me-1"></i>筛选
                            </button>
                            <div class="filter-options" id="participatedFilterOptions">
                                <button type="button" class="filter-option active" data-filter="all">全部</button>
                                <button type="button" class="filter-option" data-filter="ongoing">进行中</button>
                                <button type="button" class="filter-option" data-filter="ended">已结束</button>
                                <button type="button" class="filter-option" data-filter="upcoming">待开始</button>
                                <button type="button" class="filter-option" data-filter="pending-payment">待付款</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 活动卡片列表 -->
                    <div class="row" id="participated-events-container">
                        <!-- 参与的活动内容将通过懒加载动态插入 -->
                    </div>
                    
                    <!-- 加载更多提示 -->
                    <div id="participated-loading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                    
                    <!-- 没有更多内容提示 -->
                    <div id="participated-no-more" class="text-center py-3" style="display: none;">
                        <p class="text-muted">没有更多内容了</p>
                    </div>
                </div>
                
                <!-- 我发布的活动 -->
                <div class="tab-pane fade" id="hosted" role="tabpanel" aria-labelledby="hosted-tab">
                    <div class="d-flex justify-content-between align-items-center my-3">
                        <!-- 隐藏式筛选按钮 -->
                        <div class="filter-dropdown">
                            <button class="filter-btn" id="filterToggle">
                                <i class="fas fa-filter me-1"></i>筛选
                            </button>
                            <div class="filter-options" id="filterOptions">
                                <button type="button" class="filter-option active" data-filter="all">全部</button>
                                <button type="button" class="filter-option" data-filter="ongoing">进行中</button>
                                <button type="button" class="filter-option" data-filter="ended">已结束</button>
                                <button type="button" class="filter-option" data-filter="upcoming">待开始</button>
                            </div>
                        </div>
                        <a href="#" class="btn btn-primary" id="create-event-btn">
                            <i class="fas fa-plus me-1"></i>新建活动
                        </a>
                    </div>
                    
                    <!-- 活动卡片列表 -->
                    <div class="row" id="hosted-events-container">
                        <!-- 发布的活动内容将通过懒加载动态插入 -->
                    </div>
                    
                    <!-- 加载更多提示 -->
                    <div id="hosted-loading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                    
                    <!-- 没有更多内容提示 -->
                    <div id="hosted-no-more" class="text-center py-3" style="display: none;">
                        <p class="text-muted">没有更多内容了</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- 引入所有模态框 -->
    {% include 'event/modals/refund_modal.html' %}
    {% include 'event/modals/refund_rejected_modal.html' %}
    {% include 'event/modals/refund_info_modal.html' %}
    {% include 'event/modals/approve_refund_modal.html' %}
    {% include 'event/modals/reject_refund_modal.html' %}
    {% include 'event/modals/handle_refund_modal.html' %}
    {% include 'event/modals/refunded_info_modal.html' %}

<!-- JavaScript -->
<script>
    // 全局变量
    let currentRegistrationId = null;
    let currentPage = { participated: 0, hosted: 0 }; // 0 表示尚未加载
    let hasNextPage = { participated: true, hosted: true };
    let isLoading = { participated: false, hosted: false };
    
    // 页面加载完成后初始化所有功能
    document.addEventListener('DOMContentLoaded', function() {
        initFilterFunctionality();
        initEventCardClickHandlers();
        initActionButtonEventHandlers();
        initCreateEventButton();
        initLazyLoading();
        
        // 加载初始数据
        loadParticipatedEvents(1);
        loadHostedEvents(1);
    });
    
    // 初始化懒加载
    function initLazyLoading() {
        const participatedTab = document.getElementById('participated');
        const hostedTab = document.getElementById('hosted');
        
        // 监听滚动事件
        window.addEventListener('scroll', function() {
            // 检查当前激活的标签页
            if (participatedTab.classList.contains('active')) {
                // 我参与的活动标签页
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                    if (hasNextPage.participated && !isLoading.participated) {
                        loadParticipatedEvents(currentPage.participated + 1);
                    }
                }
            } else if (hostedTab.classList.contains('active')) {
                // 我发布的活动标签页
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                    if (hasNextPage.hosted && !isLoading.hosted) {
                        loadHostedEvents(currentPage.hosted + 1);
                    }
                }
            }
        });
        
        // 监听标签页切换
        document.getElementById('participated-tab').addEventListener('shown.bs.tab', function() {
            // 如果我参与的活动还没有加载过，加载第一页
            if (currentPage.participated === 0) {
                loadParticipatedEvents(1);
            }
        });
        
        document.getElementById('hosted-tab').addEventListener('shown.bs.tab', function() {
            // 如果我发布的活动还没有加载过，加载第一页
            if (currentPage.hosted === 0) {
                loadHostedEvents(1);
            }
        });
    }
    
    // 加载我参与的活动
    function loadParticipatedEvents(page) {
        if (!hasNextPage.participated || isLoading.participated) return;
        
        isLoading.participated = true;
        const loadingIndicator = document.getElementById('participated-loading');
        const noMoreIndicator = document.getElementById('participated-no-more');
        const container = document.getElementById('participated-events-container');
        
        loadingIndicator.style.display = 'block';
        noMoreIndicator.style.display = 'none';
        
        fetch(`{% url "event:my_events" %}?tab=participated&page=${page}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.tab === 'participated') {
                if (page === 1) {
                    container.innerHTML = data.html;
                } else {
                    container.innerHTML += data.html;
                }
                
                currentPage.participated = page;
                hasNextPage.participated = data.has_next;
                
                if (!data.has_next) {
                    noMoreIndicator.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error loading participated events:', error);
        })
        .finally(() => {
            isLoading.participated = false;
            loadingIndicator.style.display = 'none';
        });
    }
    
    // 加载我发布的活动
    function loadHostedEvents(page) {
        if (!hasNextPage.hosted || isLoading.hosted) return;
        
        isLoading.hosted = true;
        const loadingIndicator = document.getElementById('hosted-loading');
        const noMoreIndicator = document.getElementById('hosted-no-more');
        const container = document.getElementById('hosted-events-container');
        
        loadingIndicator.style.display = 'block';
        noMoreIndicator.style.display = 'none';
        
        fetch(`{% url "event:my_events" %}?tab=hosted&page=${page}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.tab === 'hosted') {
                if (page === 1) {
                    container.innerHTML = data.html;
                } else {
                    container.innerHTML += data.html;
                }
                
                currentPage.hosted = page;
                hasNextPage.hosted = data.has_next;
                
                if (!data.has_next) {
                    noMoreIndicator.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error loading hosted events:', error);
        })
        .finally(() => {
            isLoading.hosted = false;
            loadingIndicator.style.display = 'none';
        });
    }
    
    // 初始化新建活动按钮
    function initCreateEventButton() {
        const createEventBtn = document.getElementById('create-event-btn');
        if (createEventBtn) {
            createEventBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 发送 AJAX 请求检查用户权限
                fetch('{% url "event:create_event" %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success === false) {
                        // 显示权限不足的提醒
                        alert(data.message);
                    } else {
                        // 用户有权限，跳转到创建活动页面
                        window.location.href = '{% url "event:create_event" %}';
                    }
                })
                .catch(error => {
                    // 出现错误时也跳转到创建活动页面，让后端处理权限检查
                    window.location.href = '{% url "event:create_event" %}';
                });
            });
        }
    }
    
    // 初始化筛选功能
    function initFilterFunctionality() {
        // 我发布的活动筛选功能
        const filterToggle = document.getElementById('filterToggle');
        const filterOptions = document.getElementById('filterOptions');
        const filterButtons = document.querySelectorAll('#filterOptions .filter-option');
        const eventCards = document.querySelectorAll('#hosted-events-container .event-card');
        
        // 我参与的活动筛选功能
        const participatedFilterToggle = document.getElementById('participatedFilterToggle');
        const participatedFilterOptions = document.getElementById('participatedFilterOptions');
        const participatedFilterButtons = document.querySelectorAll('#participatedFilterOptions .filter-option');
        const participatedEventCards = document.querySelectorAll('#participated-events-container .event-card');
        
        // 我发布的活动筛选按钮点击事件
        if (filterToggle) {
            filterToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                filterOptions.classList.toggle('show');
            });
        }
        
        // 点击页面其他地方隐藏筛选选项
        document.addEventListener('click', function(e) {
            if (filterOptions && filterToggle && !filterToggle.contains(e.target)) {
                filterOptions.classList.remove('show');
            }
            if (participatedFilterOptions && participatedFilterToggle && !participatedFilterToggle.contains(e.target)) {
                participatedFilterOptions.classList.remove('show');
            }
        });
        
        // 我发布的活动筛选按钮点击事件
        if (filterButtons) {
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 更新活动按钮状态
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 获取筛选条件
                    const filter = this.getAttribute('data-filter');
                    
                    // 筛选活动卡片
                    eventCards.forEach(card => {
                        if (filter === 'all') {
                            card.style.display = 'block';
                        } else {
                            const status = card.getAttribute('data-status');
                            card.style.display = status === filter ? 'block' : 'none';
                        }
                    });
                    
                    // 隐藏选项
                    if (filterOptions) {
                        filterOptions.classList.remove('show');
                    }
                });
            });
        }
        
        // 我参与的活动筛选功能
        if (participatedFilterToggle) {
            participatedFilterToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                if (participatedFilterOptions) {
                    participatedFilterOptions.classList.toggle('show');
                }
            });
        }
        
        // 参与活动筛选按钮点击事件
        if (participatedFilterButtons) {
            participatedFilterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 更新活动按钮状态
                    participatedFilterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 获取筛选条件
                    const filter = this.getAttribute('data-filter');
                    
                    // 筛选活动卡片
                    participatedEventCards.forEach(card => {
                        if (filter === 'all') {
                            card.style.display = 'block';
                        } else if (filter === 'pending-payment') {
                            // 检查是否有待付款标记
                            const isPendingPayment = card.getAttribute('data-pending-payment') === 'true';
                            card.style.display = isPendingPayment ? 'block' : 'none';
                        } else {
                            const status = card.getAttribute('data-status');
                            card.style.display = status === filter ? 'block' : 'none';
                        }
                    });
                    
                    // 隐藏选项
                    if (participatedFilterOptions) {
                        participatedFilterOptions.classList.remove('show');
                    }
                });
            });
        }
    }
    
    // 初始化活动卡片点击处理
    function initEventCardClickHandlers() {
        // 使用事件委托处理卡片点击
        document.addEventListener('click', function(e) {
            const eventCard = e.target.closest('.event-card');
            if (eventCard && !e.target.closest('.event-actions')) {
                const url = eventCard.getAttribute('data-href');
                if (url) {
                    window.location.href = url;
                }
            }
        });
    }
    
    // 初始化操作按钮事件处理
    function initActionButtonEventHandlers() {
        // 使用事件委托处理所有操作按钮事件
        document.addEventListener('click', function(e) {
            const target = e.target;
            
            // 处理编辑按钮点击事件
            if (target.closest('.btn-edit-disabled')) {
                e.preventDefault();
                e.stopPropagation();
                showCannotEditTooltip(target.closest('.btn-edit-disabled'));
                return;
            }
            
            // 处理报名名单按钮点击事件
            if (target.closest('.event-registration-link')) {
                e.stopPropagation();
                const link = target.closest('.event-registration-link');
                window.location.href = link.getAttribute('href');
                return;
            }
            
            // 处理处理退款按钮点击事件
            if (target.closest('.btn-handle-refund')) {
                e.stopPropagation();
                handleProcessRefund(target.closest('.btn-handle-refund'));
                return;
            }
            
            // 处理退款按钮点击事件
            if (target.closest('.refund-btn')) {
                e.stopPropagation();
                handleRefund(target.closest('.refund-btn'));
                return;
            }
            
            // 处理退款失败按钮点击事件
            if (target.closest('.refund-rejected-btn')) {
                e.stopPropagation();
                // 设置当前注册ID
                const button = target.closest('.refund-rejected-btn');
                currentRegistrationId = button.getAttribute('data-registration-id');
                showRefundRejectedModal();
                return;
            }
            
            // 处理退款审核中按钮点击事件
            if (target.closest('.refund-pending-btn')) {
                e.stopPropagation();
                showRefundPendingInfo();
                return;
            }
            
            // 处理已退款按钮点击事件
            if (target.closest('.btn-refunded')) {
                e.stopPropagation();
                showRefundedInfoModal();
                return;
            }
        });
        
        // 处理同意退款按钮点击事件
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-approve-refund')) {
                e.stopPropagation();
                const refundId = e.target.getAttribute('data-refund-id');
                showApproveConfirmModal(refundId);
            }
        });
        
        // 处理拒绝退款按钮点击事件
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-reject-refund')) {
                e.stopPropagation();
                const refundId = e.target.getAttribute('data-refund-id');
                showRejectReasonModal(refundId);
            }
        });
    }
    
    // 显示无法编辑提示
    function showCannotEditTooltip(button) {
        // 使用按钮上的title属性作为提示信息
        const title = button.getAttribute('title') || '无法执行此操作';
        
        // 使用Bootstrap Tooltip显示提示信息
        const tooltip = new bootstrap.Tooltip(button, {
            title: title,
            placement: 'top',
            trigger: 'manual'
        });
        
        // 显示tooltip
        tooltip.show();
        
        // 2秒后自动隐藏tooltip
        setTimeout(() => {
            if (document.body.contains(button)) {
                tooltip.hide();
                tooltip.dispose();
            }
        }, 2000);
    }
    
    // 导航到活动详情页面
    function navigateToEvent(element) {
        const href = element.getAttribute('data-href');
        if (href) {
            window.location.href = href;
        }
    }
    
    // 显示退款审核中信息
    function showRefundPendingInfo() {
        const modalBody = document.querySelector('#refundInfoModal .modal-body');
        modalBody.innerHTML = `
            <div class="text-center">
                <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                <h5>退款申请审核中</h5>
                <p class="text-muted">您的退款申请正在审核中，请耐心等待。</p>
            </div>
        `;
        const refundInfoModal = new bootstrap.Modal(document.getElementById('refundInfoModal'));
        refundInfoModal.show();
    }
    
    // 显示退款被拒绝信息
    function showRefundRejectedInfo() {
        const refundInfoModal = document.getElementById('refundInfoModal');
        if (refundInfoModal) {
            refundInfoModal.querySelector('.modal-body').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>退款申请被拒绝</h5>
                    <p>您的退款申请已被活动组织者拒绝。</p>
                    <div id="rejectedReason">
                        <p><strong>拒绝原因：</strong><span id="rejectedReasonText">未提供具体原因</span></p>
                    </div>
                    <p>如有疑问，请联系活动组织者了解详情。</p>
                </div>
            `;
            const modal = new bootstrap.Modal(refundInfoModal);
            modal.show();
        }
    }
    
    // 处理退款操作
    function handleRefund(button) {
        const canRefund = button.getAttribute('data-can-refund') === 'true';
        const eventTitle = button.getAttribute('data-event-title');
        const eventTime = button.getAttribute('data-event-time');
        const registrationId = button.getAttribute('data-registration-id');
        
        if (canRefund) {
            // 可以退款，显示确认模态框
            document.getElementById('modalEventTitle').textContent = eventTitle;
            document.getElementById('modalEventTime').textContent = eventTime;
            currentRegistrationId = registrationId;
            const refundModal = new bootstrap.Modal(document.getElementById('refundModal'));
            refundModal.show();
        } else {
            // 不可退款，显示提示信息
            alert('根据退款规则，当前无法申请退款：\n活动开始前不足24小时无法退款');
        }
    }
    
    // 确认退款申请
    function confirmRefund() {
        // 获取必要的元素
        const refundReason = document.getElementById('refundReason');
        const refundModalElement = document.getElementById('refundModal');
        const refundModal = bootstrap.Modal.getInstance(refundModalElement) || new bootstrap.Modal(refundModalElement);
        
        if (!currentRegistrationId) {
            alert('活动信息错误，请重新尝试');
            return;
        }
        
        if (!refundReason.value.trim()) {
            alert('请输入退款原因');
            return;
        }
        
        // 获取CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 发送退款申请请求
        fetch(`/event/request_refund/${currentRegistrationId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'reason': refundReason.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('退款申请已提交，请等待处理。');
                refundModal.hide();
                // 刷新页面更新UI状态
                location.reload();
            } else {
                alert('提交失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('提交失败，请稍后重试');
        });
    }
    
    // 显示退款失败详情模态框
    function showRefundRejectedModal() {
        const refundRejectedModalElement = document.getElementById('refundRejectedModal');
        const refundRejectedModal = bootstrap.Modal.getInstance(refundRejectedModalElement) || new bootstrap.Modal(refundRejectedModalElement);
        refundRejectedModal.show();
        
        // 清空之前输入的内容
        const newRefundReason = document.getElementById('newRefundReason');
        if (newRefundReason) {
            newRefundReason.value = '';
        }
        
        // 绑定重新申请退款按钮事件
        const reapplyRefundBtn = document.getElementById('reapplyRefundBtn');
        if (reapplyRefundBtn) {
            reapplyRefundBtn.onclick = function() {
                reapplyRefund();
            };
        }
    }
    
    // 重新申请退款
    function reapplyRefund() {
        const newRefundReason = document.getElementById('newRefundReason');
        if (!newRefundReason) {
            alert('页面元素错误，请刷新页面后重试');
            return;
        }
        
        if (!newRefundReason.value.trim()) {
            alert('请输入退款原因');
            return;
        }
        
        // 获取CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 发送退款申请请求
        fetch(`/event/request_refund/${currentRegistrationId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'reason': newRefundReason.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('重新申请退款已提交，请等待处理。');
                // 关闭模态框
                const refundRejectedModalElement = document.getElementById('refundRejectedModal');
                const refundRejectedModal = bootstrap.Modal.getInstance(refundRejectedModalElement);
                if (refundRejectedModal) {
                    refundRejectedModal.hide();
                }
                // 刷新页面更新UI状态
                location.reload();
            } else {
                alert('提交失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('提交失败，请稍后重试');
        });
    }
    
    // 显示已退款信息模态框
    function showRefundedInfoModal() {
        const refundedInfoModalElement = document.getElementById('refundedInfoModal');
        const refundedInfoModal = bootstrap.Modal.getInstance(refundedInfoModalElement) || new bootstrap.Modal(refundedInfoModalElement);
        refundedInfoModal.show();
    }
    
    // 处理退款按钮点击事件
    function handleProcessRefund(element) {
        const eventId = element.getAttribute('data-event-id');
        const eventTitle = element.closest('.event-card').querySelector('.event-title').textContent;
        
        // 设置模态框标题
        document.getElementById('modalEventTitleForRefund').textContent = eventTitle;
        
        // 检查是否有待处理的退款申请
        const refundBadge = element.querySelector('.refund-badge');
        const pendingCount = refundBadge ? parseInt(refundBadge.textContent || '0') : 0;
        
        // 如果没有退款申请，显示提示信息
        if (pendingCount === 0) {
            // 使用Bootstrap Tooltip显示提示信息，避免破坏布局
            const tooltip = new bootstrap.Tooltip(element, {
                title: '暂无退款申请',
                placement: 'top',
                trigger: 'manual'
            });
            
            // 显示tooltip
            tooltip.show();
            
            // 2秒后自动隐藏tooltip
            setTimeout(() => {
                if (document.body.contains(element)) {
                    tooltip.hide();
                    tooltip.dispose();
                }
            }, 2000);
            
            // 点击其他位置隐藏tooltip
            const hideTooltip = (event) => {
                if (!element.contains(event.target)) {
                    if (document.body.contains(element)) {
                        tooltip.hide();
                        tooltip.dispose();
                    }
                    document.removeEventListener('click', hideTooltip);
                }
            };
            
            document.addEventListener('click', hideTooltip);
            
            return;
        }
        
        // 显示加载信息到模态框
        const refundRequestsTable = document.getElementById('refundRequestsTable');
        refundRequestsTable.innerHTML = '<tr><td colspan="6" class="text-center">正在加载退款申请...</td></tr>';
        
        // 显示模态框
        const handleRefundModalElement = document.getElementById('handleRefundModal');
        const handleRefundModal = bootstrap.Modal.getInstance(handleRefundModalElement) || new bootstrap.Modal(handleRefundModalElement);
        // 保存当前活动ID到模态框元素上
        handleRefundModalElement.setAttribute('data-current-event-id', eventId);
        handleRefundModal.show();
        
        // 加载退款申请数据
        loadRefundRequestsForEvent(eventId);
    }

    // 加载活动退款申请数据
    function loadRefundRequestsForEvent(eventId) {
        // 通过AJAX从服务器获取退款申请数据
        fetch(`/event/pending_refunds/?format=json`)
        .then(response => response.json())
        .then(data => {
            const refundRequestsTable = document.getElementById('refundRequestsTable');
            
            if (data.success) {
                let html = '';
                let hasRequests = false;
                
                data.refund_requests.forEach(request => {
                    // 只显示当前活动的退款申请
                    if (request.event_id == eventId) {
                        hasRequests = true;
                        // 根据退款规则显示退款金额
                        let refundText = '';
                        if (request.refund_percentage === 100) {
                            refundText = `¥${request.amount} (全额退款)`;
                        } else if (request.refund_percentage === 50) {
                            refundText = `¥${request.amount} (50%退款)`;
                        } else {
                            refundText = `¥${request.amount}`;
                        }
                        
                        html += `
                            <tr>
                                <td>${request.user_name}</td>
                                <td>${request.model_name} - ${request.session_title}</td>
                                <td>${request.created_at}</td>
                                <td>${refundText}</td>
                                <td>${request.reason}</td>
                                <td>
                                    <button class="btn btn-approve-refund btn-success me-1" data-refund-id="${request.id}">同意</button>
                                    <button class="btn btn-reject-refund btn-danger" data-refund-id="${request.id}">拒绝</button>
                                </td>
                            </tr>
                        `;
                    }
                });
                
                if (hasRequests) {
                    refundRequestsTable.innerHTML = html;
                } else {
                    refundRequestsTable.innerHTML = '<tr><td colspan="6" class="text-center">暂无退款申请</td></tr>';
                }
            } else {
                refundRequestsTable.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败: ' + data.message + '</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const refundRequestsTable = document.getElementById('refundRequestsTable');
            refundRequestsTable.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败，请稍后重试</td></tr>';
        });
    }
    
    // 处理退款申请
    function processRefund(refundId, action) {
        // 获取CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 通过AJAX向服务器发送处理请求
        fetch(`/event/process_refund/${refundId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'action': action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`退款申请已${action === 'approve' ? '批准' : '拒绝'}`);
                
                // 从表格中移除已处理的申请
                const row = document.querySelector(`button[data-refund-id="${refundId}"]`).closest('tr');
                if (row) {
                    row.remove();
                }
                
                // 更新退款按钮上的数字徽章
                const refundBadge = document.querySelector(`.btn-handle-refund[data-event-id] .refund-badge`);
                if (refundBadge) {
                    refundBadge.textContent = data.pending_count;
                    if (data.pending_count == 0) {
                        refundBadge.style.display = 'none';
                    }
                }
                
                // 如果没有退款申请了，关闭模态框
                if (data.pending_count == 0) {
                    const handleRefundModalElement = document.getElementById('handleRefundModal');
                    const handleRefundModal = bootstrap.Modal.getInstance(handleRefundModalElement);
                    if (handleRefundModal) {
                        handleRefundModal.hide();
                    }
                }
            } else {
                alert('处理失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('处理失败，请稍后重试');
        });
    }
    
    // 显示拒绝退款原因输入模态框
    function showRejectReasonModal(refundId) {
        // 获取当前行的数据
        const row = document.querySelector(`button[data-refund-id="${refundId}"]`).closest('tr');
        if (row) {
            // 提取行中的信息
            const userName = row.cells[0].textContent;
            const modelSession = row.cells[1].textContent;
            const requestDate = row.cells[2].textContent;
            const refundAmount = row.cells[3].textContent;
            const refundReason = row.cells[4].textContent;
            
            // 填充模态框中的详细信息
            document.getElementById('rejectUserName').textContent = userName;
            document.getElementById('rejectModelSession').textContent = modelSession;
            document.getElementById('rejectRequestDate').textContent = requestDate;
            document.getElementById('rejectRefundAmount').textContent = refundAmount;
            document.getElementById('rejectRefundReason').textContent = refundReason;
        }
        
        // 清空之前输入的内容
        document.getElementById('rejectReason').value = '';
        
        // 设置确认按钮的事件处理
        const confirmRejectBtn = document.getElementById('confirmRejectBtn');
        confirmRejectBtn.onclick = function() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                alert('请输入拒绝原因');
                return;
            }
            
            // 关闭拒绝原因输入模态框
            const rejectModal = bootstrap.Modal.getInstance(document.getElementById('rejectRefundModal'));
            rejectModal.hide();
            
            // 发送拒绝请求，包含拒绝原因
            rejectRefundWithReason(refundId, reason);
        };
        
        // 显示拒绝原因输入模态框
        const rejectModal = new bootstrap.Modal(document.getElementById('rejectRefundModal'));
        rejectModal.show();
    }
    
    // 显示同意退款确认模态框
    function showApproveConfirmModal(refundId) {
        // 获取当前行的数据
        const row = document.querySelector(`button[data-refund-id="${refundId}"]`).closest('tr');
        if (row) {
            // 提取行中的信息
            const userName = row.cells[0].textContent;
            const modelSession = row.cells[1].textContent;
            const requestDate = row.cells[2].textContent;
            const refundAmount = row.cells[3].textContent;
            const refundReason = row.cells[4].textContent;
            
            // 填充模态框中的详细信息
            document.getElementById('approveUserName').textContent = userName;
            document.getElementById('approveModelSession').textContent = modelSession;
            document.getElementById('approveRequestDate').textContent = requestDate;
            document.getElementById('approveRefundAmount').textContent = refundAmount;
            document.getElementById('approveRefundReason').textContent = refundReason;
        }
        
        // 设置确认按钮的事件处理
        const confirmApproveBtn = document.getElementById('confirmApproveBtn');
        confirmApproveBtn.onclick = function() {
            // 关闭确认模态框
            const approveModal = bootstrap.Modal.getInstance(document.getElementById('approveRefundModal'));
            approveModal.hide();
            
            // 发送同意请求
            processRefund(refundId, 'approve');
        };
        
        // 显示确认模态框
        const approveModal = new bootstrap.Modal(document.getElementById('approveRefundModal'));
        approveModal.show();
    }
    
    // 拒绝退款申请（带原因）
    function rejectRefundWithReason(refundId, reason) {
        // 获取CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 通过AJAX向服务器发送处理请求
        fetch(`/event/process_refund/${refundId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'action': 'reject',
                'reason': reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('退款申请已拒绝');
                
                // 从表格中移除已处理的申请
                const row = document.querySelector(`button[data-refund-id="${refundId}"]`).closest('tr');
                if (row) {
                    row.remove();
                }
                
                // 更新退款按钮上的数字徽章
                const refundBadge = document.querySelector(`.btn-handle-refund[data-event-id] .refund-badge`);
                if (refundBadge) {
                    refundBadge.textContent = data.pending_count;
                    if (data.pending_count == 0) {
                        refundBadge.style.display = 'none';
                    }
                }
                
                // 如果没有退款申请了，关闭模态框
                if (data.pending_count == 0) {
                    const handleRefundModalElement = document.getElementById('handleRefundModal');
                    const handleRefundModal = bootstrap.Modal.getInstance(handleRefundModalElement);
                    if (handleRefundModal) {
                        handleRefundModal.hide();
                    }
                }
            } else {
                alert('处理失败：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('处理失败，请稍后重试');
        });
    }
    
    // 窗口大小变化时的处理
    window.addEventListener('resize', function() {
        // 如果模态框是打开的，重新加载退款数据以适应新的窗口大小
        const handleRefundModalElement = document.getElementById('handleRefundModal');
        if (handleRefundModalElement.classList.contains('show')) {
            const eventId = handleRefundModalElement.getAttribute('data-current-event-id');
            if (eventId) {
                loadRefundRequestsForEvent(eventId);
            }
        }
    });

</script>
{% endblock %}