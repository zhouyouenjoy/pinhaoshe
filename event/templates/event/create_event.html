{% extends 'base.html' %}
{% load static %}
{% block title %}发布活动{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/event/create_event.css' %}">
{% endblock %}
{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card event-create-card shadow-lg">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-calendar-plus me-2"></i>发布摄影活动
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="event-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- 基本活动信息 -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-heading me-1"></i>{{ form.title.label }}
                            </label>
                            {{ form.title }}
                            {% if form.title.help_text %}
                                <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                                <div class="text-danger">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.event_time.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-clock me-1"></i>{{ form.event_time.label }}
                            </label>
                            {{ form.event_time }}
                            {% if form.event_time.help_text %}
                                <div class="form-text">{{ form.event_time.help_text }}</div>
                            {% endif %}
                            {% if form.event_time.errors %}
                                <div class="text-danger">{{ form.event_time.errors }}</div>
                            {% endif %}
                        </div>
                        <!-- 活动场地  及其图标-->
                        <div class="mb-4">
                            <label for="{{ form.location.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ form.location.label }}
                            </label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button" id="user-select-button">
                                    <i class="fas fa-search-location"></i>
                                </button>
                                {{ form.location }}
                                <button class="btn btn-outline-secondary map-btn" type="button" id="map-button">
                                    <i class="fas fa-map-marked-alt"></i>
                                </button>
                            </div>
                            {{ form.location_poi }}  <!-- 添加隐藏字段 -->
                            {% if form.location.help_text %}
                                <div class="form-text">{{ form.location.help_text }}</div>
                            {% endif %}
                            {% if form.location.errors %}
                                <div class="text-danger">{{ form.location.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-align-left me-1"></i>{{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.help_text %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                            {% endif %}
                            {% if form.description.errors %}
                                <div class="text-danger">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- 模特信息 -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="fas fa-user me-1"></i>模特信息
                                </label>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="add-model">
                                    <i class="fas fa-plus me-1"></i>添加模特
                                </button>
                            </div>
                            
                            <div id="models-container">
                                <!-- 模特表单将通过JavaScript动态添加 -->
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'event:event_list' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-1"></i>取消
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-paper-plane me-1"></i>发布活动
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 地图模态框 -->
<div class="modal fade" id="map-modal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">搜索选择地点并点击确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map-container">
                    {% include 'event/map_modal_content.html' %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-location">确认</button>
            </div>
        </div>
    </div>
</div>
<!-- 用户选择模态框 -->
<div class="modal fade" id="userSuggestionModal" tabindex="-1" aria-labelledby="userSuggestionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userSuggestionModalLabel">尝试进行搜索，若搜索不到可反馈管理员补充信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="userSearch" class="form-control" placeholder="搜索摄影基地...">
                </div>
                <div id="userList" class="user-list">
                    <!-- 用户列表将通过JavaScript动态加载 -->
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-warehouse fa-2x mb-2"></i>
                        <p>输入摄影基地名称搜索</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentInput = null;
        let currentType = null;
        let modelCount = 0;
        let sessionCounts = {}; // 记录每个模特的场次数量
        
        // 绑定地图按钮点击事件
        document.getElementById('map-button').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('map-modal'));
            modal.show();
            
            // 延迟加载地图，确保模态框完全显示
            setTimeout(function() {
                loadMap();
            }, 500);
        });
        
        // 绑定用户选择按钮点击事件
        document.getElementById('user-select-button').addEventListener('click', function() {
            currentInput = document.querySelector('[name="location"]');
            const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
            modal.show();
            document.getElementById('userSearch').value = '';
            document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-building fa-2x mb-2"></i><p>请输入场地名称进行搜索</p></div>';
            document.getElementById('userSearch').focus();
        });
        
        // 加载地图功能
        function loadMap() {
            // 如果地图容器不存在或已经加载过地图，则直接返回
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer || mapContainer.dataset.loaded === 'true') {
                console.log('地图已加载或容器不存在');
                return;
            }
            
            // 标记地图已加载
            mapContainer.dataset.loaded = 'true';
            
            // 直接初始化地图
            setTimeout(() => {
                if (window.initBaiduMap && typeof window.initBaiduMap === 'function') {
                    window.initBaiduMap('{{ak}}');
                } else {
                    console.error('地图初始化函数未定义');
                }
            }, 300);
        }
        
        // 确认位置按钮事件
        document.getElementById('confirm-location').addEventListener('click', function() {
            // 获取搜索结果
            if (window.mapSearchResult && window.mapSearchResult.title) {
                // 将选中的位置填入活动场地输入框
                document.querySelector('[name="location"]').value = window.mapSearchResult.title;
                // 将完整的POI信息保存到隐藏字段
                document.querySelector('[name="location_poi"]').value = JSON.stringify(window.mapSearchResult);
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('map-modal')).hide();
            } else {
                alert('请先在地图上搜索并选择一个位置');
            }
        });
        
        // 绑定搜索按钮点击事件
        document.querySelectorAll('.user-suggestion-btn').forEach(button => {
            button.addEventListener('click', function() {
                currentInput = this.closest('.input-group').querySelector('input');
                currentType = this.getAttribute('data-type');
                const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
                modal.show();
                document.getElementById('userSearch').value = '';
                document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
                document.getElementById('userSearch').focus();
            });
        });
        
        // 搜索用户
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.trim();
            if (searchTerm.length > 0) {
                loadUsers(searchTerm);
            } else {
                document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
            }
        });
        
        // 加载用户列表
        function loadUsers(search = '') {
            // 发送AJAX请求获取用户列表
            fetch(`{% url 'photos:search_users' %}?q=${encodeURIComponent(search)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                
                if (data.users.length > 0) {
                    data.users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item d-flex align-items-center';
                        userElement.dataset.userId = user.id;
                        
                        // 创建用户头像
                        let avatarHtml = '';
                        if (user.avatar) {
                            avatarHtml = `<img src="${user.avatar}" class="user-avatar" alt="${user.username}">`;
                        } else {
                            // 使用用户名首字母作为默认头像
                            avatarHtml = `<div class="user-avatar d-flex align-items-center justify-content-center bg-primary text-white me-2" style="width: 40px; height: 40px; border-radius: 50%;">${user.username.charAt(0).toUpperCase()}</div>`;
                        }
                        
                        userElement.innerHTML = `
                            ${avatarHtml}
                            <div class="flex-grow-1">
                                <div class="fw-bold">${user.username}</div>
                            </div>
                        `;
                        
                        // 点击用户项时插入用户名到输入框
                        userElement.addEventListener('click', function() {
                            insertUser(user);
                            bootstrap.Modal.getInstance(document.getElementById('userSuggestionModal')).hide();
                        });
                        
                        // 双击用户项时跳转到用户个人空间
                        userElement.addEventListener('dblclick', function() {
                            window.open(`/user/${user.id}/space/`, '_blank');
                        });
                        
                        userList.appendChild(userElement);
                    });
                } else {
                    userList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-warehouse fa-2x mb-2"></i><p>未找到相关摄影基地</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('userList').innerHTML = '<div class="text-center text-danger py-3"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>加载摄影基地时出错</p></div>';
            });
        }
        
        // 插入摄影基地到输入框
        function insertUser(user) {
            if (!currentInput) return;
            
            // 检查当前是哪个输入框
            if (currentInput.name === 'location') {
                // 如果是活动地点输入框，直接设置值
                currentInput.value = user.username;
            } else {
                // 如果是模特姓名输入框，使用原来的逻辑
                const currentValue = currentInput.value;
                const usernames = currentValue ? currentValue.split(',').map(name => name.trim()) : [];
                
                // 检查摄影基地是否已存在
                if (!usernames.includes(user.username)) {
                    usernames.push(user.username);
                    currentInput.value = usernames.filter(name => name.length > 0).join(', ');
                }
            }
            
            // 聚焦到输入框
            currentInput.focus();
        }
        
        // 图片预览功能
        function setupImagePreview() {
            document.querySelectorAll('input[name$="model_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_model_images', '_model-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
            
            document.querySelectorAll('input[name$="outfit_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_outfit_images', '_outfit-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
            
            document.querySelectorAll('input[name$="scene_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_scene_images', '_scene-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
        }
        
        function previewImages(input, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (input.files) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'image-preview';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        
                        const removeBtn = document.createElement('span');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.addEventListener('click', function() {
                            previewWrapper.remove();
                            // 从文件输入中移除该文件
                            removeFileFromInput(input, file);
                        });
                        
                        previewWrapper.appendChild(img);
                        previewWrapper.appendChild(removeBtn);
                        previewContainer.appendChild(previewWrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }
        
        function removeFileFromInput(input, fileToRemove) {
            const dt = new DataTransfer();
            const files = input.files;
            
            for (let i = 0; i < files.length; i++) {
                if (files[i] !== fileToRemove) {
                    dt.items.add(files[i]);
                }
            }
            
            input.files = dt.files;
        }
        
        // 模特管理功能
        document.getElementById('add-model').addEventListener('click', function() {
            addModel();
        });
        
        function addModel() {
            modelCount++;
            const modelId = 'model-' + modelCount;
            sessionCounts[modelId] = 0; // 初始化该模特的场次计数
            
            const modelHtml = `
                <div class="model-item" id="${modelId}">
                    <div class="model-header">
                        <h6 class="model-title">模特 ${modelCount}</h6>
                        <div class="remove-model" data-model-id="${modelId}">&times;</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="row align-items-center">  
                                <div class="col-4"> 
                                    <label class="form-label">模特姓名</label>
                                </div>
                                <div class="col-8"> 
                                    <div class="input-group">
                                        <input type="text" class="form-control model-name-input" 
                                            name="model_name_${modelCount}" 
                                            placeholder="模特姓名" required>
                                        <button class="btn btn-outline-secondary user-suggestion-btn" type="button" data-type="model">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row align-items-center">  
                                <div class="col-4"> 
                                    <label class="form-label">价格:元/场</label>
                                </div>
                                <div class="col-8"> 
                                    <input type="number" class="form-control model-fee-input" 
                                        name="model_fee_${modelCount}" 
                                        placeholder="元/场" step="0.01" required>
                                </div>
                            </div>  
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">模特照片</label>
                        <input type="file" class="form-control model-images-input" 
                               name="model_images_${modelCount}" 
                               id="model_images_${modelCount}" 
                               multiple>
                        <div id="${modelId}_model-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">服装道具</label>
                        <input type="file" class="form-control outfit-images-input" 
                               name="outfit_images_${modelCount}" 
                               id="outfit_images_${modelCount}" 
                               multiple>
                        <div id="${modelId}_outfit-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">拍摄场景</label>
                        <input type="file" class="form-control scene-images-input" 
                               name="scene_images_${modelCount}" 
                               id="scene_images_${modelCount}" 
                               multiple>
                        <div id="${modelId}_scene-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <!-- 场次信息 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label mb-0">活动场次</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-session-btn" data-model-id="${modelId}">
                                <i class="fas fa-plus me-1"></i>添加场次
                            </button>
                        </div>
                        
                        <div class="sessions-container" id="${modelId}-sessions">
                            <!-- 场次表单将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('models-container');
            container.insertAdjacentHTML('beforeend', modelHtml);
            
            // 绑定删除模特事件
            document.querySelector(`.remove-model[data-model-id="${modelId}"]`).addEventListener('click', function() {
                removeModel(this.getAttribute('data-model-id'));
            });
            
            // 绑定添加场次事件
            document.querySelector(`.add-session-btn[data-model-id="${modelId}"]`).addEventListener('click', function() {
                addSession(modelId);
            });
            
            // 为新添加的图片输入框设置预览功能
            setupImagePreview();
            
            // 为新添加的用户搜索按钮绑定事件
            document.querySelectorAll('.user-suggestion-btn').forEach(button => {
                // 只为新添加的按钮绑定事件，避免重复绑定
                if (!button.hasAttribute('data-bound')) {
                    button.setAttribute('data-bound', 'true');
                    button.addEventListener('click', function() {
                        currentInput = this.closest('.input-group').querySelector('input');
                        currentType = this.getAttribute('data-type');
                        const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
                        modal.show();
                        document.getElementById('userSearch').value = '';
                        document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
                        document.getElementById('userSearch').focus();
                    });
                }
            });

            // 初始化添加一个场次
            addSession(modelId);
        }
        
        function removeModel(modelId) {
            const modelElement = document.getElementById(modelId);
            if (modelElement) {
                modelElement.remove();
                delete sessionCounts[modelId];
            }
        }
        
        // 场次管理功能
        function addSession(modelId) {
            sessionCounts[modelId] = (sessionCounts[modelId] || 0) + 1;
            const sessionId = modelId + '-session-' + sessionCounts[modelId];
            const modelIndex = modelId.split('-')[1]; // 获取模特索引
            const sessionIndex = sessionCounts[modelId]; // 获取场次索引
            
            const sessionHtml = `
                <div class="session-item" id="${sessionId}">
                    <div class="session-header">
                        <h6 class="session-title">场次 ${sessionIndex}</h6>
                        <div class="remove-session" data-session-id="${sessionId}">&times;</div>
                    </div>
                    <div class="time-inputs">
                        <label>时间:</label>
                        <input type="time" class="form-control start-time-input" 
                               name="start_time_${modelIndex}_${sessionIndex}" 
                               placeholder="开始时间" required>
                        <span>-</span>
                        <input type="time" class="form-control end-time-input" 
                               name="end_time_${modelIndex}_${sessionIndex}" 
                               placeholder="结束时间" required>
                    </div>
                </div>
            `;
            
            const container = document.getElementById(modelId + '-sessions');
            container.insertAdjacentHTML('beforeend', sessionHtml);
            
            // 绑定删除场次事件
            document.querySelector(`.remove-session[data-session-id="${sessionId}"]`).addEventListener('click', function() {
                removeSession(this.getAttribute('data-session-id'));
            });
        }
        
        function removeSession(sessionId) {
            const sessionElement = document.getElementById(sessionId);
            if (sessionElement) {
                sessionElement.remove();
            }
        }
        
        // 初始化添加一个模特
        addModel();
    });
</script>
{% endblock %}