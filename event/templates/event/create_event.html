{% extends 'base.html' %}
{% load static %}
{% block title %}发布活动{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/event/create_event.css' %}">
{% endblock %}
{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card event-create-card shadow-lg">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h3 class="mb-0 text-center">
                        <i class="fas fa-calendar-plus me-2"></i>发布摄影活动
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="event-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- 基本活动信息 -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-heading me-1"></i>{{ form.title.label }}
                            </label>
                            {{ form.title }}
                            {% if form.title.help_text %}
                                <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                                <div class="text-danger">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.event_time.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-clock me-1"></i>{{ form.event_time.label }}
                            </label>
                            {{ form.event_time }}
                            {% if form.event_time.help_text %}
                                <div class="form-text">{{ form.event_time.help_text }}</div>
                            {% endif %}
                            {% if form.event_time.errors %}
                                <div class="text-danger">{{ form.event_time.errors }}</div>
                            {% endif %}
                        </div>
                        <!-- 活动场地 -->
                        <div class="mb-4">
                            <label for="{{ form.location.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ form.location.label }}
                            </label>
                            <div class="input-group">
                                {{ form.location }}
                                <button class="btn btn-outline-secondary map-btn" type="button" id="map-button">
                                    <i class="fas fa-map-marked-alt"></i>
                                </button>
                            </div>
                            {{ form.location_poi }}  <!-- 添加隐藏字段 -->
                            {% if form.location.help_text %}
                                <div class="form-text">{{ form.location.help_text }}</div>
                            {% endif %}
                            {% if form.location.errors %}
                                <div class="text-danger">{{ form.location.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- 摄影场地 -->
                        <div class="mb-4">
                            <label for="location_user_input" class="form-label fw-bold">
                                <i class="fas fa-map-pin me-1"></i>摄影场地
                            </label>
                            <div class="input-group">
                                <input type="text" id="location_user_input" class="form-control" placeholder="请搜索添加（非必填）" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="user-select-button">
                                    <i class="fas fa-search-location"></i>
                                </button>
                            </div>
                            {{ form.location_user }}
                            {% if form.location_user.help_text %}
                                <div class="form-text">{{ form.location_user.help_text }}</div>
                            {% endif %}
                            {% if form.location_user.errors %}
                                <div class="text-danger">{{ form.location_user.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-align-left me-1"></i>{{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.help_text %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                            {% endif %}
                            {% if form.description.errors %}
                                <div class="text-danger">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- 模特信息 -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0">
                                    <i class="fas fa-user me-1"></i>模特信息
                                </label>
                            </div>
                            
                            <div id="models-container">
                                <!-- 模特表单将通过JavaScript动态添加 -->
                            </div>
                            
                            <div class="d-flex justify-content-center mt-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="add-model">
                                    <i class="fas fa-plus me-1"></i>添加模特
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'event:event_list' %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-1"></i>取消
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-paper-plane me-1"></i>发布活动
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 地图模态框 -->
<div class="modal fade" id="map-modal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">搜索选择地点并点击确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map-container">
                    {% include 'event/map_modal_content.html' %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-location">确认</button>
            </div>
        </div>
    </div>
</div>
<!-- 用户选择模态框 -->
<div class="modal fade" id="userSuggestionModal" tabindex="-1" aria-labelledby="userSuggestionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userSuggestionModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="userSearch" class="form-control" placeholder="尝试搜索，搜索不到可反馈管理员补充信息">
                </div>
                <div id="userList" class="user-list">
                    <!-- 用户列表将通过JavaScript动态加载 -->
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-warehouse fa-2x mb-2"></i>
                        <p>输入摄影基地名称搜索</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentInput = null;
        let currentType = null;
        let modelCount = 0;
        let sessionCounts = {}; // 记录每个模特的场次数量
        let selectedUsers = {}; // 存储选中用户的ID
        let modelElements = []; // 存储模特元素以维护正确的编号
        
        // 绑定表单提交事件
        const eventForm = document.getElementById('event-form');
        eventForm.addEventListener('submit', function(e) {
            // 检查活动时间是否已填写且有效
            const eventTimeInput = document.querySelector('[name="event_time"]');
            if (eventTimeInput) {
                const eventTimeValue = eventTimeInput.value;
                if (!eventTimeValue) {
                    // 活动时间未填写，弹窗提醒
                    e.preventDefault();
                    alert('请输入活动时间！');
                    const eventTimeContainer = eventTimeInput.closest('.mb-4');
                    if (eventTimeContainer) {
                        eventTimeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // 添加高亮效果
                        eventTimeContainer.classList.add('highlight-error');
                        setTimeout(() => {
                            eventTimeContainer.classList.remove('highlight-error');
                        }, 2000);
                    }
                    return false;
                } else {
                    // 检查时间是否在当前时间之后（至少大于1分钟）
                    const selectedDateTime = new Date(eventTimeValue);
                    const currentDateTime = new Date();
                    // 减去1分钟的容差，允许活动时间比当前时间早1分钟
                    currentDateTime.setMinutes(currentDateTime.getMinutes() - 1);
                    
                    if (selectedDateTime < currentDateTime) {
                        // 选择的时间早于当前时间1分钟以上，弹窗提醒
                        e.preventDefault();
                        alert('活动时间不能早于当前时间1分钟，请重新选择！');
                        // 清空输入框
                        eventTimeInput.value = '';
                        // 聚焦到输入框
                        eventTimeInput.focus();
                        const eventTimeContainer = eventTimeInput.closest('.mb-4');
                        if (eventTimeContainer) {
                            eventTimeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // 添加高亮效果
                            eventTimeContainer.classList.add('highlight-error');
                            setTimeout(() => {
                                eventTimeContainer.classList.remove('highlight-error');
                            }, 2000);
                        }
                        return false;
                    }
                }
            }
            
            // 检查是否有其他错误信息
            const firstError = eventForm.querySelector('.text-danger');
            if (firstError) {
                e.preventDefault();
                // 找到包含错误信息的父元素并滚动到该位置
                const otherErrorContainer = firstError.closest('.mb-4');
                if (otherErrorContainer) {
                    otherErrorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 添加高亮效果
                    otherErrorContainer.classList.add('highlight-error');
                    setTimeout(() => {
                        otherErrorContainer.classList.remove('highlight-error');
                    }, 2000);
                }
                return false;
            }
        });
        
        // 为时间输入框添加事件监听器，确保输入后立即生效并设置最小时间
        const eventTimeInput = document.querySelector('[name="event_time"]');
        if (eventTimeInput) {
            // 设置最小时间为当前时间
            const now = new Date();
            // 给当前时间减去1分钟，允许活动时间比当前时间早1分钟
            now.setMinutes(now.getMinutes() - 1);
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            eventTimeInput.min = minDateTime;
            
            // 监听输入事件，确保输入后立即生效
            eventTimeInput.addEventListener('input', function() {
                // 手动触发change事件以确保值被正确捕获
                const changeEvent = new Event('change', { bubbles: true });
                this.dispatchEvent(changeEvent);
            });
            
            // 监听change事件，检查时间是否有效
            eventTimeInput.addEventListener('change', function() {
                const eventTimeValue = this.value;
                if (eventTimeValue) {
                    const selectedDateTime = new Date(eventTimeValue);
                    const currentDateTime = new Date();
                    // 减去1分钟的容差，允许活动时间比当前时间早1分钟
                    currentDateTime.setMinutes(currentDateTime.getMinutes() - 1);
                    
                    if (selectedDateTime < currentDateTime) {
                        // 选择的时间早于当前时间1分钟以上，弹窗提醒
                        alert('活动时间不能早于当前时间1分钟，请重新选择！');
                        // 清空输入框
                        this.value = '';
                    }
                }
            });
        }
        
        // 绑定地图按钮点击事件
        document.getElementById('map-button').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('map-modal'));
            modal.show();
            
            // 延迟加载地图，确保模态框完全显示
            setTimeout(function() {
                loadMap();
            }, 500);
        });
        
        // 绑定用户选择按钮点击事件
        document.getElementById('user-select-button').addEventListener('click', function() {
            currentInput = document.getElementById('location_user_input');
            currentType = 'location';
            const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
            modal.show();
            document.getElementById('userSearch').value = '';
            document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-building fa-2x mb-2"></i><p>请输入场地名称进行搜索</p></div>';
            document.getElementById('userSearch').focus();
        });
        
        // 加载地图功能
        function loadMap() {
            // 如果地图容器不存在或已经加载过地图，则直接返回
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer || mapContainer.dataset.loaded === 'true') {
                console.log('地图已加载或容器不存在');
                return;
            }
            
            // 标记地图已加载
            mapContainer.dataset.loaded = 'true';
            
            // 直接初始化地图
            setTimeout(() => {
                if (window.initBaiduMap && typeof window.initBaiduMap === 'function') {
                    window.initBaiduMap('{{ak}}');
                } else {
                    console.error('地图初始化函数未定义');
                }
            }, 300);
        }
        
        // 确认位置按钮事件
        document.getElementById('confirm-location').addEventListener('click', function() {
            // 获取搜索结果
            if (window.mapSearchResult && window.mapSearchResult.title) {
                // 将选中的位置填入活动场地输入框
                document.querySelector('[name="location"]').value = window.mapSearchResult.title;
                // 将完整的POI信息保存到隐藏字段
                document.querySelector('[name="location_poi"]').value = JSON.stringify(window.mapSearchResult);
                // 清除场地用户ID
                document.querySelector('[name="location_user"]').value = '';
                document.getElementById('location_user_input').value = '';
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('map-modal')).hide();
            } else {
                alert('请先在地图上搜索并选择一个位置');
            }
        });
        
        // 绑定搜索按钮点击事件
        document.querySelectorAll('.user-suggestion-btn').forEach(button => {
            button.addEventListener('click', function() {
                currentInput = this.closest('.input-group').querySelector('input');
                currentType = this.getAttribute('data-type');
                const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
                modal.show();
                document.getElementById('userSearch').value = '';
                document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
                document.getElementById('userSearch').focus();
            });
        });
        
        // 搜索用户
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.trim();
            if (searchTerm.length > 0) {
                loadUsers(searchTerm);
            } else {
                document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
            }
        });
        
        // 加载用户列表
        function loadUsers(search = '') {
            // 发送AJAX请求获取用户列表
            fetch(`{% url 'photos:search_users' %}?q=${encodeURIComponent(search)}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                
                if (data.users.length > 0) {
                    data.users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item d-flex align-items-center';
                        userElement.dataset.userId = user.id;
                        
                        // 创建用户头像
                        let avatarHtml = '';
                        if (user.avatar) {
                            avatarHtml = `<img src="${user.avatar}" class="user-avatar" alt="${user.username}">`;
                        } else {
                            avatarHtml = `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center user-avatar" style="width: 40px; height: 40px;" role="img" aria-label="${user.username} 的默认头像"><span class="text-white">${user.username.charAt(0).toUpperCase()}</span></div>`;
                        }
                        
                        userElement.innerHTML = `
                            ${avatarHtml}
                            <div class="flex-grow-1">
                                <div class="fw-bold">${user.username}</div>
                            </div>
                        `;
                        
                        // 点击用户项时插入用户名到输入框
                        userElement.addEventListener('click', function() {
                            insertUser(user);
                            bootstrap.Modal.getInstance(document.getElementById('userSuggestionModal')).hide();
                        });
                        
                        // 双击用户项时跳转到用户个人空间
                        userElement.addEventListener('dblclick', function() {
                            window.open(`/user/${user.id}/space/`, '_blank');
                        });
                        
                        userList.appendChild(userElement);
                    });
                } else {
                    userList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-warehouse fa-2x mb-2"></i><p>未找到相关摄影基地</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('userList').innerHTML = '<div class="text-center text-danger py-3"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>加载摄影基地时出错</p></div>';
            });
        }
        
        // 插入用户到输入框
        function insertUser(user) {
            if (!currentInput) return;
            
            try {
                // 检查当前是哪个输入框
                if (currentType === 'location') {
                    // 如果是活动地点输入框，直接设置值
                    currentInput.value = user.username || '';
                    // 存储用户ID到隐藏字段
                    const locationUserInput = document.querySelector('[name="location_user"]');
                    if (locationUserInput) {
                        locationUserInput.value = user.id || '';
                    }
                } else {
                    // 如果是模特姓名输入框
                    const modelIndexMatch = currentInput.name ? currentInput.name.match(/\d+/) : null;
                    if (!modelIndexMatch) return;
                    
                    const modelIndex = parseInt(modelIndexMatch[0]);
                    const currentValue = currentInput.value || '';
                    const usernames = currentValue 
                        ? currentValue.split(',').map(name => name.trim()).filter(name => name) 
                        : [];
                    
                    // 检查用户是否已存在
                    const usernameToAdd = user.username || '';
                    if (usernameToAdd && !usernames.includes(usernameToAdd)) {
                        usernames.push(usernameToAdd);
                        currentInput.value = usernames.join(', ');
                        // 存储用户ID到隐藏字段
                        if (!isNaN(modelIndex)) {
                            const hiddenInput = document.querySelector(`input[name="model_user_${modelIndex}"]`);
                            if (hiddenInput) {
                                hiddenInput.value = user.id || '';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error inserting user:', error);
            } finally {
                // 确保始终聚焦到输入框
                try {
                    if (currentInput && currentInput.focus) {
                        currentInput.focus();
                    }
                } catch (focusError) {
                    console.error('Focus error:', focusError);
                }
            }
        }
        
        // 图片预览功能
        function setupImagePreview() {
            document.querySelectorAll('input[name$="model_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_model_images', '_model-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
            
            document.querySelectorAll('input[name$="outfit_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_outfit_images', '_outfit-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
            
            document.querySelectorAll('input[name$="scene_images"]').forEach(input => {
                input.addEventListener('change', function(e) {
                    const previewContainerId = this.id.replace('_scene_images', '_scene-images-preview');
                    previewImages(e.target, previewContainerId);
                });
            });
        }
        
        function previewImages(input, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (input.files) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'image-preview';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        
                        const removeBtn = document.createElement('span');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.addEventListener('click', function() {
                            previewWrapper.remove();
                            // 从文件输入中移除该文件
                            removeFileFromInput(input, file);
                        });
                        
                        previewWrapper.appendChild(img);
                        previewWrapper.appendChild(removeBtn);
                        previewContainer.appendChild(previewWrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }
        
        function removeFileFromInput(input, fileToRemove) {
            const dt = new DataTransfer();
            const files = input.files;
            
            for (let i = 0; i < files.length; i++) {
                if (files[i] !== fileToRemove) {
                    dt.items.add(files[i]);
                }
            }
            
            input.files = dt.files;
        }
        
        // 更新模特和场次编号
        function updateModelNumbers() {
            const modelsContainer = document.getElementById('models-container');
            const modelItems = modelsContainer.querySelectorAll('.model-item');
            
            modelItems.forEach((modelItem, index) => {
                const modelNumber = index + 1;
                const modelId = modelItem.id;
                
                // 更新标题
                const titleElement = modelItem.querySelector('.model-title');
                if (titleElement) {
                    titleElement.textContent = `模特 ${modelNumber}`;
                }
                
                // 更新表单字段的name属性
                const nameInput = modelItem.querySelector('.model-name-input');
                if (nameInput) {
                    nameInput.name = `model_name_${modelNumber}`;
                }
                
                const feeInput = modelItem.querySelector('.model-fee-input');
                if (feeInput) {
                    feeInput.name = `model_fee_${modelNumber}`;
                }
                
                const vipFeeInput = modelItem.querySelector('.model-vip-fee-input');
                if (vipFeeInput) {
                    vipFeeInput.name = `model_vip_fee_${modelNumber}`;
                }
                
                const photographerCountInput = modelItem.querySelector('.model-photographer-count-input');
                if (photographerCountInput) {
                    photographerCountInput.name = `model_photographer_count_${modelNumber}`;
                }
                
                const modelImagesInput = modelItem.querySelector('.model-images-input');
                if (modelImagesInput) {
                    modelImagesInput.name = `model_images_${modelNumber}`;
                    modelImagesInput.id = `model_images_${modelNumber}`;
                }
                
                const outfitImagesInput = modelItem.querySelector('.outfit-images-input');
                if (outfitImagesInput) {
                    outfitImagesInput.name = `outfit_images_${modelNumber}`;
                    outfitImagesInput.id = `outfit_images_${modelNumber}`;
                }
                
                const sceneImagesInput = modelItem.querySelector('.scene-images-input');
                if (sceneImagesInput) {
                    sceneImagesInput.name = `scene_images_${modelNumber}`;
                    sceneImagesInput.id = `scene_images_${modelNumber}`;
                }
                
                const modelUserInput = modelItem.querySelector('input[name^="model_user_"]');
                if (modelUserInput) {
                    modelUserInput.name = `model_user_${modelNumber}`;
                }
                
                // 更新预览容器ID
                const modelImagesPreview = modelItem.querySelector('[id$="_model-images-preview"]');
                if (modelImagesPreview) {
                    modelImagesPreview.id = `${modelId}_model-images-preview`;
                }
                
                const outfitImagesPreview = modelItem.querySelector('[id$="_outfit-images-preview"]');
                if (outfitImagesPreview) {
                    outfitImagesPreview.id = `${modelId}_outfit-images-preview`;
                }
                
                const sceneImagesPreview = modelItem.querySelector('[id$="_scene-images-preview"]');
                if (sceneImagesPreview) {
                    sceneImagesPreview.id = `${modelId}_scene-images-preview`;
                }
                
                // 更新场次按钮的data-model-id属性
                const addSessionBtn = modelItem.querySelector('.add-session-btn');
                if (addSessionBtn) {
                    addSessionBtn.setAttribute('data-model-id', modelId);
                }
                
                // 更新场次容器ID
                const sessionsContainer = modelItem.querySelector('.sessions-container');
                if (sessionsContainer) {
                    sessionsContainer.id = `${modelId}-sessions`;
                }
                
                // 更新场次编号
                updateSessionNumbers(modelId, modelNumber);
            });
        }
        
        // 更新场次编号
        function updateSessionNumbers(modelId, modelNumber) {
            const sessionsContainer = document.getElementById(`${modelId}-sessions`);
            if (!sessionsContainer) return;
            
            const sessionItems = sessionsContainer.querySelectorAll('.session-item');
            sessionItems.forEach((sessionItem, index) => {
                const sessionNumber = index + 1;
                
                // 更新标题
                const titleElement = sessionItem.querySelector('.session-title');
                if (titleElement) {
                    titleElement.textContent = `场次 ${sessionNumber}`;
                }
                
                // 更新时间输入字段的name属性
                const startTimeInput = sessionItem.querySelector('.start-time-input');
                if (startTimeInput) {
                    startTimeInput.name = `start_time_${modelNumber}_${sessionNumber}`;
                }
                
                const endTimeInput = sessionItem.querySelector('.end-time-input');
                if (endTimeInput) {
                    endTimeInput.name = `end_time_${modelNumber}_${sessionNumber}`;
                }
            });
        }
        
        // 模特管理功能
        document.getElementById('add-model').addEventListener('click', function() {
            addModel();
        });
        
        function addModel() {
            // 不再使用全局递增的modelCount，而是动态计算当前应该使用的编号
            const modelsContainer = document.getElementById('models-container');
            const currentModels = modelsContainer.querySelectorAll('.model-item');
            const modelNumber = currentModels.length + 1;
            
            const modelId = 'model-' + modelNumber;
            sessionCounts[modelId] = 0; // 初始化该模特的场次计数
            
            const modelHtml = `
                <div class="model-item" id="${modelId}">
                    <div class="model-header">
                        <h6 class="model-title">模特 ${modelNumber}</h6>
                        <div class="remove-model" data-model-id="${modelId}">&times;</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="row align-items-center">  
                                <div class="col-4"> 
                                    <label class="form-label">模特姓名</label>
                                </div>
                                <div class="col-8"> 
                                    <div class="input-group">
                                        <input type="text" class="form-control model-name-input" 
                                            name="model_name_${modelNumber}" 
                                            placeholder="输入或搜索添加" required>
                                        <button class="btn btn-outline-secondary user-suggestion-btn" type="button" data-type="model">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" name="model_user_${modelNumber}" value="">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row align-items-center">  
                                <div class="col-4"> 
                                    <label class="form-label">价格:元/场</label>
                                </div>
                                <div class="col-8"> 
                                    <input type="number" class="form-control model-fee-input" 
                                        name="model_fee_${modelNumber}" 
                                        placeholder="元/场" step="0.01" required>
                                </div>
                            </div>  
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <label class="form-label">VIP价格:元/场</label>
                                </div>
                                <div class="col-8">
                                    <input type="number" class="form-control model-vip-fee-input" 
                                        name="model_vip_fee_${modelNumber}" 
                                        placeholder="VIP价格(非必填)" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <label class="form-label">人场比:人/场</label>
                                </div>
                                <div class="col-8">
                                    <input type="number" class="form-control model-photographer-count-input" 
                                        name="model_photographer_count_${modelNumber}" 
                                        placeholder="该模特每场的摄影人数" min="1" value="1" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">模特照片</label>
                        <input type="file" class="form-control model-images-input" 
                               name="model_images_${modelNumber}" 
                               id="model_images_${modelNumber}" 
                               multiple>
                        <div id="${modelId}_model-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">服装道具</label>
                        <input type="file" class="form-control outfit-images-input" 
                               name="outfit_images_${modelNumber}" 
                               id="outfit_images_${modelNumber}" 
                               multiple>
                        <div id="${modelId}_outfit-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">拍摄场景</label>
                        <input type="file" class="form-control scene-images-input" 
                               name="scene_images_${modelNumber}" 
                               id="scene_images_${modelNumber}" 
                               multiple>
                        <div id="${modelId}_scene-images-preview" class="mt-2 d-flex flex-wrap gap-2">
                            <!-- 预览图片将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    
                    <!-- 场次信息 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label mb-0">活动场次</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-session-btn" data-model-id="${modelId}">
                                <i class="fas fa-plus me-1"></i>添加场次
                            </button>
                        </div>
                        
                        <div class="sessions-container" id="${modelId}-sessions">
                            <!-- 场次表单将通过JavaScript动态添加 -->
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('models-container');
            container.insertAdjacentHTML('beforeend', modelHtml);
            
            // 绑定删除模特事件
            document.querySelector(`.remove-model[data-model-id="${modelId}"]`).addEventListener('click', function() {
                removeModel(this.getAttribute('data-model-id'));
            });
            
            // 绑定添加场次事件
            document.querySelector(`.add-session-btn[data-model-id="${modelId}"]`).addEventListener('click', function() {
                addSession(modelId);
            });
            
            // 为新添加的图片输入框设置预览功能
            setupImagePreview();
            
            // 为新添加的用户搜索按钮绑定事件
            document.querySelectorAll('.user-suggestion-btn').forEach(button => {
                // 只为新添加的按钮绑定事件，避免重复绑定
                if (!button.hasAttribute('data-bound')) {
                    button.setAttribute('data-bound', 'true');
                    button.addEventListener('click', function() {
                        currentInput = this.closest('.input-group').querySelector('input[type="text"]');
                        currentType = this.getAttribute('data-type');
                        const modal = new bootstrap.Modal(document.getElementById('userSuggestionModal'));
                        modal.show();
                        document.getElementById('userSearch').value = '';
                        document.getElementById('userList').innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-users fa-2x mb-2"></i><p>输入用户名搜索用户</p></div>';
                        document.getElementById('userSearch').focus();
                    });
                }
            });

            // 初始化添加一个场次
            addSession(modelId);
        }
        
        function removeModel(modelId) {
            const modelElement = document.getElementById(modelId);
            if (modelElement) {
                modelElement.remove();
                delete sessionCounts[modelId];
                
                // 从选中用户中移除
                const modelIndex = modelId.split('-')[1];
                delete selectedUsers[`model_user_${modelIndex}`];
                
                // 更新剩余模特的编号
                updateModelNumbers();
            }
        }
        
        // 场次管理功能
        function addSession(modelId) {
            sessionCounts[modelId] = (sessionCounts[modelId] || 0) + 1;
            const sessionId = modelId + '-session-' + sessionCounts[modelId];
            // 从modelId中提取模特索引
            const modelIndex = modelId.split('-')[1];
            
            // 获取当前场次数量，用于显示正确的编号
            const sessionsContainer = document.getElementById(modelId + '-sessions');
            const currentSessions = sessionsContainer.querySelectorAll('.session-item');
            const sessionNumber = currentSessions.length + 1;
            
            const sessionHtml = `
                <div class="session-item" id="${sessionId}">
                    <div class="session-header">
                        <h6 class="session-title">场次 ${sessionNumber}</h6>
                        <div class="remove-session" data-session-id="${sessionId}">&times;</div>
                    </div>
                    <div class="time-inputs">
                        <label>时间:</label>
                        <input type="time" class="form-control start-time-input" 
                               name="start_time_${modelIndex}_${sessionNumber}" 
                               placeholder="开始时间" required>
                        <span>-</span>
                        <input type="time" class="form-control end-time-input" 
                               name="end_time_${modelIndex}_${sessionNumber}" 
                               placeholder="结束时间" required>
                    </div>
                </div>
            `;
            
            const container = document.getElementById(modelId + '-sessions');
            container.insertAdjacentHTML('beforeend', sessionHtml);
            
            // 绑定删除场次事件
            document.querySelector(`.remove-session[data-session-id="${sessionId}"]`).addEventListener('click', function() {
                removeSession(this.getAttribute('data-session-id'));
            });
        }
        
        function removeSession(sessionId) {
            const sessionElement = document.getElementById(sessionId);
            if (sessionElement) {
                // 获取modelId
                const modelId = sessionId.split('-session-')[0];
                sessionElement.remove();
                
                // 更新该模特下的场次编号
                if (modelId) {
                    // 获取模特索引
                    const modelIndex = modelId.split('-')[1];
                    updateSessionNumbers(modelId, modelIndex);
                }
            }
        }
        
        // 初始化添加一个模特
        window.addEventListener('DOMContentLoaded', function() {
            addModel();
        });
    });
</script>
{% endblock %}