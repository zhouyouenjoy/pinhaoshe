{% extends 'minimal_base.html' %}
{% load static %}
{% load event_extras %}
{% block title %}待处理退款申请{% endblock %}
{% block content %}
<style>
    .pending-refunds-container {
        min-height: 60vh;
        background: linear-gradient(135deg, #68cfcb 0%, #465054 100%);
        padding: 0;
    }
    .pending-refunds-card {
        background: rgba(255,255,255,0.95);
        border-radius: 0;
        box-shadow: none;
        backdrop-filter: blur(10px);
        width: 100%;
        min-height: 60vh;
    }
    .pending-refunds-header {
        background: linear-gradient(135deg, #66c5ea 0%, #d655a0 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 20px;
        text-align: center;
    }
    .refund-table {
        width: 100%;
        border-collapse: collapse;
    }
    .refund-table th,
    .refund-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .refund-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .refund-table tr:hover {
        background-color: #f5f5f5;
    }
    .status-pending {
        background-color: #fff3cd;
        padding: 4px 8px;
        border-radius: 4px;
        color: #856404;
    }
    .action-buttons .btn {
        margin: 0 2px;
        font-size: 0.85rem;
        padding: 4px 8px;
    }
</style>

<div class="container-fluid pending-refunds-container p-0">
    <div class="card pending-refunds-card">
        <div class="pending-refunds-header">
            <div class="d-flex align-items-center justify-content-between">
                <a href="#" onclick="history.back(); return false;" class="text-white" style="font-size: 1.5rem;">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h2 class="mb-0 flex-grow-1 text-center"><i class="fas fa-undo me-2"></i>待处理退款申请</h2>
                <div style="width: 36px;"></div> <!-- 占位元素，保持标题居中 -->
            </div>
        </div>
        
        <div class="container py-3">
            {% if pending_refunds %}
            <div class="table-responsive">
                <table class="table table-striped refund-table">
                    <thead>
                        <tr>
                            <th>申请人</th>
                            <th>活动名称</th>
                            <th>申请时间</th>
                            <th>退款金额</th>
                            <th>退款原因</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for refund in pending_refunds %}
                        <tr>
                            <td>{{ refund.registration.user.username }}</td>
                            <td>{{ refund.registration.session.model.event.title }}</td>
                            <td>{{ refund.created_at|date:"Y-m-d H:i" }}</td>
                            <td>¥{{ refund.amount }}</td>
                            <td>{{ refund.reason }}</td>
                            <td><span class="status-pending">{{ refund.get_status_display }}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-success me-1 approve-refund" data-refund-id="{{ refund.id }}">同意</button>
                                <button class="btn btn-sm btn-danger reject-refund" data-refund-id="{{ refund.id }}">拒绝</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-undo fa-3x text-muted mb-3"></i>
                <p class="text-muted">暂无待处理的退款申请。</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 处理退款模态框 -->
<div class="modal fade" id="processRefundModal" tabindex="-1" aria-labelledby="processRefundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processRefundModalLabel">处理退款申请</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="processRefundForm">
                    <input type="hidden" id="refundId" name="refund_id">
                    <div class="mb-3">
                        <label for="processReason" class="form-label">处理说明（可选）：</label>
                        <textarea class="form-control" id="processReason" name="reason" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" id="approveBtn">同意</button>
                <button type="button" class="btn btn-danger" id="rejectBtn">拒绝</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const processRefundModal = new bootstrap.Modal(document.getElementById('processRefundModal'));
        const refundIdInput = document.getElementById('refundId');
        const processReason = document.getElementById('processReason');
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        
        // 获取CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 绑定同意/拒绝按钮事件
        document.querySelectorAll('.approve-refund, .reject-refund').forEach(btn => {
            btn.addEventListener('click', function() {
                const refundId = this.getAttribute('data-refund-id');
                const action = this.classList.contains('approve-refund') ? 'approve' : 'reject';
                
                // 设置表单数据
                refundIdInput.value = refundId;
                
                // 显示模态框
                processRefundModal.show();
                
                // 绑定处理按钮事件
                approveBtn.onclick = function() {
                    processRefund(refundId, 'approve', processReason.value);
                };
                
                rejectBtn.onclick = function() {
                    processRefund(refundId, 'reject', processReason.value);
                };
            });
        });
        
        // 处理退款申请
        function processRefund(refundId, action, reason) {
            // 通过AJAX向服务器发送处理请求
            fetch(`/event/process_refund/${refundId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'action': action,
                    'reason': reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`退款申请已${action === 'approve' ? '批准' : '拒绝'}`);
                    processRefundModal.hide();
                    // 重新加载页面以更新状态
                    location.reload();
                } else {
                    alert('处理失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('处理失败，请稍后重试');
            });
        }
    });
</script>
{% endblock %}