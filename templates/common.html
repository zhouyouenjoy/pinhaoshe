{% load static %}
<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <meta charset="utf-8">
    <!-- 引入favicon -->
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <!-- 设置视口，使页面在移动设备上正确显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{% block og_url %}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% endblock %}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{% block twitter_url %}{% endblock %}">
    <meta property="twitter:title" content="{% block twitter_title %}{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{% endblock %}">
    
    <!-- 页面标题，使用Django模板标签定义可被子模板覆盖的块 -->
    <title>{% block title %}拼好摄{% endblock %}</title>
    <!-- 引入Bootstrap CSS框架 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 自定义样式表 -->
    <link rel="stylesheet" href="{% static 'css/photos/style.css' %}?v=1.0.0">
    <!-- 评论系统样式表 -->
    <link rel="stylesheet" href="{% static 'css/photos/comments.css' %}?v=1.0.0">
    
    <!-- 引入Masonry.js -->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
    <!-- 引入imagesLoaded.js用于检测图片加载完成 -->
    <script src="https://cdn.jsdelivr.net/npm/imagesloaded@4.1.4/imagesloaded.pkgd.min.js"></script>
    
    {% block css %}
    {% endblock %}
</head>
{% load static %}
<body class="no-padding">
    <!-- 导航栏 -->
    {% if request.resolver_match.url_name == 'gallery' or request.resolver_match.url_name == 'following_albums' or request.resolver_match.url_name == 'event_list' %}
        <nav class="navbar navbar-expand-lg navbar-custom">
            <div class="container-fluid">
                <!-- 左侧：搜索按钮和模态框触发器 -->
                <button class="btn btn-outline-light me-2 btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#searchModal">
                    <i class="fas fa-search"></i>
                </button>
                
                <!-- 中间：导航项组（在所有设备上显示） -->
                <div class="nav-center-group">
                    <a class="nav-link nav-link-custom {% if user.is_authenticated %}ajax-link{% endif %}"
                    {% if user.is_authenticated %}
                    data-url="{% url 'photos:following_albums' %}" href="#"
                    {% else %}
                    href="{% url 'photos:login' %}"
                    {% endif %}>关注</a>
                    
                    <a id="gallery-link" class="nav-link nav-link-custom ajax-link" data-url="{% url 'photos:gallery' %}" href="#">发现</a>
                    
                    
                    <a id="events-link" class="nav-link nav-link-custom ajax-link" data-url="{% url 'event:event_list' %}" href="#">活动</a>
                </div>
                
                <!-- 右侧：桌面端导航链接和移动端菜单按钮 -->
                <div class="navbar-nav ms-auto align-items-center">
                    <div class="navbar-nav nav-links-desktop">
                        {% if user.is_authenticated %}
                            <a class="nav-link nav-link-custom ajax-link" data-url="{% url 'photos:my_info' %}" href="#">我的</a>
                            <a class="nav-link nav-link-custom" href="{% url 'photos:upload_photo' %}">上传</a>
                            <a class="nav-link nav-link-custom" href="{% url 'photos:messages_list' %}">消息</a>
                        {% else %}
                            <a class="nav-link nav-link-custom ajax-link" data-url="{% url 'photos:login' %}" href="#">登录</a>
                        {% endif %}
                    </div>
                    
                    <!-- 移动端菜单按钮 -->
                    <div class="nav-links-mobile ms-2">
                        <button class="mobile-menu-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                            ☰
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 搜索模态框 -->
        <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="searchModalLabel">搜索</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="searchForm" method="get" action="{% url 'photos:search' %}">
                            <div class="input-group">
                                <input type="text" class="form-control" name="q" placeholder="搜索相册或用户..." required>
                                <button class="btn btn-primary" type="submit">搜索</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 移动端侧边栏菜单 -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">菜单</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            {% if user.is_authenticated %}
                <div class="d-grid gap-2">
                    <a class="btn btn-primary" href="{% url 'photos:my_info' %}">我的空间</a>
                    <a class="btn btn-success" href="{% url 'photos:upload_photo' %}">上传照片</a>
                    <a class="btn btn-info" href="{% url 'photos:messages_list' %}">我的消息</a>
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-logout w-100">退出 ({{ user.username }})</button>
                    </form>
                </div>
            {% else %}
                <div class="d-grid gap-2">
                    <a class="btn btn-primary" href="{% url 'photos:login' %}">登录</a>
                    <a class="btn btn-success" href="{% url 'photos:register' %}">注册</a>
                </div>
            {% endif %}
        </div>
        </div>
    {% endif %}
    
    <!-- 用户信息栏（仅在照片详情页面显示） -->
    {% block user_info_bar %}
    {% endblock %}
    
    <!-- 主要内容容器，设置上边距 -->
    <div class="{% block container_class %}container-fluid{% endblock %} main-content">
        <!-- 显示Django消息框架中的消息 -->
        {% if messages %}
            {% for message in messages %}
                <!-- 根据消息类型设置不同的样式 -->
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <!-- 关闭按钮 -->
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- 内容块，子模板可以覆盖此部分 -->
        {% block content %}
        {% endblock %}
    </div>
    
    <!-- 底部导航栏（仅在照片详情页面显示） -->
    {% block bottom_nav %}
    {% endblock %}
    
    <!-- 评论弹窗 -->
    {% block comment_modal %}
    {% endblock %}
    
    <!-- 引入Bootstrap JavaScript组件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入Masonry.js -->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
    <!-- 引入imagesLoaded.js用于检测图片加载完成 -->
    <script src="https://cdn.jsdelivr.net/npm/imagesloaded@4.1.4/imagesloaded.pkgd.min.js"></script>
    <!-- 自定义JS -->
    <script src="{% static 'js/main.js' %}?v=1.0.0"></script>
    <script src="{% static 'js/gallery_following_event.js' %}"></script>
    <script>
                function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 显示模特照片的函数
        function showModelPhoto(element, modelName, imageUrl) {
            // 阻止事件冒泡到卡片点击事件
            event.stopPropagation();
            
            const modal = document.getElementById("modelPhotoModal");
            const modalImg = document.getElementById("modalModelImage");
            const modalName = document.getElementById("modalModelName");
            
            // 如果没有图片URL，则不显示模态框
            if (!imageUrl) {
                return;
            }
            
            modalImg.src = imageUrl;
            modalName.textContent = modelName;
            
            // 显示模态框并触发动画
            modal.style.display = "flex";
            setTimeout(() => {
                modal.classList.add("show");
            }, 10);
            
            // 防止背景滚动
            document.body.style.overflow = "hidden";
        }
        
        // 关闭模态框的函数
        function closeModal() {
            const modal = document.getElementById("modelPhotoModal");
            if (modal) {
                modal.classList.remove("show");
                
                // 延迟隐藏元素以确保动画完成
                setTimeout(() => {
                    modal.style.display = "none";
                    document.body.style.overflow = "auto";
                }, 300);
            }
        }

        // 初始化页面功能
        function initializePage() {
            // 清理之前的状态
            cleanupPreviousState();
            
            // 初始化各种页面的懒加载功能（如果存在）
            if (typeof initLazyLoading === 'function') {
                initLazyLoading();
            }
            if (typeof initFollowingLazyLoading === 'function') {
                initFollowingLazyLoading();
            }
            if (typeof initEventLazyLoading === 'function') {
                initEventLazyLoading();
            }
        }

        // 清理之前的状态，防止内存泄漏和事件重复绑定
        function cleanupPreviousState() {
            // 清理已有的事件监听器状态
            if (window.lazyLoadingState) {
                window.removeEventListener('scroll', window.lazyLoadingState.handleScroll);
                delete window.lazyLoadingState;
            }
            if (window.followingLazyLoadingState) {
                window.removeEventListener('scroll', window.followingLazyLoadingState.handleScroll);
                delete window.followingLazyLoadingState;
            }
            if (window.eventLazyLoadingState) {
                window.removeEventListener('scroll', window.eventLazyLoadingState.handleScroll);
                delete window.eventLazyLoadingState;
            }
        }

        // AJAX导航功能
        document.addEventListener('DOMContentLoaded', function() {
            // 处理导航链接点击事件
            document.querySelectorAll('.ajax-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('data-url');
                    const activeLink = document.querySelector('.nav-link-custom.active');
                    if (activeLink) activeLink.classList.remove('active');
                    this.classList.add('active');

                    //loading指示器
                    const contentContainer = document.querySelector('.main-content');
                    contentContainer.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x"></i></div>';

                    // AJAX请求
                    fetch(url, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => {
                        // 检查是否重定向到登录页面
                        if (response.redirected) {
                            window.location.href = response.url;
                            return Promise.reject('Redirected to login');
                        }
                        if (!response.ok) {
                            if (response.status === 403 || response.status === 401) {
                                // 未授权，重定向到登录页面
                                window.location.href = "{% url 'photos:login' %}?next=" + encodeURIComponent(url);
                                return;
                            }
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(html => {
                        // 创建临时元素解析HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // 提取main-content部分
                        let mainContentElement = tempDiv.querySelector('.main-content');
                        // 如果在第一层找不到，尝试在子元素中查找
                        if (!mainContentElement) {
                            // 查找body元素中的main-content
                            const bodyElement = tempDiv.querySelector('body');
                            if (bodyElement) {
                                mainContentElement = bodyElement.querySelector('.main-content');
                            }
                        }
                        
                        if (!mainContentElement) {
                            // 未找到内容区域，重定向到登录页面
                            console.log('未找到内容区域2', mainContentElement)
                            window.location.href = "{% url 'photos:login' %}?next=" + encodeURIComponent(url);
                            return;
                        }
                        // 检查是否包含登录表单
                        const loginForm = mainContentElement.querySelector('form[action*="login"]');
                        if (loginForm) {
                            
                            window.location.href = "{% url 'photos:login' %}?next=" + encodeURIComponent(url);
                            return;
                        }
                        const newContent = mainContentElement.innerHTML;
                        if (!newContent.trim()) {
                            // 内容为空，重定向到登录页面
                            
                            window.location.href = "{% url 'photos:login' %}?next=" + encodeURIComponent(url);
                            return;
                        }
                        // 更新内容
                        contentContainer.innerHTML = newContent;
                        // 重新初始化页面组件
                        initializePage();
                        // 更新页面标题
                        const titleMatch = html.match(/<title>(.*?)<\/title>/);
                        document.title = titleMatch ? titleMatch[1] : '拼好摄';
                    })
                    .catch(error => {
                        console.error('AJAX Error:', error);
                        contentContainer.innerHTML = '<div class="alert alert-danger">加载失败，请重试</div>';
                    });
                });
            });  
            // 设置初始活动链接
            const currentPath = window.location.pathname;
            document.querySelectorAll('a[id="gallery-link"]').forEach(link => {

                if (link.getAttribute('data-url').endsWith(currentPath)) {
                    link.classList.add('active');
                }
            });
            
            // 初始化页面功能
            initializePage();
        });
        // 将懒加载+Masonry瀑布流功能封装为全局函数，以便在AJAX导航时可以重新初始化
        function initLazyLoading() {
            // 清理已有的事件监听器，防止重复绑定
            if (window.lazyLoadingState) {
                window.removeEventListener('scroll', window.lazyLoadingState.handleScroll);
                // 销毁现有的Masonry实例
                if (window.masonryInstance) {
                    window.masonryInstance.destroy();
                    window.masonryInstance = null;
                }
            }

            let page = 1;
            let isLoading = false;
            let hasNext = true;
            let masonryInstance = null;
            const masonryGrid = document.getElementById('masonry-grid');
            const eventList = document.getElementById('event-list');
            
            // 如果元素不存在，说明不在当前页面，直接返回
            if (!masonryGrid && !eventList) return;
            
            // 检查当前页面是哪个按钮
            const loadMoreBtn = document.getElementById('load-more-btn');
            const loadFollowingMoreBtn = document.getElementById('loadfollowing-more-btn');
            const loadEventMoreBtn = document.getElementById('loadevent-more-btn');
            const activeBtn = loadMoreBtn || loadFollowingMoreBtn || loadEventMoreBtn;
            
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            // 初始化Masonry瀑布流 - 强制双列布局
            function initMasonry() {
                if (masonryGrid) {
                    // 简化Masonry初始化，使用CSS定义的双列宽度
                    masonryInstance = new Masonry(masonryGrid, {
                        itemSelector: '.masonry-item',
                        columnWidth: '.masonry-grid .masonry-item',
                        horizontalOrder: true
                    });
                    
                    // 保存Masonry实例到全局
                    window.masonryInstance = masonryInstance;
                    
                    // 监听图片加载完成事件，确保加载后重新布局
                    const images = masonryGrid.querySelectorAll('img');
                    images.forEach(img => {
                        // 如果图片已经加载完成
                        if (img.complete) {
                            scheduleLayoutUpdate();
                        } else {
                            // 监听图片加载事件
                            img.addEventListener('load', scheduleLayoutUpdate);
                            // 监听图片加载失败事件
                            img.addEventListener('error', scheduleLayoutUpdate);
                        }
                    });
                }
            }
            
            // 延迟布局更新，避免频繁重新布局
            let layoutUpdateTimeout;
            function scheduleLayoutUpdate() {
                if (layoutUpdateTimeout) {
                    clearTimeout(layoutUpdateTimeout);
                }
                layoutUpdateTimeout = setTimeout(() => {
                    if (masonryInstance) {
                        masonryInstance.layout();
                    }
                }, 100);
            }
            
            // 初始化加载更多按钮显示状态
            function initLoadMore() {
                if (hasNext) {
                    loadMoreContainer.style.display = 'block';
                } else {
                    loadMoreContainer.style.display = 'none';
                }
            }
            
            // 加载更多内容
            function loadMoreItems() {
                if (isLoading || !hasNext) return;
                
                isLoading = true;
                activeBtn.style.display = 'none';
                loadingSpinner.style.display = 'inline-block';
                
                // 根据按钮类型确定URL和目标容器
                let url;
                let targetContainer;
                if (loadMoreBtn) {
                    url = `{% url 'photos:gallery' %}?page=${page + 1}`;
                    targetContainer = masonryGrid;
                } else if (loadFollowingMoreBtn) {
                    url = `{% url 'photos:following_albums' %}?action=load_more&page=${page + 1}`;
                    targetContainer = masonryGrid;
                } else if (loadEventMoreBtn) {
                    url = `{% url 'event:event_list' %}?page=${page + 1}`;
                    targetContainer = eventList;
                }
                
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        // 将新内容添加到相应容器中
                        const newContent = document.createElement('div');
                        newContent.innerHTML = data.html;
                        const items = Array.from(newContent.children);
                        
                        // 创建文档片段以减少DOM操作
                        const fragment = document.createDocumentFragment();
                        items.forEach(item => {
                            fragment.appendChild(item);
                        });
                        
                        if (masonryInstance && (loadMoreBtn || loadFollowingMoreBtn )) {
                            // 对于Masonry容器，使用appended方法添加新项
                            targetContainer.appendChild(fragment);
                            // 等待新图片加载完成后重新布局
                            imagesLoaded(targetContainer, function() {
                                masonryInstance.appended(items);
                                masonryInstance.layout();
                            });
                        } else {
                            // 对于非Masonry容器，直接添加
                            targetContainer.appendChild(fragment);
                        }
                        
                        page = data.next_page ? data.next_page - 1 : page;
                        hasNext = data.has_next;
                        
                        // 如果没有更多内容，显示提示信息
                        if (!hasNext) {
                            const noMoreContent = document.createElement('div');
                            noMoreContent.className = 'text-center text-muted py-3';
                            noMoreContent.textContent = '没有更多内容了';
                            loadMoreContainer.parentNode.insertBefore(noMoreContent, loadMoreContainer);
                            loadMoreContainer.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('加载更多内容时出错:', error);
                })
                .finally(() => {
                    isLoading = false;
                    if (hasNext) {
                        activeBtn.style.display = 'inline-block';
                    }
                    loadingSpinner.style.display = 'none';
                    initLoadMore();
                });
            }
            
            function handleScroll() {
                // 检查是否滚动到页面底部附近（100px以内）
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                    loadMoreItems();
                }
            }

            // 保存状态，以便下次清理
            window.lazyLoadingState = {
                handleScroll: handleScroll
            };

            // 绑定事件
            window.addEventListener('scroll', handleScroll);
            if (activeBtn) {
                activeBtn.addEventListener('click', loadMoreItems);
            }
            
            // 初始化
            initLoadMore();
            initMasonry();
        }

        // 页面加载完成后初始化懒加载和Masonry
        window.addEventListener('load', function() {
            // 确保所有资源都已加载完成
            setTimeout(initLazyLoading, 100);
        });

        // 暴露函数到全局作用域，确保在AJAX导航时可以访问
        window.initLazyLoading = initLazyLoading;
    </script>
    {% csrf_token %}
</body>
</html>