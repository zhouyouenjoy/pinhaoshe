{% extends 'base.html' %}

{% load form_extras %}
{% load static %}

{% block title %}{{ target_user.username }}的个人空间{% endblock %}

{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block og_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block og_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block og_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block twitter_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block twitter_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block twitter_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.25rem;
        border-top-left-radius: calc(10px - 1px);
        border-top-right-radius: calc(10px - 1px);
    }
    .card-body {
        padding: 1rem 1.25rem;
    }
    .card-title {
        margin-bottom: 0.5rem;
    }
    .card-text {
        margin-bottom: 1rem;
    }
    .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1rem 1.25rem;
        border-bottom-left-radius: calc(10px - 1px);
        border-bottom-right-radius: calc(10px - 1px);
    }
    
    /* 用户活动标签页样式 */
    .nav-tabs .nav-link {
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    
    /* 照片网格布局 */
    .photo-grid .card {
        transition: transform 0.2s ease-in-out;
    }
    
    .photo-grid .card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="row">
        <div class="col-md-8 mx-auto">

            
            <!-- 用户信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>个人信息</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if target_user.userprofile.avatar %}
                            <img src="{{ target_user.userprofile.avatar.url }}" alt="头像" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                <span class="text-white" style="font-size: 2rem;">{{ target_user.username|first|upper }}</span>
                            </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">{{ target_user.username }}</h5>
                                    <p class="text-muted mb-0">{{ target_user.userprofile.email|default:"未设置邮箱" }}</p>
                                </div>
                                {% if target_user != user and user.is_authenticated %}
                                <div>
                                    <button class="btn {% if is_following %}btn-secondary{% else %}btn-primary{% endif %} btn-sm" id="follow-btn" data-user-id="{{ target_user.id }}" data-csrf="{{ csrf_token }}">
                                        {% if is_following %}
                                            取消关注
                                        {% else %}
                                            关注
                                        {% endif %}
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            <!-- 粉丝数和关注数 -->
                            <div class="d-flex mt-2">
                                <span class="me-3">关注: <span class="following-count">{{ following_count }}</span></span>
                                <span>粉丝: <span class="followers-count">{{ followers_count }}</span></span>
                            </div>
                        </div>
                    </div>
                    
                    {% if target_user == user %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">用户名</label>
                            {{ form.username }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">邮箱</label>
                            {{ form.email }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.avatar.id_for_label }}" class="form-label">头像</label>
                            {{ form.avatar }}
                        </div>
                        <button type="submit" class="btn btn-primary">更新信息</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            
            {% if target_user == user %}
            <!-- 用户活动导航 -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="userActivityTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#albums">我的相册</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#likes">我的点赞</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#favorites">我的收藏</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#views">最近浏览</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="userActivityTabsContent">
                        <!-- 我的相册 -->
                        <div class="tab-pane fade show active" id="albums">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">我的相册</h5>
                                <a href="{% url 'user_albums' target_user.id %}" class="btn btn-primary btn-sm">查看所有</a>
                            </div>
                            {% if user_albums %}
                                <p>您已上传 {{ user_albums|length }} 个相册</p>
                                <div class="row">
                                    {% for album in user_albums %}
                                        {% with first_photo=album.photo_set.first %}
                                        {% if first_photo %}
                                        <div class="col-md-3 mb-3">
                                            <div class="card">
                                                <a href="{% url 'photo_detail' first_photo.pk %}">
                                                    <img src="{{ first_photo.display_image.url }}" class="card-img-top" alt="{{ album.title }}" style="height: 150px; object-fit: cover;">
                                                </a>
                                                <div class="card-body p-2">
                                                    <h6 class="card-title text-truncate mb-1">{{ album.title }}</h6>
                                                    <small class="text-muted">{{ album.photo_set.count }} 张照片</small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                <a href="{% url 'upload_photo' %}" class="btn btn-success btn-sm">上传相册</a>
                            {% else %}
                                <p>您还没有上传任何相册。</p>
                                <a href="{% url 'upload_photo' %}" class="btn btn-primary">上传相册</a>
                            {% endif %}
                        </div>
                        
                        <!-- 我的点赞 -->
                        <div class="tab-pane fade" id="likes">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">我的点赞</h5>
                                <a href="{% url 'liked_photos' %}" class="btn btn-primary btn-sm">查看所有</a>
                            </div>
                            {% if likes %}
                                <p>您已点赞 {{ likes.count }} 张照片</p>
                                <div class="row">
                                    {% for like in likes|slice:":4" %}
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <a href="{% url 'photo_detail' like.photo.pk %}">
                                                <img src="{{ like.photo.display_image.url }}" class="card-img-top" alt="{{ like.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ like.photo.title }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>您还没有点赞任何照片。</p>
                            {% endif %}
                        </div>
                        
                        <!-- 我的收藏 -->
                        <div class="tab-pane fade" id="favorites">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">我的收藏</h5>
                                <a href="{% url 'favorited_photos' %}" class="btn btn-primary btn-sm">查看所有</a>
                            </div>
                            {% if favorites %}
                                <p>您已收藏 {{ favorites.count }} 张照片</p>
                                <div class="row">
                                    {% for favorite in favorites|slice:":4" %}
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <a href="{% url 'photo_detail' favorite.photo.pk %}">
                                                <img src="{{ favorite.photo.display_image.url }}" class="card-img-top" alt="{{ favorite.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ favorite.photo.title }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>您还没有收藏任何照片。</p>
                            {% endif %}
                        </div>
                        
                        <!-- 最近浏览 -->
                        <div class="tab-pane fade" id="views">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">最近浏览</h5>
                                <a href="{% url 'viewed_photos' %}" class="btn btn-primary btn-sm">查看所有</a>
                            </div>
                            {% if view_history %}
                                <p>您最近浏览了 {{ view_history|length }} 张照片</p>
                                <div class="row">
                                    {% for view in view_history %}
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <a href="{% url 'photo_detail' view.photo.pk %}">
                                                <img src="{{ view.photo.display_image.url }}" class="card-img-top" alt="{{ view.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ view.photo.title }}</h6>
                                                <small class="text-muted">{{ view.viewed_at|date:"Y-m-d H:i" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p>您还没有浏览历史。</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
        
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 关注按钮处理
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const button = this;
            
            fetch(`/toggle-follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 更新按钮文本和样式
                if (data.is_following) {
                    button.textContent = '取消关注';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                } else {
                    button.textContent = '关注';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                }
                
                // 更新关注和粉丝数显示
                document.querySelector('.followers-count').textContent = data.followers_count;
                document.querySelector('.following-count').textContent = data.following_count;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        });
    }
});
</script>
{% endblock %}