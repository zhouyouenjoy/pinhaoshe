{% extends 'base.html' %}

{% block title %}{{ target_user.username }}的信息{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container">
    <div class="row">
        <div class="col-md-8 mx-auto">

            
            <!-- 用户信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>个人信息</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        {% if target_user.userprofile.avatar %}
                            <img src="{{ target_user.userprofile.avatar.url }}" alt="头像" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
                                <span class="text-white" style="font-size: 2rem;">{{ target_user.username|first|upper }}</span>
                            </div>
                        {% endif %}
                        <div>
                            <h5>{{ target_user.username }}</h5>
                            <p class="text-muted mb-0">{{ target_user.userprofile.email|default:"未设置邮箱" }}</p>
                            <!-- 粉丝数和关注数 -->
                            <div class="d-flex mt-2">
                                <span class="me-3">关注: <span class="following-count">{{ following_count }}</span></span>
                                <span>粉丝: <span class="followers-count">{{ followers_count }}</span></span>
                            </div>
                        </div>
                    </div>
                    
                    {% if target_user == user %}
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">用户名</label>
                            {{ form.username }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">邮箱</label>
                            {{ form.email }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.avatar.id_for_label }}" class="form-label">头像</label>
                            {{ form.avatar }}
                        </div>
                        <button type="submit" class="btn btn-primary">更新信息</button>
                    </form>
                    {% elif user.is_authenticated %}
                    <div class="mt-3">
                        <button class="btn {% if is_following %}btn-secondary{% else %}btn-primary{% endif %}" id="follow-btn" data-user-id="{{ target_user.id }}" data-csrf="{{ csrf_token }}">
                            {% if is_following %}
                                取消关注
                            {% else %}
                                关注
                            {% endif %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if target_user == user %}
            <!-- 点赞的照片 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>我点赞的照片</h5>
                </div>
                <div class="card-body">
                    {% if likes %}
                        <p>您已点赞 {{ likes.count }} 张照片</p>
                        <a href="{% url 'liked_photos' %}" class="btn btn-primary">查看所有点赞</a>
                    {% else %}
                        <p>您还没有点赞任何照片。</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- 收藏的照片 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>我收藏的照片</h5>
                </div>
                <div class="card-body">
                    {% if favorites %}
                        <p>您已收藏 {{ favorites.count }} 张照片</p>
                        <a href="{% url 'favorited_photos' %}" class="btn btn-primary">查看所有收藏</a>
                    {% else %}
                        <p>您还没有收藏任何照片。</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- 浏览历史 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>最近浏览</h5>
                </div>
                <div class="card-body">
                    {% if view_history %}
                        <p>您最近浏览了 {{ view_history|length }} 张照片</p>
                        <a href="{% url 'viewed_photos' %}" class="btn btn-primary">查看所有浏览历史</a>
                    {% else %}
                        <p>您还没有浏览历史。</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- 用户上传的相册 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>
                        {% if target_user == user %}
                            我上传的相册
                        {% else %}
                            {{ target_user.username }}上传的相册
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_albums %}
                        <p>
                            {% if target_user == user %}
                                您已上传 {{ user_albums|length }} 个相册
                            {% else %}
                                {{ target_user.username }}已上传 {{ user_albums|length }} 个相册
                            {% endif %}
                        </p>
                        <div class="row">
                            {% for album in user_albums %}
                                {% with first_photo=album.photo_set.first %}
                                {% if first_photo %}
                                <div class="col-md-3 mb-3">
                                    <div class="card">
                                        <a href="{% url 'photo_detail' first_photo.pk %}">
                                            <img src="{{ first_photo.display_image.url }}" class="card-img-top" alt="{{ album.title }}" style="height: 150px; object-fit: cover;">
                                        </a>
                                        <div class="card-body p-2">
                                            <h6 class="card-title text-truncate mb-1">{{ album.title }}</h6>
                                            <small class="text-muted">{{ album.photo_set.count }} 张照片</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>
                        <a href="{% url 'user_albums' target_user.id %}" class="btn btn-primary">查看所有相册</a>
                    {% else %}
                        {% if target_user == user %}
                            <p>您还没有上传任何相册。</p>
                            <a href="{% url 'upload_photo' %}" class="btn btn-primary">上传相册</a>
                        {% else %}
                            <p>{{ target_user.username }}还没有上传任何相册。</p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 关注按钮处理
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const button = this;
            
            fetch(`/toggle-follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 更新按钮文本和样式
                if (data.is_following) {
                    button.textContent = '取消关注';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-secondary');
                } else {
                    button.textContent = '关注';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-primary');
                }
                
                // 更新关注和粉丝数显示
                document.querySelector('.followers-count').textContent = data.followers_count;
                document.querySelector('.following-count').textContent = data.following_count;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        });
    }
});
</script>
{% endblock %}