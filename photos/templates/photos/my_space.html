{% extends 'common.html' %}

{% load form_extras %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/photos/my_space.css' %}">
{% endblock %}

{% block title %}{{ target_user.username }}的个人空间{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block og_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block og_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block og_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block twitter_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block twitter_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block twitter_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
            <!-- 用户信息 -->
            <div class="profile-card mb-4">
                <div class="profile-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <a href="#" onclick="history.back(); return false;" class="text-white" style="font-size: 1.5rem;">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <h3 class="mb-0 flex-grow-1 text-center">{{ target_user.username }}的个人空间</h3>
                        <div style="width: 36px;"></div> <!-- 占位元素，保持标题居中 -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row align-items-center mb-4">
                        {% if target_user.userprofile.avatar_url %}
                            <img src="{{ target_user.userprofile.avatar_url }}" alt="头像" class="rounded-circle me-0 me-md-4 mb-3 mb-md-0 avatar-preview">
                        {% else %}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-0 me-md-4 mb-3 mb-md-0 avatar-preview">
                                <span class="text-white" style="font-size: 2rem;">{{ target_user.username|first|upper }}</span>
                            </div>
                        {% endif %}
                        <div class="flex-grow-1 text-center text-md-start">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                                <div class="mb-3 mb-md-0">
                                    <h4 class="mb-1">{{ target_user.username }}</h4>
                                    <p class="text-muted mb-0">{{ target_user.userprofile.email|default:"未设置邮箱" }}</p>
                                </div>
                                {% if target_user != user and user.is_authenticated %}
                                <div class="d-flex">
                                    <a href="{% url 'photos:chat_view' target_user.id %}" class="btn btn-message">
                                        <i class="fas fa-envelope me-1"></i>私信
                                    </a>
                                    <button class="btn {% if is_following %}btn-secondary{% else %}btn-outline-primary{% endif %}" id="follow-btn" data-user-id="{{ target_user.id }}" data-csrf="{{ csrf_token }}">
                                        {% if is_following %}
                                            <i class="fas fa-user-minus me-1"></i>取消关注
                                        {% else %}
                                            <i class="fas fa-user-plus me-1"></i>关注
                                        {% endif %}
                                    </button>
                                </div>
                                {% elif target_user != user and not user.is_authenticated %}
                                <div class="d-flex">
                                    <a href="{% url 'login' %}?next={% url 'photos:chat_view' target_user.id %}" class="btn btn-message">
                                        <i class="fas fa-envelope me-1"></i>私信
                                    </a>
                                    <a href="{% url 'login' %}" class="btn btn-outline-primary">
                                        <i class="fas fa-user-plus me-1"></i>关注
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            <!-- 粉丝数和关注数 -->
                            <div class="d-flex justify-content-center justify-content-md-start mt-3">
                                <div class="text-center mx-3">
                                    <div class="stats-number">{{ following_count }}</div>
                                    <small class="text-muted">关注</small>
                                </div>
                                <div class="text-center mx-3">
                                    <div class="stats-number">{{ followers_count }}</div>
                                    <small class="text-muted">粉丝</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if target_user == user %}
                    <form method="post" enctype="multipart/form-data" action="{% url 'photos:my_info_with_id' user_id=target_user.id %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.username.id_for_label }}" class="form-label small fw-bold">用户名</label>
                                {{ form.username }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label small fw-bold">邮箱</label>
                                {{ form.email }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.avatar.id_for_label }}" class="form-label small fw-bold">头像</label>
                                {{ form.avatar }}
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>更新信息
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
            
            <!-- 用户活动导航 -->
            <div class="profile-card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs d-flex" id="userActivityTabs">
                        <li class="nav-item flex-fill text-center">
                            <a class="nav-link active" data-bs-toggle="tab" href="#albums">
                                <i class="fas fa-images me-1"></i>相册
                            </a>
                        </li>
                        <li class="nav-item flex-fill text-center">
                            <a class="nav-link" data-bs-toggle="tab" href="#likes">
                                <i class="fas fa-heart me-1"></i>点赞
                            </a>
                        </li>
                        <li class="nav-item flex-fill text-center">
                            <a class="nav-link" data-bs-toggle="tab" href="#favorites">
                                <i class="fas fa-bookmark me-1"></i>收藏
                            </a>
                        </li>
                        <li class="nav-item flex-fill text-center">
                            <a class="nav-link" data-bs-toggle="tab" href="#views">
                                <i class="fas fa-eye me-1"></i>浏览
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="tab-content" id="userActivityTabsContent">
                    <!-- 相册 -->
                    <div class="tab-pane fade show active" id="albums">
                        {% if user_albums %}

                            <!-- 瀑布流布局容器 -->
                            <div class="masonry-grid" id="albums-masonry-grid">
                                {% for album in user_albums%}
                                    
                                {% endfor %}
                            </div>
                            
                            <!-- 用于Intersection Observer的观察元素 -->
                            <div id="albums-sentinel"></div>
                            
                            <!-- 加载更多按钮和加载指示器 -->
                            <div id="albums-load-more-container" class="text-center my-4">
                                <button id="albums-load-more-btn" class="btn btn-primary">加载更多</button>
                                <div id="albums-loading-spinner" class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        {% else %}
                            {% if target_user == user %}
                                <div class="text-center py-5">
                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">您还没有上传任何相册。</p>
                                    <a href="{% url 'photos:upload_photo' %}" class="btn btn-primary">上传相册</a>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">{{ target_user.username }}还没有上传任何相册。</p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- 点赞 -->
                    <div class="tab-pane fade" id="likes">
                        {% if likes %}
                            <div class="masonry-grid" id="likes-masonry-grid">
                                
                            </div>
                            <!-- 用于Intersection Observer的观察元素 -->
                            <div id="likes-sentinel"></div>
                            
                            <!-- 加载更多按钮和加载指示器 -->
                            <div id="likes-load-more-container" class="text-center my-4">
                                <button id="likes-load-more-btn" class="btn btn-primary">加载更多</button>
                                <div id="likes-loading-spinner" class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        {% else %}
                            {% if target_user == user %}
                                <div class="text-center py-5">
                                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">您还没有点赞任何照片。</p>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">{{ target_user.username }}还没有点赞任何照片。</p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- 收藏 -->
                    <div class="tab-pane fade" id="favorites">
                        {% if favorites %}
                            <div class="section-header">
                                <p class="left section-title">
                                    {% if target_user == user %}
                                        您已收藏 {{ favorites.count }} 张照片
                                    {% else %}
                                        {{ target_user.username }}已收藏 {{ favorites.count }} 张照片
                                    {% endif %}
                                </p>
                                <a href="{% url 'photos:user_favorited_photos' target_user.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>查看所有
                                </a>
                            </div>
                            <div class="row row-cols-2 row-cols-md-4 g-1">
                                {% for favorite in favorites|slice:":4" %}
                                <div class="col">
                                    <div class="card h-100">
                                        <a href="{% url 'photos:photo_detail' favorite.photo.pk %}">
                                            {% if favorite.photo.external_url %}
                                                <img src="{{ favorite.photo.external_url }}" class="card-img-top" alt="{{ favorite.photo.album.title }}">
                                            {% elif favorite.photo.display_image %}
                                                <img src="{{ favorite.photo.display_image.url }}" class="card-img-top" alt="{{ favorite.photo.album.title }}">
                                            {% elif favorite.photo.image %}
                                                <img src="{{ favorite.photo.image.url }}" class="card-img-top" alt="{{ favorite.photo.album.title }}">
                                            {% else %}
                                                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                                    <span class="text-muted">无图片</span>
                                                </div>
                                            {% endif %}
                                        </a>
                                        <div class="card-body p-1">
                                            <h6 class="card-title text-truncate mb-0">{{ favorite.photo.album.title }}</h6>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            {% if target_user == user %}
                                <div class="text-center py-5">
                                    <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">您还没有收藏任何照片。</p>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">{{ target_user.username }}还没有收藏任何照片。</p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- 浏览 -->
                    <div class="tab-pane fade" id="views">
                        {% if view_history %}
                            <div class="section-header">
                                <p class="left section-title">
                                    {% if target_user == user %}
                                        您最近浏览了 {{ view_history|length }} 张照片
                                    {% else %}
                                        {{ target_user.username }}最近浏览了 {{ view_history|length }} 张照片
                                    {% endif %}
                                </p>
                                <a href="{% url 'photos:user_viewed_photos' target_user.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>查看所有
                                </a>
                            </div>
                            <div class="row row-cols-2 row-cols-md-4 g-1">
                                {% for view in view_history|slice:":4" %}
                                <div class="col">
                                    <div class="card h-100">
                                        <a href="{% url 'photos:photo_detail' view.photo.pk %}">
                                            {% if view.photo.external_url %}
                                                <img src="{{ view.photo.external_url }}" class="card-img-top" alt="{{ view.photo.album.title }}">
                                            {% elif view.photo.display_image %}
                                                <img src="{{ view.photo.display_image.url }}" class="card-img-top" alt="{{ view.photo.album.title }}">
                                            {% elif view.photo.image %}
                                                <img src="{{ view.photo.image.url }}" class="card-img-top" alt="{{ view.photo.album.title }}">
                                            {% else %}
                                                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                                    <span class="text-muted">无图片</span>
                                                </div>
                                            {% endif %}
                                        </a>
                                        <div class="card-body p-1">
                                            <h6 class="card-title text-truncate mb-0">{{ view.photo.album.title }}</h6>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            {% if target_user == user %}
                                <div class="text-center py-5">
                                    <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">您还没有浏览历史。</p>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">{{ target_user.username }}还没有浏览历史。</p>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // 关注按钮处理
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const button = this;
            
            // 如果是取消关注，显示确认对话框
            // 使用更可靠的方式检查是否是取消关注状态
            const isUnfollowing = button.classList.contains('btn-secondary') || button.innerHTML.includes('取消关注');
            if (isUnfollowing) {
                if (!confirm('确定要取消关注吗？')) {
                    return; // 用户取消操作
                }
            }
            
            // 获取CSRF令牌
            let csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || followBtn.getAttribute('data-csrf');
            
            // 修复URL路径，使用正确的Django URL命名空间
            fetch(`/photos/toggle-follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // 检查HTTP响应状态
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // 检查服务器返回的数据是否有错误
                if (data && data.error) {
                    alert(data.error);
                    return;
                }
                
                // 确保数据存在且格式正确
                if (!data || typeof data.is_following === 'undefined') {
                    throw new Error('Invalid response data');
                }
                
                // 更新按钮文本和样式
                if (data.is_following) {
                    button.innerHTML = '<i class="fas fa-user-minus me-1"></i>取消关注';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-secondary');
                } else {
                    button.innerHTML = '<i class="fas fa-user-plus me-1"></i>关注';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-outline-primary');
                }
                
                // 更新关注和粉丝数显示（如果元素存在）
                const followingElement = document.querySelector('.stats-number:first-child');
                const followersElement = document.querySelector('.stats-number:last-child');
                
                if (followingElement && data.following_count !== undefined) {
                    followingElement.textContent = data.following_count;
                }
                
                if (followersElement && data.followers_count !== undefined) {
                    followersElement.textContent = data.followers_count;
                }
            })
            .catch(error => {
                console.error('Follow toggle error:', error);
                // 只在确实发生错误时才显示提示
                // 不在用户取消操作或正常流程中显示错误
                if (error.name !== 'AbortError' && !error.message.includes('cancelled')) {
                    alert('操作失败，请重试');
                }
            });
        });
    }
    
    // 相册懒加载功能
    const albumsMasonryGrid = document.getElementById('albums-masonry-grid');
    const albumsLoadMoreBtn = document.getElementById('albums-load-more-btn');
    const albumsLoadingSpinner = document.getElementById('albums-loading-spinner');
    const albumsLoadMoreContainer = document.getElementById('albums-load-more-container');
    const albumsSentinel = document.getElementById('albums-sentinel');
    
    // 如果没有瀑布流容器，则不需要懒加载
    if (albumsMasonryGrid) {
        let page = 1;
        let isLoading = false;
        let hasNext = true;
        
        // 初始化加载更多按钮显示状态
        function initLoadMore() {
            if (hasNext) {
                albumsLoadMoreContainer.style.display = 'block';
            } else {
                albumsLoadMoreContainer.style.display = 'none';
            }
        }
        
        // 加载更多相册
        function loadMoreAlbums() {
            // 如果正在加载或没有更多内容，则返回
            if (isLoading || !hasNext) return;
            
            isLoading = true;
            albumsLoadMoreBtn.style.display = 'none';
            albumsLoadingSpinner.style.display = 'inline-block';
            
            // 构造URL
            const url = `{% url 'photos:user_albums' target_user.id %}?page=${page}`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    // 将新内容添加到瀑布流容器中
                    albumsMasonryGrid.insertAdjacentHTML('beforeend', data.html);
                    page = data.next_page ;
                    hasNext = data.has_next;
                }
            })
            .catch(error => {
                console.error('加载更多相册时出错:', error);
            })
            .finally(() => {
                isLoading = false;
                albumsLoadMoreBtn.style.display = 'inline-block';
                albumsLoadingSpinner.style.display = 'none';
                initLoadMore();
            });
        }
        
        // 创建 Intersection Observer
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                // 当 sentinel 元素进入视口时加载更多内容
                if (entry.isIntersecting && hasNext && !isLoading) {
                    loadMoreAlbums();
                }
            });
        }, {
            rootMargin: '100px' // 提前100px触发加载
        });
        
        // 开始观察 sentinel 元素
        if (albumsSentinel) {
            observer.observe(albumsSentinel);
        }
        
        // 点击加载更多按钮时也加载内容
        if (albumsLoadMoreBtn) {
            albumsLoadMoreBtn.addEventListener('click', loadMoreAlbums);
        }
        
        // 初始化
        initLoadMore();
    }
    
    // 点赞照片懒加载功能
    const likesMasonryGrid = document.getElementById('likes-masonry-grid');
    const likesLoadMoreBtn = document.getElementById('likes-load-more-btn');
    const likesLoadingSpinner = document.getElementById('likes-loading-spinner');
    const likesLoadMoreContainer = document.getElementById('likes-load-more-container');
    const likesSentinel = document.getElementById('likes-sentinel');
    
    // 如果没有瀑布流容器，则不需要懒加载
    if (likesMasonryGrid) {
        let page = 1;
        let isLoading = false;
        let hasNext = true;
        
        // 初始化加载更多按钮显示状态
        function initLikesLoadMore() {
            if (hasNext) {
                likesLoadMoreContainer.style.display = 'block';
            } else {
                likesLoadMoreContainer.style.display = 'none';
            }
        }
        
        // 加载更多点赞照片
        function loadMoreLikes() {
            // 如果正在加载或没有更多内容，则返回
            if (isLoading || !hasNext) return;
            
            isLoading = true;
            likesLoadMoreBtn.style.display = 'none';
            likesLoadingSpinner.style.display = 'inline-block';
            
            // 构造URL
            const url = `{% url 'photos:user_liked_photos' target_user.id %}?page=${page}`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    // 将新内容添加到瀑布流容器中
                    likesMasonryGrid.insertAdjacentHTML('beforeend', data.html);
                    page = data.next_page;
                    hasNext = data.has_next;
                }
            })
            .catch(error => {
                console.error('加载更多点赞照片时出错:', error);
            })
            .finally(() => {
                isLoading = false;
                likesLoadMoreBtn.style.display = 'inline-block';
                likesLoadingSpinner.style.display = 'none';
                initLikesLoadMore();
            });
        }
        
        // 创建 Intersection Observer
        const likesObserver = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                // 当 sentinel 元素进入视口时加载更多内容
                if (entry.isIntersecting && hasNext && !isLoading) {
                    loadMoreLikes();
                }
            });
        }, {
            rootMargin: '100px' // 提前100px触发加载
        });
        
        // 开始观察 sentinel 元素
        if (likesSentinel) {
            likesObserver.observe(likesSentinel);
        }
        
        // 点击加载更多按钮时也加载内容
        if (likesLoadMoreBtn) {
            likesLoadMoreBtn.addEventListener('click', loadMoreLikes);
        }
        
        // 初始化
        initLikesLoadMore();
        
        // 页面加载完成后自动加载第一页内容
        if (likesMasonryGrid) {
            loadMoreLikes();
        }
    }
});
</script>
{% endblock %}