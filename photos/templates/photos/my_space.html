{% extends 'base.html' %}

{% load form_extras %}
{% load static %}

{% block title %}{{ target_user.username }}的个人空间{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block og_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block og_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block og_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block twitter_title %}{{ target_user.username }}的个人空间{% endblock %}
{% block twitter_description %}{{ target_user.username }}在拼好摄的个人空间，分享精彩摄影作品。{% endblock %}
{% block twitter_image %}{% if target_user.userprofile.avatar %}{{ request.build_absolute_uri }}{{ target_user.userprofile.avatar.url }}{% else %}{{ request.build_absolute_uri }}{% static 'images/default-avatar.png' %}{% endif %}{% endblock %}

{% block content %}
<style>
    .profile-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #68cfcb 0%, #465054 100%);
        padding: 20px;
    }
    .profile-card {
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        box-shadow: rgba(0,0,0,0.1) 0 10px 50px;
        backdrop-filter: blur(10px);
        width: 100%;
        margin-bottom: 20px;
    }
    .profile-header {
        background: linear-gradient(135deg, #66c5ea 0%, #d655a0 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 20px;
        text-align: center;
    }
    .nav-tabs .nav-link {
        font-weight: 500;
        border: none;
        border-radius: 8px 8px 0 0;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active {
        color: #66c5ea;
        background-color: #fff;
        border-color: transparent;
        font-weight: bold;
    }
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        background-color: rgba(102, 197, 234, 0.1);
    }
    .tab-content {
        padding: 20px;
    }
    .btn-primary {
        background: linear-gradient(135deg, #66c5ea 0%, #d655a0 100%);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 197, 234, 0.3);
    }
    .btn-outline-primary {
        border: 1px solid #66c5ea;
        color: #66c5ea;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #66c5ea 0%, #d655a0 100%);
        border-color: #66c5ea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 197, 234, 0.3);
    }
    .btn-secondary {
        background: linear-gradient(135deg, #a0a0a0 0%, #707070 100%);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
        font-size: 14px;
    }
    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(160, 160, 160, 0.3);
    }
    .btn-message {
        background: linear-gradient(135deg, #6fca95 0%, #33a89e 100%);
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
        font-size: 14px;
        color: white;
        margin-right: 10px;
    }
    .btn-message:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(111, 202, 149, 0.3);
        color: white;
    }
    .photo-grid .card {
        border-radius: 10px;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .photo-grid .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .photo-grid .card-img-top {
        border-radius: 10px 10px 0 0;
        object-fit: cover;
    }
    .form-control {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        height: 50px;
    }
    .form-control:focus {
        border-color: #66c5ea;
        box-shadow: 0 0 0 3px rgba(102, 197, 234, 0.2);
    }
    textarea.form-control {
        height: auto;
        min-height: 100px;
    }
    .avatar-preview {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .stats-number {
        font-weight: bold;
        font-size: 1.2rem;
        color: #66c5ea;
    }
</style>

<div class="profile-container p-3">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">
                <!-- 用户信息 -->
                <div class="profile-card mb-4">
                    <div class="profile-header">
                        <h3>{{ target_user.username }}的个人空间</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-column flex-md-row align-items-center mb-4">
                            {% if target_user.userprofile.avatar %}
                                <img src="{{ target_user.userprofile.avatar.url }}" alt="头像" class="rounded-circle me-0 me-md-4 mb-3 mb-md-0 avatar-preview">
                            {% else %}
                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-0 me-md-4 mb-3 mb-md-0 avatar-preview">
                                    <span class="text-white" style="font-size: 2rem;">{{ target_user.username|first|upper }}</span>
                                </div>
                            {% endif %}
                            <div class="flex-grow-1 text-center text-md-start">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                                    <div class="mb-3 mb-md-0">
                                        <h4 class="mb-1">{{ target_user.username }}</h4>
                                        <p class="text-muted mb-0">{{ target_user.userprofile.email|default:"未设置邮箱" }}</p>
                                    </div>
                                    {% if target_user != user and user.is_authenticated %}
                                    <div class="d-flex">
                                        <a href="{% url 'photos:chat_view' target_user.id %}" class="btn btn-message">
                                            <i class="fas fa-envelope me-1"></i>私信
                                        </a>
                                        <button class="btn {% if is_following %}btn-secondary{% else %}btn-outline-primary{% endif %}" id="follow-btn" data-user-id="{{ target_user.id }}" data-csrf="{{ csrf_token }}">
                                            {% if is_following %}
                                                <i class="fas fa-user-minus me-1"></i>取消关注
                                            {% else %}
                                                <i class="fas fa-user-plus me-1"></i>关注
                                            {% endif %}
                                        </button>
                                    </div>
                                    {% elif target_user != user and not user.is_authenticated %}
                                    <div class="d-flex">
                                        <a href="{% url 'login' %}?next={% url 'photos:chat_view' target_user.id %}" class="btn btn-message">
                                            <i class="fas fa-envelope me-1"></i>私信
                                        </a>
                                        <a href="{% url 'login' %}" class="btn btn-outline-primary">
                                            <i class="fas fa-user-plus me-1"></i>关注
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                <!-- 粉丝数和关注数 -->
                                <div class="d-flex justify-content-center justify-content-md-start mt-3">
                                    <div class="text-center mx-3">
                                        <div class="stats-number">{{ following_count }}</div>
                                        <small class="text-muted">关注</small>
                                    </div>
                                    <div class="text-center mx-3">
                                        <div class="stats-number">{{ followers_count }}</div>
                                        <small class="text-muted">粉丝</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if target_user == user %}
                        <form method="post" enctype="multipart/form-data" action="{% url 'photos:my_info_with_id' user_id=target_user.id %}">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.username.id_for_label }}" class="form-label small fw-bold">用户名</label>
                                    {{ form.username }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label small fw-bold">邮箱</label>
                                    {{ form.email }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.avatar.id_for_label }}" class="form-label small fw-bold">头像</label>
                                    {{ form.avatar }}
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>更新信息
                                </button>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 用户活动导航 -->
                <div class="profile-card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="userActivityTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#albums">
                                    <i class="fas fa-images me-1"></i>相册
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#likes">
                                    <i class="fas fa-heart me-1"></i>点赞
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#favorites">
                                    <i class="fas fa-bookmark me-1"></i>收藏
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#views">
                                    <i class="fas fa-eye me-1"></i>浏览
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content" id="userActivityTabsContent">
                        <!-- 相册 -->
                        <div class="tab-pane fade show active" id="albums">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">{{ target_user.username }}的相册</h5>
                                <a href="{% url 'photos:user_albums' target_user.id %}" class="btn btn-primary btn-sm">查看所有</a>
                            </div>
                            {% if user_albums %}
                                <p>
                                    {% if target_user == user %}
                                        您已上传 {{ user_albums|length }} 个相册
                                    {% else %}
                                        {{ target_user.username }}已上传 {{ user_albums|length }} 个相册
                                    {% endif %}
                                </p>
                                <div class="row row-cols-2 row-cols-md-4 g-3">
                                    {% for album in user_albums|slice:":4" %}
                                        {% with first_photo=album.photo_set.first %}
                                        {% if first_photo %}
                                        <div class="col">
                                            <div class="card h-100">
                                                <a href="{% url 'photos:photo_detail' first_photo.pk %}">
                                                    <img src="{{ first_photo.display_image.url }}" class="card-img-top" alt="{{ album.title }}" style="height: 150px; object-fit: cover;">
                                                </a>
                                                <div class="card-body p-2">
                                                    <h6 class="card-title text-truncate mb-1">{{ album.title }}</h6>
                                                    <small class="text-muted">{{ album.photo_set.count }} 张照片</small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                <div class="mt-3">
                                    <a href="{% url 'photos:user_albums' target_user.id %}" class="btn btn-primary">查看所有相册</a>
                                    {% if target_user == user %}
                                    <a href="{% url 'photos:upload_photo' %}" class="btn btn-success">上传相册</a>
                                    {% endif %}
                                </div>
                            {% else %}
                                {% if target_user == user %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">您还没有上传任何相册。</p>
                                        <a href="{% url 'photos:upload_photo' %}" class="btn btn-primary">上传相册</a>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">{{ target_user.username }}还没有上传任何相册。</p>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- 点赞 -->
                        <div class="tab-pane fade" id="likes">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">
                                    {% if target_user == user %}
                                        我的点赞
                                    {% else %}
                                        {{ target_user.username }}的点赞
                                    {% endif %}
                                </h5>
                                <a href="{% url 'photos:user_liked_photos' target_user.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>查看所有
                                </a>
                            </div>
                            {% if likes %}
                                <p>
                                    {% if target_user == user %}
                                        您已点赞 {{ likes.count }} 张照片
                                    {% else %}
                                        {{ target_user.username }}已点赞 {{ likes.count }} 张照片
                                    {% endif %}
                                </p>
                                <div class="row row-cols-2 row-cols-md-4 g-3">
                                    {% for like in likes|slice:":4" %}
                                    <div class="col">
                                        <div class="card h-100">
                                            <a href="{% url 'photos:photo_detail' like.photo.pk %}">
                                                <img src="{{ like.photo.display_image.url }}" class="card-img-top" alt="{{ like.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ like.photo.title }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% if target_user == user %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">您还没有点赞任何照片。</p>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">{{ target_user.username }}还没有点赞任何照片。</p>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- 收藏 -->
                        <div class="tab-pane fade" id="favorites">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">
                                    {% if target_user == user %}
                                        我的收藏
                                    {% else %}
                                        {{ target_user.username }}的收藏
                                    {% endif %}
                                </h5>
                                <a href="{% url 'photos:user_favorited_photos' target_user.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>查看所有
                                </a>
                            </div>
                            {% if favorites %}
                                <p>
                                    {% if target_user == user %}
                                        您已收藏 {{ favorites.count }} 张照片
                                    {% else %}
                                        {{ target_user.username }}已收藏 {{ favorites.count }} 张照片
                                    {% endif %}
                                </p>
                                <div class="row row-cols-2 row-cols-md-4 g-3">
                                    {% for favorite in favorites|slice:":4" %}
                                    <div class="col">
                                        <div class="card h-100">
                                            <a href="{% url 'photos:photo_detail' favorite.photo.pk %}">
                                                <img src="{{ favorite.photo.display_image.url }}" class="card-img-top" alt="{{ favorite.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ favorite.photo.title }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% if target_user == user %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">您还没有收藏任何照片。</p>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">{{ target_user.username }}还没有收藏任何照片。</p>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- 浏览 -->
                        <div class="tab-pane fade" id="views">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0">
                                    {% if target_user == user %}
                                        最近浏览
                                    {% else %}
                                        {{ target_user.username }}的浏览
                                    {% endif %}
                                </h5>
                                <a href="{% url 'photos:user_viewed_photos' target_user.id %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-list me-1"></i>查看所有
                                </a>
                            </div>
                            {% if view_history %}
                                <p>
                                    {% if target_user == user %}
                                        您最近浏览了 {{ view_history|length }} 张照片
                                    {% else %}
                                        {{ target_user.username }}最近浏览了 {{ view_history|length }} 张照片
                                    {% endif %}
                                </p>
                                <div class="row row-cols-2 row-cols-md-4 g-3">
                                    {% for view in view_history|slice:":4" %}
                                    <div class="col">
                                        <div class="card h-100">
                                            <a href="{% url 'photos:photo_detail' view.photo.pk %}">
                                                <img src="{{ view.photo.display_image.url }}" class="card-img-top" alt="{{ view.photo.title }}" style="height: 150px; object-fit: cover;">
                                            </a>
                                            <div class="card-body p-2">
                                                <h6 class="card-title text-truncate mb-1">{{ view.photo.title }}</h6>
                                                <small class="text-muted">{{ view.viewed_at|date:"Y-m-d H:i" }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {% if target_user == user %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">您还没有浏览历史。</p>
                                    </div>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-eye fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">{{ target_user.username }}还没有浏览历史。</p>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 关注按钮处理
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const button = this;
            
            // 如果是取消关注，显示确认对话框
            // 使用更可靠的方式检查是否是取消关注状态
            const isUnfollowing = button.classList.contains('btn-secondary') || button.innerHTML.includes('取消关注');
            if (isUnfollowing) {
                if (!confirm('确定要取消关注吗？')) {
                    return; // 用户取消操作
                }
            }
            
            // 获取CSRF令牌
            let csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || followBtn.getAttribute('data-csrf');
            
            // 修复URL路径，使用正确的Django URL命名空间
            fetch(`/photos/toggle-follow/${userId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // 检查HTTP响应状态
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // 检查服务器返回的数据是否有错误
                if (data && data.error) {
                    alert(data.error);
                    return;
                }
                
                // 确保数据存在且格式正确
                if (!data || typeof data.is_following === 'undefined') {
                    throw new Error('Invalid response data');
                }
                
                // 更新按钮文本和样式
                if (data.is_following) {
                    button.innerHTML = '<i class="fas fa-user-minus me-1"></i>取消关注';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-secondary');
                } else {
                    button.innerHTML = '<i class="fas fa-user-plus me-1"></i>关注';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-outline-primary');
                }
                
                // 更新关注和粉丝数显示（如果元素存在）
                const followingElement = document.querySelector('.stats-number:first-child');
                const followersElement = document.querySelector('.stats-number:last-child');
                
                if (followingElement && data.following_count !== undefined) {
                    followingElement.textContent = data.following_count;
                }
                
                if (followersElement && data.followers_count !== undefined) {
                    followersElement.textContent = data.followers_count;
                }
            })
            .catch(error => {
                console.error('Follow toggle error:', error);
                // 只在确实发生错误时才显示提示
                // 不在用户取消操作或正常流程中显示错误
                if (error.name !== 'AbortError' && !error.message.includes('cancelled')) {
                    alert('操作失败，请重试');
                }
            });
        });
    }
});
</script>
{% endblock %}