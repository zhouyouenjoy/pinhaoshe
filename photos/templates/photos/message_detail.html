{% extends 'base.html' %}

{% block title %}私信记录{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                
                <div class="card-body">
                    {% if message %}      
                        {% if conversation %}
                            <!-- 显示对话历史 -->
                            <div class="conversation-history" id="conversationContainer" style="height: 500px; overflow-y: auto;">
                                <!-- 默认只显示最近的10条消息，按时间顺序排列（最新的在底部） -->
                                {% for msg in conversation|slice:":10"|dictsort:"sent_at" %}
                                    <div class="border p-3 mb-3 rounded {% if msg.sender == request.user %}bg-light ms-auto text-end{% else %}bg-white me-auto{% endif %}" style="max-width: 80%;" data-message-id="{{ msg.id }}">
                                        <div class="d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %} align-items-center">
                                            {% if msg.sender != request.user %}
                                                <a href="{% url 'photos:my_info_with_id' msg.sender.id %}">
                                                    {% if msg.sender.userprofile.avatar %}
                                                        <img src="{{ msg.sender.userprofile.avatar.url }}" alt="{{ msg.sender.username }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                                                            <span class="text-white" style="font-size: 0.7rem;">{{ msg.sender.username|first|upper }}</span>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                                <strong>{{ msg.sender.username }}</strong>
                                                <small class="ms-4">{{ message.sent_at|date:"Y-m-d H:i" }}</small>
                                            {% endif %}
                                            {% if msg.sender == request.user %}
                                                <small>{{ message.sent_at|date:"Y-m-d H:i" }}</small>  
                                                <strong class="ms-4">{{ msg.sender.username }}</strong>
                                                <a href="{% url 'photos:my_info_with_id' msg.sender.id %}">
                                                    {% if msg.sender.userprofile.avatar %}
                                                        <img src="{{ msg.sender.userprofile.avatar.url }}" alt="{{ msg.sender.username }}" class="rounded-circle ms-2" style="width: 30px; height: 30px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                                                            <span class="text-white" style="font-size: 0.7rem;">{{ msg.sender.username|first|upper }}</span>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                            {% endif %}
                                        </div>
                                        <div class="mt-2">{{ msg.content|linebreaksbr }}</div>
                                        {% if not msg.is_read and msg.recipient == request.user and msg.sender != request.user %}
                                            <span class="badge bg-secondary mt-2">未读</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- 隐藏元素存储Django变量 -->
                            <div id="django-vars" style="display: none;" 
                                 data-conversation-length="{{ conversation|length }}">
                            </div>
                        {% endif %}
                    {% else %}
                        <p>私信不存在</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 固定在页面底部的回复模块 -->
<div class="container-fluid fixed-bottom bg-light p-3 border-top" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                {% if message.sender != request.user %}
                    <form id="sendMessageForm" class="d-flex me-2" style="flex-grow: 1; max-width: 600px;">
                        {% csrf_token %}
                        <input type="text" id="messageContent" class="form-control me-2" placeholder="输入回复内容..." required>
                        <button type="submit" class="btn btn-primary" id="sendMessageBtn">发送</button>
                    </form>
                {% elif message.recipient != request.user %}
                    <form id="sendMessageForm" class="d-flex me-2" style="flex-grow: 1; max-width: 600px;">
                        {% csrf_token %}
                        <input type="text" id="messageContent" class="form-control me-2" placeholder="输入回复内容..." required>
                        <button type="submit" class="btn btn-primary" id="sendMessageBtn">发送</button>
                    </form>
                {% else %}
                    <form id="sendMessageForm" class="d-flex me-2" style="flex-grow: 1; max-width: 600px;">
                        {% csrf_token %}
                        <input type="text" id="messageContent" class="form-control me-2" placeholder="输入回复内容..." required>
                        <button type="submit" class="btn btn-primary" id="sendMessageBtn">发送</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 引入jQuery用于AJAX请求 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
$(document).ready(function() {
    // 调整页面主体内容的底部边距，为固定在底部的回复框留出空间
    function adjustPageMargin() {
        const footerHeight = $('.fixed-bottom').outerHeight();
        $('body').css('padding-bottom', footerHeight + 'px');
    }
    
    // 页面加载完成后调整边距
    adjustPageMargin();
    
    // 窗口大小改变时重新调整边距
    $(window).resize(adjustPageMargin);
    
    // 滚动到最新的消息（最底部）
    function scrollToLatestMessage() {
        const container = $('.conversation-history');
        container.scrollTop(container[0].scrollHeight);
    }
    
    // 页面加载完成后滚动到最新消息
    scrollToLatestMessage();
    
    // 获取最后一条消息的ID，用于短轮询检查新消息
    let lastMessageId = 0;
    $('.conversation-history .border').each(function() {
        const messageId = parseInt($(this).data('message-id'));
        if (messageId > lastMessageId) {
            lastMessageId = messageId;
        }
    });
    
    // 短轮询检查新消息
    function checkNewMessages() {
        if (lastMessageId > 0) {
            $.ajax({
                url: '{% url "photos:check_new_messages" %}',
                method: 'GET',
                data: {
                    'last_message_id': lastMessageId,
                    'recipient_id': "{{ message.sender.id|default_if_none:'' }}"
                },
                success: function(response) {
                    if (response.messages && response.messages.length > 0) {
                        let messagesHtml = '';
                        // 按时间顺序排序消息
                        response.messages.sort(function(a, b) {
                            return new Date(a.sent_at) - new Date(b.sent_at);
                        });
                        
                        response.messages.forEach(function(msg) {
                            // 根据是否为自己发送的消息设置样式
                            const alignClass = msg.is_own ? 'bg-light ms-auto' : 'bg-white me-auto';
                            const textAlignStyle = msg.is_own ? 'text-align: right;' : '';
                            const timePositionClass = msg.is_own ? 'justify-content-end' : 'justify-content-start';
                            const senderInfo = msg.is_own ? 
                                `<small class="text-muted me-2">${msg.sent_at}</small>
                                 <strong>${msg.sender}</strong>` : 
                                `<strong>${msg.sender}</strong>
                                 <small class="text-muted ms-2">${msg.sent_at}</small>`;
                            const unreadBadge = !msg.is_read && !msg.is_own ? '<span class="badge bg-secondary mt-2">未读</span>' : '';
                            
                            // 头像HTML
                            let avatarHtml = '';
                            if (msg.sender_avatar) {
                                avatarHtml = `<img src="${msg.sender_avatar}" alt="${msg.sender}" class="rounded-circle ms-2" style="width: 30px; height: 30px; object-fit: cover;">`;
                            } else {
                                avatarHtml = `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                                                <span class="text-white" style="font-size: 0.7rem;">${msg.sender.charAt(0).toUpperCase()}</span>
                                              </div>`;
                            }
                            
                            let messageElement = `
                                <div class="border p-3 mb-3 rounded ${alignClass}" style="max-width: 80%; ${textAlignStyle}" data-message-id="${msg.id}">
                                    <div class="d-flex ${timePositionClass} align-items-center">
                                        ${!msg.is_own ? `<a href="/user/${msg.sender_id}/">${avatarHtml}</a>` : ''}
                                        ${msg.is_own ? `${senderInfo} <a href="/user/${msg.sender_id}/">${avatarHtml}</a>` : senderInfo}
                                    </div>
                                    <div class="mt-2">${msg.content}</div>
                                    ${unreadBadge}
                                </div>
                            `;
                            
                            messagesHtml += messageElement;
                            
                            // 更新最后消息ID
                            if (msg.id > lastMessageId) {
                                lastMessageId = msg.id;
                            }
                        });
                        
                        // 将新消息添加到对话容器末尾
                        $('.conversation-history').append(messagesHtml);
                        
                        // 滚动到最新消息
                        scrollToLatestMessage();
                    }
                },
                error: function(xhr, status, error) {
                    // 静默处理错误，避免频繁的错误提示
                    console.log('检查新消息失败:', error);
                }
            });
        }
    }
    
    // 每5秒检查一次新消息
    setInterval(checkNewMessages, 5000);
    
    // 下滑加载更多消息
    const conversationLength = parseInt($('#django-vars').data('conversation-length'));
    let hasMore = conversationLength > 10;
    let offset = 10;
    const conversationContainer = $('.conversation-history');
    
    conversationContainer.scroll(function() {
        // 检查是否滚动到顶部并且还有更多消息可以加载
        if ($(this).scrollTop() === 0 && !isLoading && hasMore) {
            isLoading = true;
            
            $.ajax({
                url: '{% url "photos:load_more_messages" %}',
                method: 'GET',
                data: {
                    'offset': offset,
                    'limit': 10,
                    'recipient_id': "{{ message.sender.id|default_if_none:'' }}"
                },
                success: function(response) {
                    if (response.messages && response.messages.length > 0) {
                        let messagesHtml = '';
                        // 按时间顺序排列消息（最新的在底部）
                        response.messages.sort(function(a, b) {
                            return new Date(a.sent_at) - new Date(b.sent_at);
                        });
                        
                        response.messages.forEach(function(msg) {
                            // 根据是否为自己发送的消息设置样式
                            const alignClass = msg.is_own ? 'bg-light ms-auto' : 'bg-white me-auto';
                            const textAlignStyle = msg.is_own ? 'text-align: right;' : '';
                            const timePositionClass = msg.is_own ? 'justify-content-end' : 'justify-content-start';
                            const senderInfo = msg.is_own ? 
                                `<small class="text-muted me-2">${msg.sent_at}</small>
                                 <strong>${msg.sender}</strong>` : 
                                `<strong>${msg.sender}</strong>
                                 <small class="text-muted ms-2">${msg.sent_at}</small>`;
                            const unreadBadge = !msg.is_read && !msg.is_own ? '<span class="badge bg-secondary mt-2">未读</span>' : '';
                            
                            // 头像HTML
                            let avatarHtml = '';
                            if (msg.sender_avatar) {
                                avatarHtml = `<img src="${msg.sender_avatar}" alt="${msg.sender}" class="rounded-circle ms-2" style="width: 30px; height: 30px; object-fit: cover;">`;
                            } else {
                                avatarHtml = `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                                                <span class="text-white" style="font-size: 0.7rem;">${msg.sender.charAt(0).toUpperCase()}</span>
                                              </div>`;
                            }
                            
                            let messageElement = `
                                <div class="border p-3 mb-3 rounded ${alignClass}" style="max-width: 80%; ${textAlignStyle}" data-message-id="${msg.id}">
                                    <div class="d-flex ${timePositionClass} align-items-center">
                                        ${!msg.is_own ? `<a href="/user/${msg.sender_id}/">${avatarHtml}</a>` : ''}
                                        ${msg.is_own ? `${senderInfo} <a href="/user/${msg.sender_id}/">${avatarHtml}</a>` : senderInfo}
                                    </div>
                                    <div class="mt-2">${msg.content}</div>
                                    ${unreadBadge}
                                </div>
                            `;
                            
                            messagesHtml = messageElement + messagesHtml;
                        });
                        
                        // 在容器开头插入新消息
                        $('.conversation-history').prepend(messagesHtml);
                        
                        // 更新偏移量
                        offset += response.messages.length;
                        
                        // 如果返回的消息少于请求数量，说明没有更多消息了
                        if (response.messages.length < 10) {
                            hasMore = false;
                        }
                    } else {
                        // 没有更多消息了
                        hasMore = false;
                    }
                    
                    isLoading = false;
                },
                error: function(xhr, status, error) {
                    alert('加载更多消息失败，请重试');
                    isLoading = false;
                }
            });
        }
    });

    // 发送消息表单提交处理
    $('#sendMessageForm').on('submit', function(e) {
        e.preventDefault();
        
        const content = $('#messageContent').val();
        if (!content.trim()) {
            alert('私信内容不能为空');
            return;
        }
        
        // 修复recipientId获取逻辑
        let recipientId = "{{ message.sender.id|default_if_none:'' }}";
        // 如果当前用户是消息发送者，则接收者应该是message.recipient
        if ("{{ message.sender.id }}" == "{{ request.user.id }}") {
            recipientId = "{{ message.recipient.id|default_if_none:'' }}";
        }
        
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').first().val();
        
        // 禁用发送按钮防止重复提交
        $('#sendMessageBtn').prop('disabled', true).text('发送中...');
        
        $.ajax({
            url: '{% url "photos:send_message" recipient_id=0 %}'.replace('0', recipientId),
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: {
                'content': content
            },
            success: function(response) {
                if (response.success) {
                    // 清空输入框
                    $('#messageContent').val('');
                    
                    // 创建用户自己发送的消息元素
                    const now = new Date();
                    const timeString = now.getFullYear() + '-' + 
                                      String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(now.getDate()).padStart(2, '0') + ' ' + 
                                      String(now.getHours()).padStart(2, '0') + ':' + 
                                      String(now.getMinutes()).padStart(2, '0') + ':' + 
                                      String(now.getSeconds()).padStart(2, '0');
                    
                    // 获取当前用户头像
                    let currentUserAvatar = '';
                    if ("{{ request.user.userprofile.avatar|yesno:'true,false' }}" === "true") {
                        currentUserAvatar = '{{ request.user.userprofile.avatar.url }}';
                    }
                    
                    // 头像HTML
                    let avatarHtml = '';
                    if (currentUserAvatar) {
                        avatarHtml = `<img src="${currentUserAvatar}" alt="{{ request.user.username }}" class="rounded-circle ms-2" style="width: 30px; height: 30px; object-fit: cover;">`;
                    } else {
                        avatarHtml = `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 30px; height: 30px;">
                                        <span class="text-white" style="font-size: 0.7rem;">{{ request.user.username|first|upper }}</span>
                                      </div>`;
                    }
                    
                    const senderInfo = `<small class="text-muted me-2">${timeString}</small><strong>{{ request.user.username }}</strong>`;
                    
                    const messageElement = `
                        <div class="border p-3 mb-3 rounded bg-light ms-auto" style="max-width: 80%; text-align: right;" data-message-id="${response.message.id}">
                            <div class="d-flex justify-content-end align-items-center">
                                ${senderInfo} <a href="{% url 'photos:my_info_with_id' request.user.id %}">${avatarHtml}</a>
                            </div>
                            <div class="mt-2">${response.message.content}</div>
                        </div>
                    `;
                    
                    // 将新消息添加到对话容器末尾
                    $('.conversation-history').append(messageElement);
                    
                    // 滚动到最新消息
                    scrollToLatestMessage();
                    
                    // 更新最后消息ID
                    if (response.message.id > lastMessageId) {
                        lastMessageId = response.message.id;
                    }
                    
                    // 启用发送按钮
                    $('#sendMessageBtn').prop('disabled', false).text('发送');
                } else {
                    alert('发送失败：' + response.error);
                    
                    // 启用发送按钮
                    $('#sendMessageBtn').prop('disabled', false).text('发送');
                }
            },
            error: function(xhr, status, error) {
                alert('发送失败，请重试');
                $('#sendMessageBtn').prop('disabled', false).text('发送');
            }
        });
    });
});
</script>
{% endblock %}