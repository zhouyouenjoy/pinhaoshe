<!-- 继承base.html模板，复用网站的基本布局结构 -->
{% extends 'base.html' %}

{% load static %}
{% load like_extras %}

{% block title %}拼好摄 - 发现精彩{% endblock %}

{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block og_title %}拼好摄 - 发现精彩{% endblock %}
{% block og_description %}在拼好摄发现更多精彩的摄影作品，与摄影爱好者分享和交流。{% endblock %}
{% block og_image %}{{ request.build_absolute_uri }}{% static 'images/logo.png' %}{% endblock %}

{% block twitter_url %}{{ request.build_absolute_uri }}{% endblock %}
{% block twitter_title %}拼好摄 - 发现精彩{% endblock %}
{% block twitter_description %}在拼好摄发现更多精彩的摄影作品，与摄影爱好者分享和交流。{% endblock %}
{% block twitter_image %}{{ request.build_absolute_uri }}{% static 'images/logo.png' %}{% endblock %}

<!-- 覆盖content块，定义页面主要内容 -->
{% block content %}
<!-- 创建瀑布流容器 -->
<div class="masonry-grid" id="masonry-grid">
    {% include 'photos/gallery_items.html' %}
</div>

<!-- 加载更多按钮和加载指示器 -->
<div id="load-more-container" class="text-center my-4" style="display: none;">
    <button id="load-more-btn" class="btn btn-primary">加载更多</button>
    <div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none;">
        <span class="visually-hidden">加载中...</span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let page = 1;
        let isLoading = false;
        let hasNext = true;
        const masonryGrid = document.getElementById('masonry-grid');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // 初始化加载更多按钮显示状态
        function initLoadMore() {
            if (hasNext) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }
        
        // 加载更多相册
        function loadMoreAlbums() {
            if (isLoading || !hasNext) return;
            
            isLoading = true;
            loadMoreBtn.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            
            fetch(`{% url 'photos:gallery' %}?page=${page + 1}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    // 将新内容添加到瀑布流容器中
                    masonryGrid.insertAdjacentHTML('beforeend', data.html);
                    
                    page = data.next_page ? data.next_page - 1 : page;
                    hasNext = data.has_next;
                }
            })
            .catch(error => {
                console.error('加载更多相册时出错:', error);
            })
            .finally(() => {
                isLoading = false;
                loadMoreBtn.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                initLoadMore();
            });
        }
        
        // 滚动事件处理
        function handleScroll() {
            // 检查是否滚动到页面底部附近（100px以内）
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadMoreAlbums();
            }
        }
        
        // 绑定事件
        loadMoreBtn.addEventListener('click', loadMoreAlbums);
        window.addEventListener('scroll', handleScroll);
        
        // 初始化
        initLoadMore();
    });
</script>
{% endblock %}